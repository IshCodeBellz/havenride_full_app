exports.id=2149,exports.ids=[2149],exports.modules={1138:(a,b,c)=>{"use strict";let d=c(73496),{Writable:e}=c(27910),{Agent:f,globalAgent:g}=c(36348),h=c(13543),i=c(86713),j=c(40037),k=c(68150),{ERR_INVALID_ARG_TYPE:l,ERR_INVALID_PROTOCOL:m,ERR_HTTP_HEADERS_SENT:n,ERR_INVALID_HTTP_TOKEN:o,ERR_HTTP_INVALID_HEADER_VALUE:p,ERR_INVALID_CHAR:q}=c(93196),{HTTP2_HEADER_STATUS:r,HTTP2_HEADER_METHOD:s,HTTP2_HEADER_PATH:t,HTTP2_METHOD_CONNECT:u}=d.constants,v=Symbol("headers"),w=Symbol("origin"),x=Symbol("session"),y=Symbol("options"),z=Symbol("flushedHeaders"),A=Symbol("jobs"),B=/^[\^`\-\w!#$%&*+.|~]+$/,C=/[^\t\u0020-\u007E\u0080-\u00FF]/;class D extends e{constructor(a,b,c){super({autoDestroy:!1});let d="string"==typeof a||a instanceof URL;if(d&&(a=i(a instanceof URL?a:new URL(a))),"function"==typeof b||void 0===b?(c=b,b=d?a:{...a}):b={...a,...b},b.h2session)this[x]=b.h2session;else if(!1===b.agent)this.agent=new f({maxFreeSessions:0});else if(void 0===b.agent||null===b.agent)"function"==typeof b.createConnection?(this.agent=new f({maxFreeSessions:0}),this.agent.createConnection=b.createConnection):this.agent=g;else if("function"==typeof b.agent.request)this.agent=b.agent;else throw new l("options.agent",["Agent-like Object","undefined","false"],b.agent);if(b.protocol&&"https:"!==b.protocol)throw new m(b.protocol,"https:");let e=b.port||b.defaultPort||this.agent&&this.agent.defaultPort||443,h=b.hostname||b.host||"localhost";delete b.hostname,delete b.host,delete b.port;let{timeout:j}=b;if(b.timeout=void 0,this[v]=Object.create(null),this[A]=[],this.socket=null,this.connection=null,this.method=b.method||"GET",this.path=b.path,this.res=null,this.aborted=!1,this.reusedSocket=!1,b.headers)for(let[a,c]of Object.entries(b.headers))this.setHeader(a,c);!b.auth||"authorization"in this[v]||(this[v].authorization="Basic "+Buffer.from(b.auth).toString("base64")),b.session=b.tlsSession,b.path=b.socketPath,this[y]=b,443===e?(this[w]=`https://${h}`,":authority"in this[v]||(this[v][":authority"]=h)):(this[w]=`https://${h}:${e}`,":authority"in this[v]||(this[v][":authority"]=`${h}:${e}`)),j&&this.setTimeout(j),c&&this.once("response",c),this[z]=!1}get method(){return this[v][s]}set method(a){a&&(this[v][s]=a.toUpperCase())}get path(){return this[v][t]}set path(a){a&&(this[v][t]=a)}get _mustNotHaveABody(){return"GET"===this.method||"HEAD"===this.method||"DELETE"===this.method}_write(a,b,c){if(this._mustNotHaveABody)return void c(Error("The GET, HEAD and DELETE methods must NOT have a body"));this.flushHeaders();let d=()=>this._request.write(a,b,c);this._request?d():this[A].push(d)}_final(a){if(this.destroyed)return;this.flushHeaders();let b=()=>{if(this._mustNotHaveABody)return void a();this._request.end(a)};this._request?b():this[A].push(b)}abort(){this.res&&this.res.complete||(this.aborted||process.nextTick(()=>this.emit("abort")),this.aborted=!0,this.destroy())}_destroy(a,b){this.res&&this.res._dump(),this._request&&this._request.destroy(),b(a)}async flushHeaders(){if(this[z]||this.destroyed)return;this[z]=!0;let a=this.method===u,b=b=>{if(this._request=b,this.destroyed)return void b.destroy();a||j(b,this,["timeout","continue","close","error"]);let c=a=>(...b)=>{this.writable||this.destroyed?this.once("finish",()=>{a(...b)}):a(...b)};b.once("response",c((c,d,e)=>{let f=new h(this.socket,b.readableHighWaterMark);this.res=f,f.req=this,f.statusCode=c[r],f.headers=c,f.rawHeaders=e,f.once("end",()=>{this.aborted?(f.aborted=!0,f.emit("aborted")):(f.complete=!0,f.socket=null,f.connection=null)}),a?(f.upgrade=!0,this.emit("connect",f,b,Buffer.alloc(0))?this.emit("close"):b.destroy()):(b.on("data",a=>{f._dumped||f.push(a)||b.pause()}),b.once("end",()=>{f.push(null)}),this.emit("response",f)||f._dump())})),b.once("headers",c(a=>this.emit("information",{statusCode:a[r]}))),b.once("trailers",c((a,b,c)=>{let{res:d}=this;d.trailers=a,d.rawTrailers=c}));let{socket:d}=b.session;for(let a of(this.socket=d,this.connection=d,this[A]))a();this.emit("socket",this.socket)};if(this[x])try{b(this[x].request(this[v]))}catch(a){this.emit("error",a)}else{this.reusedSocket=!0;try{b(await this.agent.request(this[w],this[y],this[v]))}catch(a){this.emit("error",a)}}}getHeader(a){if("string"!=typeof a)throw new l("name","string",a);return this[v][a.toLowerCase()]}get headersSent(){return this[z]}removeHeader(a){if("string"!=typeof a)throw new l("name","string",a);if(this.headersSent)throw new n("remove");delete this[v][a.toLowerCase()]}setHeader(a,b){if(this.headersSent)throw new n("set");if("string"!=typeof a||!B.test(a)&&!k(a))throw new o("Header name",a);if(void 0===b)throw new p(b,a);if(C.test(b))throw new q("header content",a);this[v][a.toLowerCase()]=b}setNoDelay(){}setSocketKeepAlive(){}setTimeout(a,b){let c=()=>this._request.setTimeout(a,b);return this._request?c():this[A].push(c),this}get maxHeadersCount(){if(!this.destroyed&&this._request)return this._request.session.localSettings.maxHeaderListSize}set maxHeadersCount(a){}}a.exports=D},3162:function(a,b,c){"use strict";var d=this&&this.__createBinding||(Object.create?function(a,b,c,d){void 0===d&&(d=c),Object.defineProperty(a,d,{enumerable:!0,get:function(){return b[c]}})}:function(a,b,c,d){void 0===d&&(d=c),a[d]=b[c]}),e=this&&this.__exportStar||function(a,b){for(var c in a)"default"===c||Object.prototype.hasOwnProperty.call(b,c)||d(b,a,c)};Object.defineProperty(b,"__esModule",{value:!0});let f=c(79551),g=c(89124),h={options:{method:"GET",retry:{limit:2,methods:["GET","PUT","HEAD","DELETE","OPTIONS","TRACE"],statusCodes:[408,413,429,500,502,503,504,521,522,524],errorCodes:["ETIMEDOUT","ECONNRESET","EADDRINUSE","ECONNREFUSED","EPIPE","ENOTFOUND","ENETUNREACH","EAI_AGAIN"],maxRetryAfter:void 0,calculateDelay:({computedValue:a})=>a},timeout:{},headers:{"user-agent":"got (https://github.com/sindresorhus/got)"},hooks:{init:[],beforeRequest:[],beforeRedirect:[],beforeRetry:[],beforeError:[],afterResponse:[]},cache:void 0,dnsCache:void 0,decompress:!0,throwHttpErrors:!0,followRedirect:!0,isStream:!1,responseType:"text",resolveBodyOnly:!1,maxRedirects:10,prefixUrl:"",methodRewriting:!0,ignoreInvalidCookies:!1,context:{},http2:!1,allowGetBody:!1,https:void 0,pagination:{transform:a=>"json"===a.request.options.responseType?a.body:JSON.parse(a.body),paginate:a=>{let b;if(!Reflect.has(a.headers,"link"))return!1;for(let c of a.headers.link.split(",")){let a=c.split(";");if(a[1].includes("next")){b=(b=a[0].trimStart().trim()).slice(1,-1);break}}return!!b&&{url:new f.URL(b)}},filter:()=>!0,shouldContinue:()=>!0,countLimit:1/0,backoff:0,requestLimit:1e4,stackAllItems:!0},parseJson:a=>JSON.parse(a),stringifyJson:a=>JSON.stringify(a),cacheOptions:{}},handlers:[g.defaultHandler],mutableDefaults:!1},i=g.default(h);b.default=i,a.exports=i,a.exports.default=i,a.exports.__esModule=!0,e(c(89124),b),e(c(70187),b)},4138:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(35510);b.default=a=>{let b={protocol:a.protocol,hostname:d.default.string(a.hostname)&&a.hostname.startsWith("[")?a.hostname.slice(1,-1):a.hostname,host:a.host,hash:a.hash,search:a.search,pathname:a.pathname,href:a.href,path:`${a.pathname||""}${a.search||""}`};return d.default.string(a.port)&&a.port.length>0&&(b.port=Number(a.port)),(a.username||a.password)&&(b.auth=`${a.username||""}:${a.password||""}`),b}},4847:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0})},7363:(a,b,c)=>{"use strict";c(77740);let{Duplex:d}=c(27910);function e(a){a.emit("close")}function f(){!this.destroyed&&this._writableState.finished&&this.destroy()}function g(a){this.removeListener("error",g),this.destroy(),0===this.listenerCount("error")&&this.emit("error",a)}a.exports=function(a,b){let c=!0,h=new d({...b,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return a.on("message",function(b,c){let d=!c&&h._readableState.objectMode?b.toString():b;h.push(d)||a.pause()}),a.once("error",function(a){h.destroyed||(c=!1,h.destroy(a))}),a.once("close",function(){h.destroyed||h.push(null)}),h._destroy=function(b,d){if(a.readyState===a.CLOSED){d(b),process.nextTick(e,h);return}let f=!1;a.once("error",function(a){f=!0,d(a)}),a.once("close",function(){f||d(b),process.nextTick(e,h)}),c&&a.terminate()},h._final=function(b){if(a.readyState===a.CONNECTING)return void a.once("open",function(){h._final(b)});null!==a._socket&&(a._socket._writableState.finished?(b(),h._readableState.endEmitted&&h.destroy()):(a._socket.once("finish",function(){b()}),a.close()))},h._read=function(){a.isPaused&&a.resume()},h._write=function(b,c,d){if(a.readyState===a.CONNECTING)return void a.once("open",function(){h._write(b,c,d)});a.send(b,d)},h.on("end",f),h.on("error",g),h}},7857:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(90826);b.default=(a,b,c,e)=>{let{rawBody:f}=a;try{if("text"===b)return f.toString(e);if("json"===b)return 0===f.length?"":c(f.toString());if("buffer"===b)return f;throw new d.ParseError({message:`Unknown body type '${b}'`,name:"Error"},a)}catch(b){throw new d.ParseError(b,a)}}},10331:(a,b,c)=>{var d,e=c(82411),f=c(62967);try{d=c(29021)}catch(a){}var g=function(){},h="undefined"!=typeof process&&/^v?\.0/.test(process.version),i=function(a){return"function"==typeof a},j=function(a,b,c,j){j=e(j);var k=!1;a.on("close",function(){k=!0}),f(a,{readable:b,writable:c},function(a){if(a)return j(a);k=!0,j()});var l=!1;return function(b){if(!k&&!l){if(l=!0,h&&d&&(a instanceof(d.ReadStream||g)||a instanceof(d.WriteStream||g))&&i(a.close))return a.close(g);if(a.setHeader&&i(a.abort))return a.abort();if(i(a.destroy))return a.destroy();j(b||Error("stream was destroyed"))}}},k=function(a){a()},l=function(a,b){return a.pipe(b)};a.exports=function(){var a,b=Array.prototype.slice.call(arguments),c=i(b[b.length-1]||g)&&b.pop()||g;if(Array.isArray(b[0])&&(b=b[0]),b.length<2)throw Error("pump requires two streams per minimum");var d=b.map(function(e,f){var g=f<b.length-1;return j(e,g,f>0,function(b){a||(a=b),b&&d.forEach(k),g||(d.forEach(k),c(a))})});return b.reduce(l)}},11356:a=>{"use strict";let b=(a,b)=>b.some(b=>b instanceof RegExp?b.test(a):b===a);a.exports=(a,c)=>{if(c={defaultProtocol:"http:",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,sortQueryParameters:!0,...c},a=a.trim(),/^data:/i.test(a))return((a,{stripHash:b})=>{let c=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(a);if(!c)throw Error(`Invalid URL: ${a}`);let{type:d,data:e,hash:f}=c.groups,g=d.split(";");f=b?"":f;let h=!1;"base64"===g[g.length-1]&&(g.pop(),h=!0);let i=(g.shift()||"").toLowerCase(),j=[...g.map(a=>{let[b,c=""]=a.split("=").map(a=>a.trim());return"charset"===b&&"us-ascii"===(c=c.toLowerCase())?"":`${b}${c?`=${c}`:""}`}).filter(Boolean)];return h&&j.push("base64"),(0!==j.length||i&&"text/plain"!==i)&&j.unshift(i),`data:${j.join(";")},${h?e.trim():e}${f?`#${f}`:""}`})(a,c);if(/^view-source:/i.test(a))throw Error("`view-source:` is not supported as it is a non-standard protocol");let d=a.startsWith("//");!d&&/^\.*\//.test(a)||(a=a.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,c.defaultProtocol));let e=new URL(a);if(c.forceHttp&&c.forceHttps)throw Error("The `forceHttp` and `forceHttps` options cannot be used together");if(c.forceHttp&&"https:"===e.protocol&&(e.protocol="http:"),c.forceHttps&&"http:"===e.protocol&&(e.protocol="https:"),c.stripAuthentication&&(e.username="",e.password=""),c.stripHash?e.hash="":c.stripTextFragment&&(e.hash=e.hash.replace(/#?:~:text.*?$/i,"")),e.pathname&&(e.pathname=e.pathname.replace(/(?<!\b(?:[a-z][a-z\d+\-.]{1,50}:))\/{2,}/g,"/")),e.pathname)try{e.pathname=decodeURI(e.pathname)}catch(a){}if(!0===c.removeDirectoryIndex&&(c.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(c.removeDirectoryIndex)&&c.removeDirectoryIndex.length>0){let a=e.pathname.split("/");b(a[a.length-1],c.removeDirectoryIndex)&&(e.pathname=(a=a.slice(0,a.length-1)).slice(1).join("/")+"/")}if(e.hostname&&(e.hostname=e.hostname.replace(/\.$/,""),c.stripWWW&&/^www\.(?!www\.)(?:[a-z\-\d]{1,63})\.(?:[a-z.\-\d]{2,63})$/.test(e.hostname)&&(e.hostname=e.hostname.replace(/^www\./,""))),Array.isArray(c.removeQueryParameters))for(let a of[...e.searchParams.keys()])b(a,c.removeQueryParameters)&&e.searchParams.delete(a);!0===c.removeQueryParameters&&(e.search=""),c.sortQueryParameters&&e.searchParams.sort(),c.removeTrailingSlash&&(e.pathname=e.pathname.replace(/\/$/,""));let f=a;return a=e.toString(),c.removeSingleSlash||"/"!==e.pathname||f.endsWith("/")||""!==e.hash||(a=a.replace(/\/$/,"")),(c.removeTrailingSlash||"/"===e.pathname)&&""===e.hash&&c.removeSingleSlash&&(a=a.replace(/\/$/,"")),d&&!c.normalizeProtocol&&(a=a.replace(/^http:\/\//,"//")),c.stripProtocol&&(a=a.replace(/^(?:https?:)?\/\//,"")),a}},13543:(a,b,c)=>{"use strict";let{Readable:d}=c(27910);class e extends d{constructor(a,b){super({highWaterMark:b,autoDestroy:!1}),this.statusCode=null,this.statusMessage="",this.httpVersion="2.0",this.httpVersionMajor=2,this.httpVersionMinor=0,this.headers={},this.trailers={},this.req=null,this.aborted=!1,this.complete=!1,this.upgrade=null,this.rawHeaders=[],this.rawTrailers=[],this.socket=a,this.connection=a,this._dumped=!1}_destroy(a){this.req._request.destroy(a)}setTimeout(a,b){return this.req.setTimeout(a,b),this}_dump(){this._dumped||(this._dumped=!0,this.removeAllListeners("data"),this.resume())}_read(){this.req&&this.req._request.resume()}}a.exports=e},14050:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.default=function(a,b,c){let d={};for(let e of c)d[e]=(...a)=>{b.emit(e,...a)},a.on(e,d[e]);return()=>{for(let b of c)a.off(b,d[b])}}},14501:a=>{"use strict";let b=["aborted","complete","headers","httpVersion","httpVersionMinor","httpVersionMajor","method","rawHeaders","rawTrailers","setTimeout","socket","statusCode","statusMessage","trailers","url"];a.exports=(a,c)=>{if(c._readableState.autoDestroy)throw Error("The second stream must have the `autoDestroy` option set to `false`");let d=new Set(Object.keys(a).concat(b)),e={};for(let b of d)b in c||(e[b]={get(){let c=a[b];return"function"==typeof c?c.bind(a):c},set(c){a[b]=c},enumerable:!0,configurable:!1});return Object.defineProperties(c,e),a.once("aborted",()=>{c.destroy(),c.emit("aborted")}),a.once("close",()=>{a.complete&&c.readable?c.once("end",()=>{c.emit("close")}):c.emit("close")}),c}},16513:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.retryAfterStatusCodes=void 0,b.retryAfterStatusCodes=new Set([413,429,503]),b.default=({attemptCount:a,retryOptions:b,error:c,retryAfter:d})=>{if(a>b.limit)return 0;let e=b.methods.includes(c.options.method),f=b.errorCodes.includes(c.code),g=c.response&&b.statusCodes.includes(c.response.statusCode);if(!e||!f&&!g)return 0;if(c.response){if(d)return void 0===b.maxRetryAfter||d>b.maxRetryAfter?0:d;if(413===c.response.statusCode)return 0}return 2**(a-1)*1e3+100*Math.random()}},17605:(a,b,c)=>{"use strict";let{kForOnEventAttribute:d,kListener:e}=c(63674),f=Symbol("kCode"),g=Symbol("kData"),h=Symbol("kError"),i=Symbol("kMessage"),j=Symbol("kReason"),k=Symbol("kTarget"),l=Symbol("kType"),m=Symbol("kWasClean");class n{constructor(a){this[k]=null,this[l]=a}get target(){return this[k]}get type(){return this[l]}}Object.defineProperty(n.prototype,"target",{enumerable:!0}),Object.defineProperty(n.prototype,"type",{enumerable:!0});class o extends n{constructor(a,b={}){super(a),this[f]=void 0===b.code?0:b.code,this[j]=void 0===b.reason?"":b.reason,this[m]=void 0!==b.wasClean&&b.wasClean}get code(){return this[f]}get reason(){return this[j]}get wasClean(){return this[m]}}Object.defineProperty(o.prototype,"code",{enumerable:!0}),Object.defineProperty(o.prototype,"reason",{enumerable:!0}),Object.defineProperty(o.prototype,"wasClean",{enumerable:!0});class p extends n{constructor(a,b={}){super(a),this[h]=void 0===b.error?null:b.error,this[i]=void 0===b.message?"":b.message}get error(){return this[h]}get message(){return this[i]}}Object.defineProperty(p.prototype,"error",{enumerable:!0}),Object.defineProperty(p.prototype,"message",{enumerable:!0});class q extends n{constructor(a,b={}){super(a),this[g]=void 0===b.data?null:b.data}get data(){return this[g]}}function r(a,b,c){"object"==typeof a&&a.handleEvent?a.handleEvent.call(a,c):a.call(b,c)}Object.defineProperty(q.prototype,"data",{enumerable:!0}),a.exports={CloseEvent:o,ErrorEvent:p,Event:n,EventTarget:{addEventListener(a,b,c={}){let f;for(let f of this.listeners(a))if(!c[d]&&f[e]===b&&!f[d])return;if("message"===a)f=function(a,c){let d=new q("message",{data:c?a:a.toString()});d[k]=this,r(b,this,d)};else if("close"===a)f=function(a,c){let d=new o("close",{code:a,reason:c.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});d[k]=this,r(b,this,d)};else if("error"===a)f=function(a){let c=new p("error",{error:a,message:a.message});c[k]=this,r(b,this,c)};else{if("open"!==a)return;f=function(){let a=new n("open");a[k]=this,r(b,this,a)}}f[d]=!!c[d],f[e]=b,c.once?this.once(a,f):this.on(a,f)},removeEventListener(a,b){for(let c of this.listeners(a))if(c[e]===b&&!c[d]){this.removeListener(a,c);break}}},MessageEvent:q}},17632:a=>{"use strict";class b{constructor(a={}){if(!(a.maxSize&&a.maxSize>0))throw TypeError("`maxSize` must be a number greater than 0");this.maxSize=a.maxSize,this.onEviction=a.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_set(a,b){if(this.cache.set(a,b),this._size++,this._size>=this.maxSize){if(this._size=0,"function"==typeof this.onEviction)for(let[a,b]of this.oldCache.entries())this.onEviction(a,b);this.oldCache=this.cache,this.cache=new Map}}get(a){if(this.cache.has(a))return this.cache.get(a);if(this.oldCache.has(a)){let b=this.oldCache.get(a);return this.oldCache.delete(a),this._set(a,b),b}}set(a,b){return this.cache.has(a)?this.cache.set(a,b):this._set(a,b),this}has(a){return this.cache.has(a)||this.oldCache.has(a)}peek(a){return this.cache.has(a)?this.cache.get(a):this.oldCache.has(a)?this.oldCache.get(a):void 0}delete(a){let b=this.cache.delete(a);return b&&this._size--,this.oldCache.delete(a)||b}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}*keys(){for(let[a]of this)yield a}*values(){for(let[,a]of this)yield a}*[Symbol.iterator](){for(let a of this.cache)yield a;for(let a of this.oldCache){let[b]=a;this.cache.has(b)||(yield a)}}get size(){let a=0;for(let b of this.oldCache.keys())!this.cache.has(b)&&a++;return Math.min(this._size+a,this.maxSize)}}a.exports=b},20879:(a,b,c)=>{"use strict";let d,e=c(74075),f=c(78086),g=c(61075),{kStatusCode:h}=c(63674),i=Buffer[Symbol.species],j=Buffer.from([0,0,255,255]),k=Symbol("permessage-deflate"),l=Symbol("total-length"),m=Symbol("callback"),n=Symbol("buffers"),o=Symbol("error");class p{constructor(a,b,c){this._maxPayload=0|c,this._options=a||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!b,this._deflate=null,this._inflate=null,this.params=null,d||(d=new g(void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10))}static get extensionName(){return"permessage-deflate"}offer(){let a={};return this._options.serverNoContextTakeover&&(a.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(a.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(a.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?a.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(a.client_max_window_bits=!0),a}accept(a){return a=this.normalizeParams(a),this.params=this._isServer?this.acceptAsServer(a):this.acceptAsClient(a),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let a=this._deflate[m];this._deflate.close(),this._deflate=null,a&&a(Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(a){let b=this._options,c=a.find(a=>(!1!==b.serverNoContextTakeover||!a.server_no_context_takeover)&&(!a.server_max_window_bits||!1!==b.serverMaxWindowBits&&("number"!=typeof b.serverMaxWindowBits||!(b.serverMaxWindowBits>a.server_max_window_bits)))&&("number"!=typeof b.clientMaxWindowBits||!!a.client_max_window_bits));if(!c)throw Error("None of the extension offers can be accepted");return b.serverNoContextTakeover&&(c.server_no_context_takeover=!0),b.clientNoContextTakeover&&(c.client_no_context_takeover=!0),"number"==typeof b.serverMaxWindowBits&&(c.server_max_window_bits=b.serverMaxWindowBits),"number"==typeof b.clientMaxWindowBits?c.client_max_window_bits=b.clientMaxWindowBits:(!0===c.client_max_window_bits||!1===b.clientMaxWindowBits)&&delete c.client_max_window_bits,c}acceptAsClient(a){let b=a[0];if(!1===this._options.clientNoContextTakeover&&b.client_no_context_takeover)throw Error('Unexpected parameter "client_no_context_takeover"');if(b.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&b.client_max_window_bits>this._options.clientMaxWindowBits)throw Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(b.client_max_window_bits=this._options.clientMaxWindowBits);return b}normalizeParams(a){return a.forEach(a=>{Object.keys(a).forEach(b=>{let c=a[b];if(c.length>1)throw Error(`Parameter "${b}" must have only a single value`);if(c=c[0],"client_max_window_bits"===b){if(!0!==c){let a=+c;if(!Number.isInteger(a)||a<8||a>15)throw TypeError(`Invalid value for parameter "${b}": ${c}`);c=a}else if(!this._isServer)throw TypeError(`Invalid value for parameter "${b}": ${c}`)}else if("server_max_window_bits"===b){let a=+c;if(!Number.isInteger(a)||a<8||a>15)throw TypeError(`Invalid value for parameter "${b}": ${c}`);c=a}else if("client_no_context_takeover"===b||"server_no_context_takeover"===b){if(!0!==c)throw TypeError(`Invalid value for parameter "${b}": ${c}`)}else throw Error(`Unknown parameter "${b}"`);a[b]=c})}),a}decompress(a,b,c){d.add(d=>{this._decompress(a,b,(a,b)=>{d(),c(a,b)})})}compress(a,b,c){d.add(d=>{this._compress(a,b,(a,b)=>{d(),c(a,b)})})}_decompress(a,b,c){let d=this._isServer?"client":"server";if(!this._inflate){let a=`${d}_max_window_bits`,b="number"!=typeof this.params[a]?e.Z_DEFAULT_WINDOWBITS:this.params[a];this._inflate=e.createInflateRaw({...this._options.zlibInflateOptions,windowBits:b}),this._inflate[k]=this,this._inflate[l]=0,this._inflate[n]=[],this._inflate.on("error",s),this._inflate.on("data",r)}this._inflate[m]=c,this._inflate.write(a),b&&this._inflate.write(j),this._inflate.flush(()=>{let a=this._inflate[o];if(a){this._inflate.close(),this._inflate=null,c(a);return}let e=f.concat(this._inflate[n],this._inflate[l]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[l]=0,this._inflate[n]=[],b&&this.params[`${d}_no_context_takeover`]&&this._inflate.reset()),c(null,e)})}_compress(a,b,c){let d=this._isServer?"server":"client";if(!this._deflate){let a=`${d}_max_window_bits`,b="number"!=typeof this.params[a]?e.Z_DEFAULT_WINDOWBITS:this.params[a];this._deflate=e.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:b}),this._deflate[l]=0,this._deflate[n]=[],this._deflate.on("data",q)}this._deflate[m]=c,this._deflate.write(a),this._deflate.flush(e.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let a=f.concat(this._deflate[n],this._deflate[l]);b&&(a=new i(a.buffer,a.byteOffset,a.length-4)),this._deflate[m]=null,this._deflate[l]=0,this._deflate[n]=[],b&&this.params[`${d}_no_context_takeover`]&&this._deflate.reset(),c(null,a)})}}function q(a){this[n].push(a),this[l]+=a.length}function r(a){if(this[l]+=a.length,this[k]._maxPayload<1||this[l]<=this[k]._maxPayload)return void this[n].push(a);this[o]=RangeError("Max payload size exceeded"),this[o].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[o][h]=1009,this.removeListener("data",r),this.reset()}function s(a){if(this[k]._inflate=null,this[o])return void this[m](this[o]);a[h]=1007,this[m](a)}a.exports=p},22295:(a,b,c)=>{"use strict";let{PassThrough:d}=c(27910);a.exports=a=>{let{array:b}=a={...a},{encoding:c}=a,e="buffer"===c,f=!1;b?f=!(c||e):c=c||"utf8",e&&(c=null);let g=new d({objectMode:f});c&&g.setEncoding(c);let h=0,i=[];return g.on("data",a=>{i.push(a),f?h=i.length:h+=a.length}),g.getBufferedValue=()=>b?i:e?Buffer.concat(i,h):i.join(""),g.getBufferedLength=()=>h,g}},26802:(a,b,c)=>{"use strict";let{Writable:d}=c(27910),e=c(20879),{BINARY_TYPES:f,EMPTY_BUFFER:g,kStatusCode:h,kWebSocket:i}=c(63674),{concat:j,toArrayBuffer:k,unmask:l}=c(78086),{isValidStatusCode:m,isValidUTF8:n}=c(86200),o=Buffer[Symbol.species];class p extends d{constructor(a={}){super(),this._allowSynchronousEvents=void 0===a.allowSynchronousEvents||a.allowSynchronousEvents,this._binaryType=a.binaryType||f[0],this._extensions=a.extensions||{},this._isServer=!!a.isServer,this._maxPayload=0|a.maxPayload,this._skipUTF8Validation=!!a.skipUTF8Validation,this[i]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(a,b,c){if(8===this._opcode&&0==this._state)return c();this._bufferedBytes+=a.length,this._buffers.push(a),this.startLoop(c)}consume(a){if(this._bufferedBytes-=a,a===this._buffers[0].length)return this._buffers.shift();if(a<this._buffers[0].length){let b=this._buffers[0];return this._buffers[0]=new o(b.buffer,b.byteOffset+a,b.length-a),new o(b.buffer,b.byteOffset,a)}let b=Buffer.allocUnsafe(a);do{let c=this._buffers[0],d=b.length-a;a>=c.length?b.set(this._buffers.shift(),d):(b.set(new Uint8Array(c.buffer,c.byteOffset,a),d),this._buffers[0]=new o(c.buffer,c.byteOffset+a,c.length-a)),a-=c.length}while(a>0);return b}startLoop(a){this._loop=!0;do switch(this._state){case 0:this.getInfo(a);break;case 1:this.getPayloadLength16(a);break;case 2:this.getPayloadLength64(a);break;case 3:this.getMask();break;case 4:this.getData(a);break;case 5:case 6:this._loop=!1;return}while(this._loop);this._errored||a()}getInfo(a){if(this._bufferedBytes<2){this._loop=!1;return}let b=this.consume(2);if((48&b[0])!=0)return void a(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"));let c=(64&b[0])==64;if(c&&!this._extensions[e.extensionName])return void a(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));if(this._fin=(128&b[0])==128,this._opcode=15&b[0],this._payloadLength=127&b[1],0===this._opcode){if(c)return void a(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));if(!this._fragmented)return void a(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"));this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return void a(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));this._compressed=c}else{if(!(this._opcode>7)||!(this._opcode<11))return void a(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));if(!this._fin)return void a(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"));if(c)return void a(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength)return void a(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=(128&b[1])==128,this._isServer){if(!this._masked)return void a(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}else if(this._masked)return void a(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"));126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(a)}getPayloadLength16(a){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(a)}getPayloadLength64(a){if(this._bufferedBytes<8){this._loop=!1;return}let b=this.consume(8),c=b.readUInt32BE(0);if(c>2097151)return void a(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"));this._payloadLength=0x100000000*c+b.readUInt32BE(4),this.haveLength(a)}haveLength(a){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return void a(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._masked?this._state=3:this._state=4}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=4}getData(a){let b=g;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}b=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!=0&&l(b,this._mask)}if(this._opcode>7)return void this.controlMessage(b,a);if(this._compressed){this._state=5,this.decompress(b,a);return}b.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(b)),this.dataMessage(a)}decompress(a,b){this._extensions[e.extensionName].decompress(a,this._fin,(a,c)=>{if(a)return b(a);if(c.length){if(this._messageLength+=c.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return void b(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(c)}this.dataMessage(b),0===this._state&&this.startLoop(b)})}dataMessage(a){if(!this._fin){this._state=0;return}let b=this._messageLength,c=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let d;d="nodebuffer"===this._binaryType?j(c,b):"arraybuffer"===this._binaryType?k(j(c,b)):"blob"===this._binaryType?new Blob(c):c,this._allowSynchronousEvents?(this.emit("message",d,!0),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",d,!0),this._state=0,this.startLoop(a)}))}else{let d=j(c,b);if(!this._skipUTF8Validation&&!n(d))return void a(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));5===this._state||this._allowSynchronousEvents?(this.emit("message",d,!1),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",d,!1),this._state=0,this.startLoop(a)}))}}controlMessage(a,b){if(8===this._opcode){if(0===a.length)this._loop=!1,this.emit("conclude",1005,g),this.end();else{let c=a.readUInt16BE(0);if(!m(c))return void b(this.createError(RangeError,`invalid status code ${c}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE"));let d=new o(a.buffer,a.byteOffset+2,a.length-2);if(!this._skipUTF8Validation&&!n(d))return void b(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));this._loop=!1,this.emit("conclude",c,d),this.end()}this._state=0;return}this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",a),this._state=0):(this._state=6,setImmediate(()=>{this.emit(9===this._opcode?"ping":"pong",a),this._state=0,this.startLoop(b)}))}createError(a,b,c,d,e){this._loop=!1,this._errored=!0;let f=new a(c?`Invalid WebSocket frame: ${b}`:b);return Error.captureStackTrace(f,this.createError),f.code=e,f[h]=d,f}}a.exports=p},32078:a=>{"use strict";let b=new Set([200,203,204,206,300,301,308,404,405,410,414,501]),c=new Set([200,203,204,300,301,302,303,307,308,404,405,410,414,501]),d=new Set([500,502,503,504]),e={date:!0,connection:!0,"keep-alive":!0,"proxy-authenticate":!0,"proxy-authorization":!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0},f={"content-length":!0,"content-encoding":!0,"transfer-encoding":!0,"content-range":!0};function g(a){let b=parseInt(a,10);return isFinite(b)?b:0}function h(a){let b={};if(!a)return b;for(let c of a.trim().split(/,/)){let[a,d]=c.split(/=/,2);b[a.trim()]=void 0===d||d.trim().replace(/^"|"$/g,"")}return b}a.exports=class{constructor(a,b,{shared:c,cacheHeuristic:d,immutableMinTimeToLive:e,ignoreCargoCult:f,_fromObject:g}={}){if(g)return void this._fromObject(g);if(!b||!b.headers)throw Error("Response headers missing");this._assertRequestHasHeaders(a),this._responseTime=this.now(),this._isShared=!1!==c,this._ignoreCargoCult=!!f,this._cacheHeuristic=void 0!==d?d:.1,this._immutableMinTtl=void 0!==e?e:864e5,this._status="status"in b?b.status:200,this._resHeaders=b.headers,this._rescc=h(b.headers["cache-control"]),this._method="method"in a?a.method:"GET",this._url=a.url,this._host=a.headers.host,this._noAuthorization=!a.headers.authorization,this._reqHeaders=b.headers.vary?a.headers:null,this._reqcc=h(a.headers["cache-control"]),this._ignoreCargoCult&&"pre-check"in this._rescc&&"post-check"in this._rescc&&(delete this._rescc["pre-check"],delete this._rescc["post-check"],delete this._rescc["no-cache"],delete this._rescc["no-store"],delete this._rescc["must-revalidate"],this._resHeaders=Object.assign({},this._resHeaders,{"cache-control":function(a){let b=[];for(let c in a){let d=a[c];b.push(!0===d?c:c+"="+d)}if(b.length)return b.join(", ")}(this._rescc)}),delete this._resHeaders.expires,delete this._resHeaders.pragma),null==b.headers["cache-control"]&&/no-cache/.test(b.headers.pragma)&&(this._rescc["no-cache"]=!0)}now(){return Date.now()}storable(){return!!(!this._reqcc["no-store"]&&("GET"===this._method||"HEAD"===this._method||"POST"===this._method&&this._hasExplicitExpiration())&&c.has(this._status)&&!this._rescc["no-store"]&&(!this._isShared||!this._rescc.private)&&(!this._isShared||this._noAuthorization||this._allowsStoringAuthenticated())&&(this._resHeaders.expires||this._rescc["max-age"]||this._isShared&&this._rescc["s-maxage"]||this._rescc.public||b.has(this._status)))}_hasExplicitExpiration(){return!!(this._isShared&&this._rescc["s-maxage"]||this._rescc["max-age"]||this._resHeaders.expires)}_assertRequestHasHeaders(a){if(!a||!a.headers)throw Error("Request headers missing")}satisfiesWithoutRevalidation(a){return!this.evaluateRequest(a).revalidation}_evaluateRequestHitResult(a){return{response:{headers:this.responseHeaders()},revalidation:a}}_evaluateRequestRevalidation(a,b){return{synchronous:b,headers:this.revalidationHeaders(a)}}_evaluateRequestMissResult(a){return{response:void 0,revalidation:this._evaluateRequestRevalidation(a,!0)}}evaluateRequest(a){if(this._assertRequestHasHeaders(a),this._rescc["must-revalidate"]||!this._requestMatches(a,!1))return this._evaluateRequestMissResult(a);let b=h(a.headers["cache-control"]);return b["no-cache"]||/no-cache/.test(a.headers.pragma)||b["max-age"]&&this.age()>g(b["max-age"])||b["min-fresh"]&&this.maxAge()-this.age()<g(b["min-fresh"])?this._evaluateRequestMissResult(a):this.stale()?"max-stale"in b&&(!0===b["max-stale"]||b["max-stale"]>this.age()-this.maxAge())?this._evaluateRequestHitResult(void 0):this.useStaleWhileRevalidate()?this._evaluateRequestHitResult(this._evaluateRequestRevalidation(a,!1)):this._evaluateRequestMissResult(a):this._evaluateRequestHitResult(void 0)}_requestMatches(a,b){return!!((!this._url||this._url===a.url)&&this._host===a.headers.host&&(!a.method||this._method===a.method||b&&"HEAD"===a.method)&&this._varyMatches(a))}_allowsStoringAuthenticated(){return!!(this._rescc["must-revalidate"]||this._rescc.public||this._rescc["s-maxage"])}_varyMatches(a){if(!this._resHeaders.vary)return!0;if("*"===this._resHeaders.vary)return!1;for(let b of this._resHeaders.vary.trim().toLowerCase().split(/\s*,\s*/))if(a.headers[b]!==this._reqHeaders[b])return!1;return!0}_copyWithoutHopByHopHeaders(a){let b={};for(let c in a)e[c]||(b[c]=a[c]);if(a.connection)for(let c of a.connection.trim().split(/\s*,\s*/))delete b[c];if(b.warning){let a=b.warning.split(/,/).filter(a=>!/^\s*1[0-9][0-9]/.test(a));a.length?b.warning=a.join(",").trim():delete b.warning}return b}responseHeaders(){let a=this._copyWithoutHopByHopHeaders(this._resHeaders),b=this.age();return b>86400&&!this._hasExplicitExpiration()&&this.maxAge()>86400&&(a.warning=(a.warning?`${a.warning}, `:"")+'113 - "rfc7234 5.5.4"'),a.age=`${Math.round(b)}`,a.date=new Date(this.now()).toUTCString(),a}date(){let a=Date.parse(this._resHeaders.date);return isFinite(a)?a:this._responseTime}age(){return this._ageValue()+(this.now()-this._responseTime)/1e3}_ageValue(){return g(this._resHeaders.age)}maxAge(){if(!this.storable()||this._rescc["no-cache"]||this._isShared&&this._resHeaders["set-cookie"]&&!this._rescc.public&&!this._rescc.immutable||"*"===this._resHeaders.vary)return 0;if(this._isShared){if(this._rescc["proxy-revalidate"])return 0;if(this._rescc["s-maxage"])return g(this._rescc["s-maxage"])}if(this._rescc["max-age"])return g(this._rescc["max-age"]);let a=this._rescc.immutable?this._immutableMinTtl:0,b=this.date();if(this._resHeaders.expires){let c=Date.parse(this._resHeaders.expires);return Number.isNaN(c)||c<b?0:Math.max(a,(c-b)/1e3)}if(this._resHeaders["last-modified"]){let c=Date.parse(this._resHeaders["last-modified"]);if(isFinite(c)&&b>c)return Math.max(a,(b-c)/1e3*this._cacheHeuristic)}return a}timeToLive(){let a=this.maxAge()-this.age(),b=a+g(this._rescc["stale-if-error"]),c=a+g(this._rescc["stale-while-revalidate"]);return Math.round(1e3*Math.max(0,a,b,c))}stale(){return this.maxAge()<=this.age()}_useStaleIfError(){return this.maxAge()+g(this._rescc["stale-if-error"])>this.age()}useStaleWhileRevalidate(){let a=g(this._rescc["stale-while-revalidate"]);return a>0&&this.maxAge()+a>this.age()}static fromObject(a){return new this(void 0,void 0,{_fromObject:a})}_fromObject(a){if(this._responseTime)throw Error("Reinitialized");if(!a||1!==a.v)throw Error("Invalid serialization");this._responseTime=a.t,this._isShared=a.sh,this._cacheHeuristic=a.ch,this._immutableMinTtl=void 0!==a.imm?a.imm:864e5,this._ignoreCargoCult=!!a.icc,this._status=a.st,this._resHeaders=a.resh,this._rescc=a.rescc,this._method=a.m,this._url=a.u,this._host=a.h,this._noAuthorization=a.a,this._reqHeaders=a.reqh,this._reqcc=a.reqcc}toObject(){return{v:1,t:this._responseTime,sh:this._isShared,ch:this._cacheHeuristic,imm:this._immutableMinTtl,icc:this._ignoreCargoCult,st:this._status,resh:this._resHeaders,rescc:this._rescc,m:this._method,u:this._url,h:this._host,a:this._noAuthorization,reqh:this._reqHeaders,reqcc:this._reqcc}}revalidationHeaders(a){this._assertRequestHasHeaders(a);let b=this._copyWithoutHopByHopHeaders(a.headers);if(delete b["if-range"],!this._requestMatches(a,!0)||!this.storable())return delete b["if-none-match"],delete b["if-modified-since"],b;if(this._resHeaders.etag&&(b["if-none-match"]=b["if-none-match"]?`${b["if-none-match"]}, ${this._resHeaders.etag}`:this._resHeaders.etag),b["accept-ranges"]||b["if-match"]||b["if-unmodified-since"]||this._method&&"GET"!=this._method){if(delete b["if-modified-since"],b["if-none-match"]){let a=b["if-none-match"].split(/,/).filter(a=>!/^\s*W\//.test(a));a.length?b["if-none-match"]=a.join(",").trim():delete b["if-none-match"]}}else this._resHeaders["last-modified"]&&!b["if-modified-since"]&&(b["if-modified-since"]=this._resHeaders["last-modified"]);return b}revalidatedPolicy(a,b){if(this._assertRequestHasHeaders(a),this._useStaleIfError()&&(!b||d.has(b.status)))return{policy:this,modified:!1,matches:!0};if(!b||!b.headers)throw Error("Response headers missing");let c=!1;void 0!==b.status&&304!=b.status?c=!1:b.headers.etag&&!/^\s*W\//.test(b.headers.etag)?c=this._resHeaders.etag&&this._resHeaders.etag.replace(/^\s*W\//,"")===b.headers.etag:this._resHeaders.etag&&b.headers.etag?c=this._resHeaders.etag.replace(/^\s*W\//,"")===b.headers.etag.replace(/^\s*W\//,""):this._resHeaders["last-modified"]?c=this._resHeaders["last-modified"]===b.headers["last-modified"]:this._resHeaders.etag||this._resHeaders["last-modified"]||b.headers.etag||b.headers["last-modified"]||(c=!0);let e={shared:this._isShared,cacheHeuristic:this._cacheHeuristic,immutableMinTimeToLive:this._immutableMinTtl,ignoreCargoCult:this._ignoreCargoCult};if(!c)return{policy:new this.constructor(a,b,e),modified:304!=b.status,matches:!1};let g={};for(let a in this._resHeaders)g[a]=a in b.headers&&!f[a]?b.headers[a]:this._resHeaders[a];let h=Object.assign({},b,{status:this._status,method:this._method,headers:g});return{policy:new this.constructor(a,h,e),modified:!1,matches:!0}}}},35091:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(37531),e=c(28354),f=Number(process.versions.node.split(".")[0]),g=a=>{if(a.timings)return a.timings;let b={start:Date.now(),socket:void 0,lookup:void 0,connect:void 0,secureConnect:void 0,upload:void 0,response:void 0,end:void 0,error:void 0,abort:void 0,phases:{wait:void 0,dns:void 0,tcp:void 0,tls:void 0,request:void 0,firstByte:void 0,download:void 0,total:void 0}};a.timings=b;let c=a=>{let c=a.emit.bind(a);a.emit=(d,...e)=>("error"===d&&(b.error=Date.now(),b.phases.total=b.error-b.start,a.emit=c),c(d,...e))};c(a);let g=()=>{b.abort=Date.now(),(!b.response||f>=13)&&(b.phases.total=Date.now()-b.start)};a.prependOnceListener("abort",g);let h=a=>{if(b.socket=Date.now(),b.phases.wait=b.socket-b.start,e.types.isProxy(a))return;let c=()=>{b.lookup=Date.now(),b.phases.dns=b.lookup-b.socket};a.prependOnceListener("lookup",c),d.default(a,{connect:()=>{b.connect=Date.now(),void 0===b.lookup&&(a.removeListener("lookup",c),b.lookup=b.connect,b.phases.dns=b.lookup-b.socket),b.phases.tcp=b.connect-b.lookup},secureConnect:()=>{b.secureConnect=Date.now(),b.phases.tls=b.secureConnect-b.connect}})};a.socket?h(a.socket):a.prependOnceListener("socket",h);let i=()=>{var a;b.upload=Date.now(),b.phases.request=b.upload-(null!=(a=b.secureConnect)?a:b.connect)};return("boolean"==typeof a.writableFinished?a.writableFinished:a.finished&&0===a.outputSize&&(!a.socket||0===a.socket.writableLength))?i():a.prependOnceListener("finish",i),a.prependOnceListener("response",a=>{b.response=Date.now(),b.phases.firstByte=b.response-b.upload,a.timings=b,c(a),a.prependOnceListener("end",()=>{b.end=Date.now(),b.phases.download=b.end-b.response,b.phases.total=b.end-b.start}),a.prependOnceListener("aborted",g)}),b};b.default=g,a.exports=g,a.exports.default=g},35366:(a,b,c)=>{"use strict";let d=c(94735),e=c(81630),{Duplex:f}=c(27910),{createHash:g}=c(55511),h=c(58986),i=c(20879),j=c(43677),k=c(77740),{GUID:l,kWebSocket:m}=c(63674),n=/^[+/0-9A-Za-z]{22}==$/;class o extends d{constructor(a,b){if(super(),null==(a={allowSynchronousEvents:!0,autoPong:!0,maxPayload:0x6400000,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:k,...a}).port&&!a.server&&!a.noServer||null!=a.port&&(a.server||a.noServer)||a.server&&a.noServer)throw TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=a.port?(this._server=e.createServer((a,b)=>{let c=e.STATUS_CODES[426];b.writeHead(426,{"Content-Length":c.length,"Content-Type":"text/plain"}),b.end(c)}),this._server.listen(a.port,a.host,a.backlog,b)):a.server&&(this._server=a.server),this._server){let a=this.emit.bind(this,"connection");this._removeListeners=function(a,b){for(let c of Object.keys(b))a.on(c,b[c]);return function(){for(let c of Object.keys(b))a.removeListener(c,b[c])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(b,c,d)=>{this.handleUpgrade(b,c,d,a)}})}!0===a.perMessageDeflate&&(a.perMessageDeflate={}),a.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=a,this._state=0}address(){if(this.options.noServer)throw Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(a){if(2===this._state){a&&this.once("close",()=>{a(Error("The server is not running"))}),process.nextTick(p,this);return}if(a&&this.once("close",a),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(p,this);else{let a=this._server;this._removeListeners(),this._removeListeners=this._server=null,a.close(()=>{p(this)})}}shouldHandle(a){if(this.options.path){let b=a.url.indexOf("?");if((-1!==b?a.url.slice(0,b):a.url)!==this.options.path)return!1}return!0}handleUpgrade(a,b,c,d){b.on("error",q);let e=a.headers["sec-websocket-key"],f=a.headers.upgrade,g=+a.headers["sec-websocket-version"];if("GET"!==a.method)return void s(this,a,b,405,"Invalid HTTP method");if(void 0===f||"websocket"!==f.toLowerCase())return void s(this,a,b,400,"Invalid Upgrade header");if(void 0===e||!n.test(e))return void s(this,a,b,400,"Missing or invalid Sec-WebSocket-Key header");if(13!==g&&8!==g)return void s(this,a,b,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});if(!this.shouldHandle(a))return void r(b,400);let k=a.headers["sec-websocket-protocol"],l=new Set;if(void 0!==k)try{l=j.parse(k)}catch(c){s(this,a,b,400,"Invalid Sec-WebSocket-Protocol header");return}let m=a.headers["sec-websocket-extensions"],o={};if(this.options.perMessageDeflate&&void 0!==m){let c=new i(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let a=h.parse(m);a[i.extensionName]&&(c.accept(a[i.extensionName]),o[i.extensionName]=c)}catch(c){s(this,a,b,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let f={origin:a.headers[`${8===g?"sec-websocket-origin":"origin"}`],secure:!!(a.socket.authorized||a.socket.encrypted),req:a};if(2===this.options.verifyClient.length)return void this.options.verifyClient(f,(f,g,h,i)=>{if(!f)return r(b,g||401,h,i);this.completeUpgrade(o,e,l,a,b,c,d)});if(!this.options.verifyClient(f))return r(b,401)}this.completeUpgrade(o,e,l,a,b,c,d)}completeUpgrade(a,b,c,d,e,f,j){if(!e.readable||!e.writable)return e.destroy();if(e[m])throw Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return r(e,503);let k=g("sha1").update(b+l).digest("base64"),n=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${k}`],o=new this.options.WebSocket(null,void 0,this.options);if(c.size){let a=this.options.handleProtocols?this.options.handleProtocols(c,d):c.values().next().value;a&&(n.push(`Sec-WebSocket-Protocol: ${a}`),o._protocol=a)}if(a[i.extensionName]){let b=a[i.extensionName].params,c=h.format({[i.extensionName]:[b]});n.push(`Sec-WebSocket-Extensions: ${c}`),o._extensions=a}this.emit("headers",n,d),e.write(n.concat("\r\n").join("\r\n")),e.removeListener("error",q),o.setSocket(e,f,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(o),o.on("close",()=>{this.clients.delete(o),this._shouldEmitClose&&!this.clients.size&&process.nextTick(p,this)})),j(o,d)}}function p(a){a._state=2,a.emit("close")}function q(){this.destroy()}function r(a,b,c,d){c=c||e.STATUS_CODES[b],d={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(c),...d},a.once("finish",a.destroy),a.end(`HTTP/1.1 ${b} ${e.STATUS_CODES[b]}\r
`+Object.keys(d).map(a=>`${a}: ${d[a]}`).join("\r\n")+"\r\n\r\n"+c)}function s(a,b,c,d,e,f){if(a.listenerCount("wsClientError")){let d=Error(e);Error.captureStackTrace(d,s),a.emit("wsClientError",d,c,b)}else r(c,d,e,f)}a.exports=o},35510:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let c=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"],d=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Blob","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","FormData","URLSearchParams","HTMLElement",...c],e=["null","undefined","string","number","bigint","boolean","symbol"];function f(a){return b=>typeof b===a}let{toString:g}=Object.prototype,h=a=>{let b=g.call(a).slice(8,-1);return/HTML\w+Element/.test(b)&&j.domElement(a)?"HTMLElement":d.includes(b)?b:void 0},i=a=>b=>h(b)===a;function j(a){if(null===a)return"null";switch(typeof a){case"undefined":return"undefined";case"string":return"string";case"number":return"number";case"boolean":return"boolean";case"function":return"Function";case"bigint":return"bigint";case"symbol":return"symbol"}if(j.observable(a))return"Observable";if(j.array(a))return"Array";if(j.buffer(a))return"Buffer";let b=h(a);if(b)return b;if(a instanceof String||a instanceof Boolean||a instanceof Number)throw TypeError("Please don't use object wrappers for primitive types");return"Object"}j.undefined=f("undefined"),j.string=f("string");let k=f("number");j.number=a=>k(a)&&!j.nan(a),j.bigint=f("bigint"),j.function_=f("function"),j.null_=a=>null===a,j.class_=a=>j.function_(a)&&a.toString().startsWith("class "),j.boolean=a=>!0===a||!1===a,j.symbol=f("symbol"),j.numericString=a=>j.string(a)&&!j.emptyStringOrWhitespace(a)&&!Number.isNaN(Number(a)),j.array=(a,b)=>!!Array.isArray(a)&&(!j.function_(b)||a.every(b)),j.buffer=a=>{var b,c,d;return null!=(d=null==(c=null==(b=null==a?void 0:a.constructor)?void 0:b.isBuffer)?void 0:c.call(b,a))&&d},j.blob=a=>i("Blob")(a),j.nullOrUndefined=a=>j.null_(a)||j.undefined(a),j.object=a=>!j.null_(a)&&("object"==typeof a||j.function_(a)),j.iterable=a=>j.function_(null==a?void 0:a[Symbol.iterator]),j.asyncIterable=a=>j.function_(null==a?void 0:a[Symbol.asyncIterator]),j.generator=a=>j.iterable(a)&&j.function_(null==a?void 0:a.next)&&j.function_(null==a?void 0:a.throw),j.asyncGenerator=a=>j.asyncIterable(a)&&j.function_(a.next)&&j.function_(a.throw),j.nativePromise=a=>i("Promise")(a),j.promise=a=>j.nativePromise(a)||(a=>j.function_(null==a?void 0:a.then)&&j.function_(null==a?void 0:a.catch))(a),j.generatorFunction=i("GeneratorFunction"),j.asyncGeneratorFunction=a=>"AsyncGeneratorFunction"===h(a),j.asyncFunction=a=>"AsyncFunction"===h(a),j.boundFunction=a=>j.function_(a)&&!a.hasOwnProperty("prototype"),j.regExp=i("RegExp"),j.date=i("Date"),j.error=i("Error"),j.map=a=>i("Map")(a),j.set=a=>i("Set")(a),j.weakMap=a=>i("WeakMap")(a),j.weakSet=a=>i("WeakSet")(a),j.int8Array=i("Int8Array"),j.uint8Array=i("Uint8Array"),j.uint8ClampedArray=i("Uint8ClampedArray"),j.int16Array=i("Int16Array"),j.uint16Array=i("Uint16Array"),j.int32Array=i("Int32Array"),j.uint32Array=i("Uint32Array"),j.float32Array=i("Float32Array"),j.float64Array=i("Float64Array"),j.bigInt64Array=i("BigInt64Array"),j.bigUint64Array=i("BigUint64Array"),j.arrayBuffer=i("ArrayBuffer"),j.sharedArrayBuffer=i("SharedArrayBuffer"),j.dataView=i("DataView"),j.enumCase=(a,b)=>Object.values(b).includes(a),j.directInstanceOf=(a,b)=>Object.getPrototypeOf(a)===b.prototype,j.urlInstance=a=>i("URL")(a),j.urlString=a=>{if(!j.string(a))return!1;try{return new URL(a),!0}catch(a){return!1}},j.truthy=a=>!!a,j.falsy=a=>!a,j.nan=a=>Number.isNaN(a),j.primitive=a=>{var b;return j.null_(a)||(b=typeof a,e.includes(b))},j.integer=a=>Number.isInteger(a),j.safeInteger=a=>Number.isSafeInteger(a),j.plainObject=a=>{if("[object Object]"!==g.call(a))return!1;let b=Object.getPrototypeOf(a);return null===b||b===Object.getPrototypeOf({})},j.typedArray=a=>{var b;return b=h(a),c.includes(b)},j.arrayLike=a=>!j.nullOrUndefined(a)&&!j.function_(a)&&(a=>j.safeInteger(a)&&a>=0)(a.length),j.inRange=(a,b)=>{if(j.number(b))return a>=Math.min(0,b)&&a<=Math.max(b,0);if(j.array(b)&&2===b.length)return a>=Math.min(...b)&&a<=Math.max(...b);throw TypeError(`Invalid range: ${JSON.stringify(b)}`)};let l=["innerHTML","ownerDocument","style","attributes","nodeValue"];j.domElement=a=>j.object(a)&&1===a.nodeType&&j.string(a.nodeName)&&!j.plainObject(a)&&l.every(b=>b in a),j.observable=a=>{var b,c;return!!a&&(a===(null==(b=a[Symbol.observable])?void 0:b.call(a))||a===(null==(c=a["@@observable"])?void 0:c.call(a)))},j.nodeStream=a=>j.object(a)&&j.function_(a.pipe)&&!j.observable(a),j.infinite=a=>a===1/0||a===-1/0;let m=a=>b=>j.integer(b)&&Math.abs(b%2)===a;j.evenInteger=m(0),j.oddInteger=m(1),j.emptyArray=a=>j.array(a)&&0===a.length,j.nonEmptyArray=a=>j.array(a)&&a.length>0,j.emptyString=a=>j.string(a)&&0===a.length,j.emptyStringOrWhitespace=a=>j.emptyString(a)||(a=>j.string(a)&&!/\S/.test(a))(a),j.nonEmptyString=a=>j.string(a)&&a.length>0,j.nonEmptyStringAndNotWhitespace=a=>j.string(a)&&!j.emptyStringOrWhitespace(a),j.emptyObject=a=>j.object(a)&&!j.map(a)&&!j.set(a)&&0===Object.keys(a).length,j.nonEmptyObject=a=>j.object(a)&&!j.map(a)&&!j.set(a)&&Object.keys(a).length>0,j.emptySet=a=>j.set(a)&&0===a.size,j.nonEmptySet=a=>j.set(a)&&a.size>0,j.emptyMap=a=>j.map(a)&&0===a.size,j.nonEmptyMap=a=>j.map(a)&&a.size>0,j.propertyKey=a=>j.any([j.string,j.number,j.symbol],a),j.formData=a=>i("FormData")(a),j.urlSearchParams=a=>i("URLSearchParams")(a);let n=(a,b,c)=>{if(!j.function_(b))throw TypeError(`Invalid predicate: ${JSON.stringify(b)}`);if(0===c.length)throw TypeError("Invalid number of values");return a.call(c,b)};j.any=(a,...b)=>(j.array(a)?a:[a]).some(a=>n(Array.prototype.some,a,b)),j.all=(a,...b)=>n(Array.prototype.every,a,b);let o=(a,b,c,d={})=>{if(!a){let{multipleValues:a}=d,e=a?`received values of types ${[...new Set(c.map(a=>`\`${j(a)}\``))].join(", ")}`:`received value of type \`${j(c)}\``;throw TypeError(`Expected value which is \`${b}\`, ${e}.`)}};b.assert={undefined:a=>o(j.undefined(a),"undefined",a),string:a=>o(j.string(a),"string",a),number:a=>o(j.number(a),"number",a),bigint:a=>o(j.bigint(a),"bigint",a),function_:a=>o(j.function_(a),"Function",a),null_:a=>o(j.null_(a),"null",a),class_:a=>o(j.class_(a),"Class",a),boolean:a=>o(j.boolean(a),"boolean",a),symbol:a=>o(j.symbol(a),"symbol",a),numericString:a=>o(j.numericString(a),"string with a number",a),array:(a,b)=>{o(j.array(a),"Array",a),b&&a.forEach(b)},buffer:a=>o(j.buffer(a),"Buffer",a),blob:a=>o(j.blob(a),"Blob",a),nullOrUndefined:a=>o(j.nullOrUndefined(a),"null or undefined",a),object:a=>o(j.object(a),"Object",a),iterable:a=>o(j.iterable(a),"Iterable",a),asyncIterable:a=>o(j.asyncIterable(a),"AsyncIterable",a),generator:a=>o(j.generator(a),"Generator",a),asyncGenerator:a=>o(j.asyncGenerator(a),"AsyncGenerator",a),nativePromise:a=>o(j.nativePromise(a),"native Promise",a),promise:a=>o(j.promise(a),"Promise",a),generatorFunction:a=>o(j.generatorFunction(a),"GeneratorFunction",a),asyncGeneratorFunction:a=>o(j.asyncGeneratorFunction(a),"AsyncGeneratorFunction",a),asyncFunction:a=>o(j.asyncFunction(a),"AsyncFunction",a),boundFunction:a=>o(j.boundFunction(a),"Function",a),regExp:a=>o(j.regExp(a),"RegExp",a),date:a=>o(j.date(a),"Date",a),error:a=>o(j.error(a),"Error",a),map:a=>o(j.map(a),"Map",a),set:a=>o(j.set(a),"Set",a),weakMap:a=>o(j.weakMap(a),"WeakMap",a),weakSet:a=>o(j.weakSet(a),"WeakSet",a),int8Array:a=>o(j.int8Array(a),"Int8Array",a),uint8Array:a=>o(j.uint8Array(a),"Uint8Array",a),uint8ClampedArray:a=>o(j.uint8ClampedArray(a),"Uint8ClampedArray",a),int16Array:a=>o(j.int16Array(a),"Int16Array",a),uint16Array:a=>o(j.uint16Array(a),"Uint16Array",a),int32Array:a=>o(j.int32Array(a),"Int32Array",a),uint32Array:a=>o(j.uint32Array(a),"Uint32Array",a),float32Array:a=>o(j.float32Array(a),"Float32Array",a),float64Array:a=>o(j.float64Array(a),"Float64Array",a),bigInt64Array:a=>o(j.bigInt64Array(a),"BigInt64Array",a),bigUint64Array:a=>o(j.bigUint64Array(a),"BigUint64Array",a),arrayBuffer:a=>o(j.arrayBuffer(a),"ArrayBuffer",a),sharedArrayBuffer:a=>o(j.sharedArrayBuffer(a),"SharedArrayBuffer",a),dataView:a=>o(j.dataView(a),"DataView",a),enumCase:(a,b)=>o(j.enumCase(a,b),"EnumCase",a),urlInstance:a=>o(j.urlInstance(a),"URL",a),urlString:a=>o(j.urlString(a),"string with a URL",a),truthy:a=>o(j.truthy(a),"truthy",a),falsy:a=>o(j.falsy(a),"falsy",a),nan:a=>o(j.nan(a),"NaN",a),primitive:a=>o(j.primitive(a),"primitive",a),integer:a=>o(j.integer(a),"integer",a),safeInteger:a=>o(j.safeInteger(a),"integer",a),plainObject:a=>o(j.plainObject(a),"plain object",a),typedArray:a=>o(j.typedArray(a),"TypedArray",a),arrayLike:a=>o(j.arrayLike(a),"array-like",a),domElement:a=>o(j.domElement(a),"HTMLElement",a),observable:a=>o(j.observable(a),"Observable",a),nodeStream:a=>o(j.nodeStream(a),"Node.js Stream",a),infinite:a=>o(j.infinite(a),"infinite number",a),emptyArray:a=>o(j.emptyArray(a),"empty array",a),nonEmptyArray:a=>o(j.nonEmptyArray(a),"non-empty array",a),emptyString:a=>o(j.emptyString(a),"empty string",a),emptyStringOrWhitespace:a=>o(j.emptyStringOrWhitespace(a),"empty string or whitespace",a),nonEmptyString:a=>o(j.nonEmptyString(a),"non-empty string",a),nonEmptyStringAndNotWhitespace:a=>o(j.nonEmptyStringAndNotWhitespace(a),"non-empty string and not whitespace",a),emptyObject:a=>o(j.emptyObject(a),"empty object",a),nonEmptyObject:a=>o(j.nonEmptyObject(a),"non-empty object",a),emptySet:a=>o(j.emptySet(a),"empty set",a),nonEmptySet:a=>o(j.nonEmptySet(a),"non-empty set",a),emptyMap:a=>o(j.emptyMap(a),"empty map",a),nonEmptyMap:a=>o(j.nonEmptyMap(a),"non-empty map",a),propertyKey:a=>o(j.propertyKey(a),"PropertyKey",a),formData:a=>o(j.formData(a),"FormData",a),urlSearchParams:a=>o(j.urlSearchParams(a),"URLSearchParams",a),evenInteger:a=>o(j.evenInteger(a),"even integer",a),oddInteger:a=>o(j.oddInteger(a),"odd integer",a),directInstanceOf:(a,b)=>o(j.directInstanceOf(a,b),"T",a),inRange:(a,b)=>o(j.inRange(a,b),"in range",a),any:(a,...b)=>o(j.any(a,...b),"predicate returns truthy for any value",b,{multipleValues:!0}),all:(a,...b)=>o(j.all(a,...b),"predicate returns truthy for all values",b,{multipleValues:!0})},Object.defineProperties(j,{class:{value:j.class_},function:{value:j.function_},null:{value:j.null_}}),Object.defineProperties(b.assert,{class:{value:b.assert.class_},function:{value:b.assert.function_},null:{value:b.assert.null_}}),b.default=j,a.exports=j,a.exports.default=j,a.exports.assert=b.assert},36161:(a,b,c)=>{"use strict";let d=c(73496),e=c(36348),f=c(1138),g=c(13543),h=c(98546);a.exports={...d,ClientRequest:f,IncomingMessage:g,...e,request:(a,b,c)=>new f(a,b,c),get:(a,b,c)=>{let d=new f(a,b,c);return d.end(),d},auto:h}},36348:(a,b,c)=>{"use strict";let d=c(94735),e=c(34631),f=c(73496),g=c(17632),h=Symbol("currentStreamsCount"),i=Symbol("request"),j=Symbol("cachedOriginSet"),k=Symbol("gracefullyClosing"),l=["maxDeflateDynamicTableSize","maxSessionMemory","maxHeaderListPairs","maxOutstandingPings","maxReservedRemoteStreams","maxSendHeaderBlockLength","paddingStrategy","localAddress","path","rejectUnauthorized","minDHSize","ca","cert","clientCertEngine","ciphers","key","pfx","servername","minVersion","maxVersion","secureProtocol","crl","honorCipherOrder","ecdhCurve","dhparam","secureOptions","sessionIdContext"],m=(a,b)=>a.remoteSettings.maxConcurrentStreams>b.remoteSettings.maxConcurrentStreams,n=(a,b)=>{for(let c of a)c[j].length<b[j].length&&c[j].every(a=>b[j].includes(a))&&c[h]+b[h]<=b.remoteSettings.maxConcurrentStreams&&p(c)},o=({agent:a,isFree:b})=>{let c={};for(let d in a.sessions){let e=a.sessions[d].filter(a=>{let c=a[q.kCurrentStreamsCount]<a.remoteSettings.maxConcurrentStreams;return b?c:!c});0!==e.length&&(c[d]=e)}return c},p=a=>{a[k]=!0,0===a[h]&&a.close()};class q extends d{constructor({timeout:a=6e4,maxSessions:b=1/0,maxFreeSessions:c=10,maxCachedTlsSessions:d=100}={}){super(),this.sessions={},this.queue={},this.timeout=a,this.maxSessions=b,this.maxFreeSessions=c,this._freeSessionsCount=0,this._sessionsCount=0,this.settings={enablePush:!1},this.tlsSessionCache=new g({maxSize:d})}static normalizeOrigin(a,b){return"string"==typeof a&&(a=new URL(a)),b&&a.hostname!==b&&(a.hostname=b),a.origin}normalizeOptions(a){let b="";if(a)for(let c of l)a[c]&&(b+=`:${a[c]}`);return b}_tryToCreateNewSession(a,b){if(!(a in this.queue)||!(b in this.queue[a]))return;let c=this.queue[a][b];this._sessionsCount<this.maxSessions&&!c.completed&&(c.completed=!0,c())}getSession(a,b,c){return new Promise((d,e)=>{Array.isArray(c)?(c=[...c],d()):c=[{resolve:d,reject:e}];let g=this.normalizeOptions(b),l=q.normalizeOrigin(a,b&&b.servername);if(void 0===l){for(let{reject:a}of c)a(TypeError("The `origin` argument needs to be a string or an URL object"));return}if(g in this.sessions){let a,b=this.sessions[g],d=-1,e=-1;for(let c of b){let b=c.remoteSettings.maxConcurrentStreams;if(b<d)break;if(c[j].includes(l)){let f=c[h];if(f>=b||c[k]||c.destroyed)continue;a||(d=b),f>e&&(a=c,e=f)}}if(a){if(1!==c.length){for(let{reject:a}of c)a(Error(`Expected the length of listeners to be 1, got ${c.length}.
Please report this to https://github.com/szmarczak/http2-wrapper/`));return}c[0].resolve(a);return}}if(g in this.queue){if(l in this.queue[g]){this.queue[g][l].listeners.push(...c),this._tryToCreateNewSession(g,l);return}}else this.queue[g]={};let o=()=>{g in this.queue&&this.queue[g][l]===r&&(delete this.queue[g][l],0===Object.keys(this.queue[g]).length&&delete this.queue[g])},r=()=>{let d=`${l}:${g}`,e=!1;try{let q=f.connect(a,{createConnection:this.createConnection,settings:this.settings,session:this.tlsSessionCache.get(d),...b});q[h]=0,q[k]=!1;let s=()=>q[h]<q.remoteSettings.maxConcurrentStreams,t=!0;q.socket.once("session",a=>{this.tlsSessionCache.set(d,a)}),q.once("error",a=>{for(let{reject:b}of c)b(a);this.tlsSessionCache.delete(d)}),q.setTimeout(this.timeout,()=>{q.destroy()}),q.once("close",()=>{if(e){t&&this._freeSessionsCount--,this._sessionsCount--;let a=this.sessions[g];a.splice(a.indexOf(q),1),0===a.length&&delete this.sessions[g]}else{let a=Error("Session closed without receiving a SETTINGS frame");for(let{reject:b}of(a.code="HTTP2WRAPPER_NOSETTINGS",c))b(a);o()}this._tryToCreateNewSession(g,l)});let u=()=>{if(g in this.queue&&s()){for(let a of q[j])if(a in this.queue[g]){let{listeners:b}=this.queue[g][a];for(;0!==b.length&&s();)b.shift().resolve(q);let c=this.queue[g];if(0===c[a].listeners.length&&(delete c[a],0===Object.keys(c).length)){delete this.queue[g];break}if(!s())break}}};q.on("origin",()=>{q[j]=q.originSet,s()&&(u(),n(this.sessions[g],q))}),q.once("remoteSettings",()=>{if(q.ref(),q.unref(),this._sessionsCount++,r.destroyed){let a=Error("Agent has been destroyed");for(let b of c)b.reject(a);q.destroy();return}q[j]=q.originSet;{let a=this.sessions;if(g in a){let b=a[g];b.splice(((a,b,c)=>{let d=0,e=a.length;for(;d<e;){let f=d+e>>>1;c(a[f],b)?d=f+1:e=f}return d})(b,q,m),0,q)}else a[g]=[q]}this._freeSessionsCount+=1,e=!0,this.emit("session",q),u(),o(),0===q[h]&&this._freeSessionsCount>this.maxFreeSessions&&q.close(),0!==c.length&&(this.getSession(l,b,c),c.length=0),q.on("remoteSettings",()=>{u(),n(this.sessions[g],q)})}),q[i]=q.request,q.request=(a,b)=>{if(q[k])throw Error("The session is gracefully closing. No new streams are allowed.");let c=q[i](a,b);return q.ref(),++q[h],q[h]===q.remoteSettings.maxConcurrentStreams&&this._freeSessionsCount--,c.once("close",()=>{if(t=s(),--q[h],!q.destroyed&&!q.closed){for(let a of this.sessions[g])q[j].length<a[j].length&&q[j].every(b=>a[j].includes(b))&&q[h]+a[h]<=a.remoteSettings.maxConcurrentStreams&&p(q);if(s()&&!q.closed){t||(this._freeSessionsCount++,t=!0);let a=0===q[h];a&&q.unref(),a&&(this._freeSessionsCount>this.maxFreeSessions||q[k])?q.close():(n(this.sessions[g],q),u())}}}),c}}catch(a){for(let b of c)b.reject(a);o()}};r.listeners=c,r.completed=!1,r.destroyed=!1,this.queue[g][l]=r,this._tryToCreateNewSession(g,l)})}request(a,b,c,d){return new Promise((e,f)=>{this.getSession(a,b,[{reject:f,resolve:a=>{try{e(a.request(c,d))}catch(a){f(a)}}}])})}createConnection(a,b){return q.connect(a,b)}static connect(a,b){b.ALPNProtocols=["h2"];let c=a.port||443,d=a.hostname||a.host;return void 0===b.servername&&(b.servername=d),e.connect(c,d,b)}closeFreeSessions(){for(let a of Object.values(this.sessions))for(let b of a)0===b[h]&&b.close()}destroy(a){for(let b of Object.values(this.sessions))for(let c of b)c.destroy(a);for(let a of Object.values(this.queue))for(let b of Object.values(a))b.destroyed=!0;this.queue={}}get freeSessions(){return o({agent:this,isFree:!0})}get busySessions(){return o({agent:this,isFree:!1})}}q.kCurrentStreamsCount=h,q.kGracefullyClosing=k,a.exports={Agent:q,globalAgent:new q}},37531:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let c=(a,b)=>{let c,d="function"==typeof(c="function"==typeof b?{connect:b}:b).connect,e="function"==typeof c.secureConnect,f="function"==typeof c.close,g=()=>{d&&c.connect(),a.encrypted&&e&&(a.authorized?c.secureConnect():a.authorizationError||a.once("secureConnect",c.secureConnect)),f&&a.once("close",c.close)};a.writable&&!a.connecting?g():a.connecting?a.once("connect",g):a.destroyed&&f&&c.close(a._hadError)};b.default=c,a.exports=c,a.exports.default=c},37827:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});class c{constructor(){this.weakMap=new WeakMap,this.map=new Map}set(a,b){"object"==typeof a?this.weakMap.set(a,b):this.map.set(a,b)}get(a){return"object"==typeof a?this.weakMap.get(a):this.map.get(a)}has(a){return"object"==typeof a?this.weakMap.has(a):this.map.has(a)}}b.default=c},40037:a=>{"use strict";a.exports=(a,b,c)=>{for(let d of c)a.on(d,(...a)=>b.emit(d,...a))}},41126:(a,b,c)=>{"use strict";let{V4MAPPED:d,ADDRCONFIG:e,ALL:f,promises:{Resolver:g},lookup:h}=c(14985),{promisify:i}=c(28354),j=c(21820),k=Symbol("cacheableLookupCreateConnection"),l=Symbol("cacheableLookupInstance"),m=Symbol("expires"),n="number"==typeof f,o=a=>{if(!(a&&"function"==typeof a.createConnection))throw Error("Expected an Agent instance as the first argument")},p=()=>{let a=!1,b=!1;for(let c of Object.values(j.networkInterfaces()))for(let d of c)if(!d.internal&&("IPv6"===d.family?b=!0:a=!0,a&&b))return{has4:a,has6:b};return{has4:a,has6:b}},q={ttl:!0},r={all:!0};class s{constructor({cache:a=new Map,maxTtl:b=1/0,fallbackDuration:c=3600,errorTtl:d=.15,resolver:e=new g,lookup:f=h}={}){if(this.maxTtl=b,this.errorTtl=d,this._cache=a,this._resolver=e,this._dnsLookup=i(f),this._resolver instanceof g?(this._resolve4=this._resolver.resolve4.bind(this._resolver),this._resolve6=this._resolver.resolve6.bind(this._resolver)):(this._resolve4=i(this._resolver.resolve4.bind(this._resolver)),this._resolve6=i(this._resolver.resolve6.bind(this._resolver))),this._iface=p(),this._pending={},this._nextRemovalTime=!1,this._hostnamesToFallback=new Set,c<1)this._fallback=!1;else{this._fallback=!0;let a=setInterval(()=>{this._hostnamesToFallback.clear()},1e3*c);a.unref&&a.unref()}this.lookup=this.lookup.bind(this),this.lookupAsync=this.lookupAsync.bind(this)}set servers(a){this.clear(),this._resolver.setServers(a)}get servers(){return this._resolver.getServers()}lookup(a,b,c){if("function"==typeof b?(c=b,b={}):"number"==typeof b&&(b={family:b}),!c)throw Error("Callback must be a function.");this.lookupAsync(a,b).then(a=>{b.all?c(null,a):c(null,a.address,a.family,a.expires,a.ttl)},c)}async lookupAsync(a,b={}){"number"==typeof b&&(b={family:b});let c=await this.query(a);if(6===b.family){let a=c.filter(a=>6===a.family);if(b.hints&d)if(n&&b.hints&f||0===a.length)for(let a of c)6!==a.family&&(a.address=`::ffff:${a.address}`,a.family=6);else c=a;else c=a}else 4===b.family&&(c=c.filter(a=>4===a.family));if(b.hints&e){let{_iface:a}=this;c=c.filter(b=>6===b.family?a.has6:a.has4)}if(0===c.length){let b=Error(`cacheableLookup ENOTFOUND ${a}`);throw b.code="ENOTFOUND",b.hostname=a,b}return b.all?c:c[0]}async query(a){let b=await this._cache.get(a);if(!b){let c=this._pending[a];if(c)b=await c;else{let c=this.queryAndCache(a);this._pending[a]=c;try{b=await c}finally{delete this._pending[a]}}}return b.map(a=>({...a}))}async _resolve(a){let b=async a=>{try{return await a}catch(a){if("ENODATA"===a.code||"ENOTFOUND"===a.code)return[];throw a}},[c,d]=await Promise.all([this._resolve4(a,q),this._resolve6(a,q)].map(a=>b(a))),e=0,f=0,g=0,h=Date.now();for(let a of c)a.family=4,a.expires=h+1e3*a.ttl,e=Math.max(e,a.ttl);for(let a of d)a.family=6,a.expires=h+1e3*a.ttl,f=Math.max(f,a.ttl);return g=c.length>0?d.length>0?Math.min(e,f):e:f,{entries:[...c,...d],cacheTtl:g}}async _lookup(a){try{return{entries:await this._dnsLookup(a,{all:!0}),cacheTtl:0}}catch(a){return{entries:[],cacheTtl:0}}}async _set(a,b,c){if(this.maxTtl>0&&c>0){c=1e3*Math.min(c,this.maxTtl),b[m]=Date.now()+c;try{await this._cache.set(a,b,c)}catch(a){this.lookupAsync=async()=>{let b=Error("Cache Error. Please recreate the CacheableLookup instance.");throw b.cause=a,b}}Symbol.iterator in this._cache&&this._tick(c)}}async queryAndCache(a){if(this._hostnamesToFallback.has(a))return this._dnsLookup(a,r);let b=await this._resolve(a);0===b.entries.length&&this._fallback&&0!==(b=await this._lookup(a)).entries.length&&this._hostnamesToFallback.add(a);let c=0===b.entries.length?this.errorTtl:b.cacheTtl;return await this._set(a,b.entries,c),b.entries}_tick(a){let b=this._nextRemovalTime;(!b||a<b)&&(clearTimeout(this._removalTimeout),this._nextRemovalTime=a,this._removalTimeout=setTimeout(()=>{this._nextRemovalTime=!1;let a=1/0,b=Date.now();for(let[c,d]of this._cache){let e=d[m];b>=e?this._cache.delete(c):e<a&&(a=e)}a!==1/0&&this._tick(a-b)},a),this._removalTimeout.unref&&this._removalTimeout.unref())}install(a){if(o(a),k in a)throw Error("CacheableLookup has been already installed");a[k]=a.createConnection,a[l]=this,a.createConnection=(b,c)=>("lookup"in b||(b.lookup=this.lookup),a[k](b,c))}uninstall(a){if(o(a),a[k]){if(a[l]!==this)throw Error("The agent is not owned by this CacheableLookup instance");a.createConnection=a[k],delete a[k],delete a[l]}}updateInterfaceInfo(){let{_iface:a}=this;this._iface=p(),(a.has4&&!this._iface.has4||a.has6&&!this._iface.has6)&&this._cache.clear()}clear(a){if(a)return void this._cache.delete(a);this._cache.clear()}}a.exports=s,a.exports.default=s},42061:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(90826);b.default=function(a,...b){let c=(async()=>{if(a instanceof d.RequestError)try{for(let c of b)if(c)for(let b of c)a=await b(a)}catch(b){a=b}throw a})(),e=()=>c;return c.json=e,c.text=e,c.buffer=e,c.on=e,c}},43026:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.dnsLookupIpVersionToFamily=b.isDnsLookupIpVersion=void 0;let c={auto:0,ipv4:4,ipv6:6};b.isDnsLookupIpVersion=a=>a in c,b.dnsLookupIpVersionToFamily=a=>{if(b.isDnsLookupIpVersion(a))return c[a];throw Error("Invalid DNS lookup IP version")}},43677:(a,b,c)=>{"use strict";let{tokenChars:d}=c(86200);a.exports={parse:function(a){let b=new Set,c=-1,e=-1,f=0;for(;f<a.length;f++){let g=a.charCodeAt(f);if(-1===e&&1===d[g])-1===c&&(c=f);else if(0!==f&&(32===g||9===g))-1===e&&-1!==c&&(e=f);else if(44===g){if(-1===c)throw SyntaxError(`Unexpected character at index ${f}`);-1===e&&(e=f);let d=a.slice(c,e);if(b.has(d))throw SyntaxError(`The "${d}" subprotocol is duplicated`);b.add(d),c=e=-1}else throw SyntaxError(`Unexpected character at index ${f}`)}if(-1===c||-1!==e)throw SyntaxError("Unexpected end of input");let g=a.slice(c,f);if(b.has(g))throw SyntaxError(`The "${g}" subprotocol is duplicated`);return b.add(g),b}}},43975:(a,b,c)=>{"use strict";let d=c(27910).PassThrough,e=c(55874);a.exports=a=>{if(!(a&&a.pipe))throw TypeError("Parameter `response` must be a response stream.");let b=new d;return e(a,b),a.pipe(b)}},45777:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(35510);b.default=(a,b)=>{if(d.default.null_(a.encoding))throw TypeError("To get a Buffer, set `options.responseType` to `buffer` instead");d.assert.any([d.default.string,d.default.undefined],a.encoding),d.assert.any([d.default.boolean,d.default.undefined],a.resolveBodyOnly),d.assert.any([d.default.boolean,d.default.undefined],a.methodRewriting),d.assert.any([d.default.boolean,d.default.undefined],a.isStream),d.assert.any([d.default.string,d.default.undefined],a.responseType),void 0===a.responseType&&(a.responseType="text");let{retry:c}=a;if(b?a.retry={...b.retry}:a.retry={calculateDelay:a=>a.computedValue,limit:0,methods:[],statusCodes:[],errorCodes:[],maxRetryAfter:void 0},d.default.object(c)?(a.retry={...a.retry,...c},a.retry.methods=[...new Set(a.retry.methods.map(a=>a.toUpperCase()))],a.retry.statusCodes=[...new Set(a.retry.statusCodes)],a.retry.errorCodes=[...new Set(a.retry.errorCodes)]):d.default.number(c)&&(a.retry.limit=c),d.default.undefined(a.retry.maxRetryAfter)&&(a.retry.maxRetryAfter=Math.min(...[a.timeout.request,a.timeout.connect].filter(d.default.number))),d.default.object(a.pagination)){b&&(a.pagination={...b.pagination,...a.pagination});let{pagination:c}=a;if(!d.default.function_(c.transform))throw Error("`options.pagination.transform` must be implemented");if(!d.default.function_(c.shouldContinue))throw Error("`options.pagination.shouldContinue` must be implemented");if(!d.default.function_(c.filter))throw TypeError("`options.pagination.filter` must be implemented");if(!d.default.function_(c.paginate))throw Error("`options.pagination.paginate` must be implemented")}return"json"===a.responseType&&void 0===a.headers.accept&&(a.headers.accept="application/json"),a}},48064:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.TimeoutError=void 0;let d=c(91645),e=c(98233),f=Symbol("reentry"),g=()=>{};class h extends Error{constructor(a,b){super(`Timeout awaiting '${b}' for ${a}ms`),this.event=b,this.name="TimeoutError",this.code="ETIMEDOUT"}}b.TimeoutError=h,b.default=(a,b,c)=>{if(f in a)return g;a[f]=!0;let i=[],{once:j,unhandleAll:k}=e.default(),l=(a,b,c)=>{var d;let e=setTimeout(b,a,a,c);null==(d=e.unref)||d.call(e);let f=()=>{clearTimeout(e)};return i.push(f),f},{host:m,hostname:n}=c,o=(b,c)=>{a.destroy(new h(b,c))},p=()=>{for(let a of i)a();k()};if(a.once("error",b=>{if(p(),0===a.listenerCount("error"))throw b}),a.once("close",p),j(a,"response",a=>{j(a,"end",p)}),void 0!==b.request&&l(b.request,o,"request"),void 0!==b.socket){let c=()=>{o(b.socket,"socket")};a.setTimeout(b.socket,c),i.push(()=>{a.removeListener("timeout",c)})}return j(a,"socket",e=>{var f;let{socketPath:g}=a;if(e.connecting){let a=!!(null!=g?g:0!==d.isIP(null!=(f=null!=n?n:m)?f:""));if(void 0===b.lookup||a||void 0!==e.address().address||j(e,"lookup",l(b.lookup,o,"lookup")),void 0!==b.connect){let c=()=>l(b.connect,o,"connect");a?j(e,"connect",c()):j(e,"lookup",a=>{null===a&&j(e,"connect",c())})}void 0!==b.secureConnect&&"https:"===c.protocol&&j(e,"connect",()=>{j(e,"secureConnect",l(b.secureConnect,o,"secureConnect"))})}if(void 0!==b.send){let c=()=>l(b.send,o,"send");e.connecting?j(e,"connect",()=>{j(a,"upload-complete",c())}):j(a,"upload-complete",c())}}),void 0!==b.response&&j(a,"upload-complete",()=>{j(a,"response",l(b.response,o,"response"))}),p}},50511:(a,b,c)=>{"use strict";let d=c(91645);a.exports=a=>{let b=a.host,c=a.headers&&a.headers.host;return(c&&(b=c.startsWith("[")?-1===c.indexOf("]")?c:c.slice(1,-1):c.split(":",1)[0]),d.isIP(b))?"":b}},52149:function(a,b,c){a.exports=((a,b)=>{"use strict";var d,e,f,g,h,i,j,k={},l={exports:k},m=Object.create,n=Object.defineProperty,o=Object.defineProperties,p=Object.getOwnPropertyDescriptor,q=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,t=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable,w=(a,b,c)=>b in a?n(a,b,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[b]=c,x=(a,b)=>{for(var c in b||(b={}))u.call(b,c)&&w(a,c,b[c]);if(s)for(var c of s(b))v.call(b,c)&&w(a,c,b[c]);return a},y=(a,b)=>o(a,q(b)),z=(a,b)=>function(){return b||(0,a[r(a)[0]])((b={exports:{}}).exports,b),b.exports},A=(a,b,c)=>(c=null!=a?m(t(a)):{},((a,b,c,d)=>{if(b&&"object"==typeof b||"function"==typeof b)for(let e of r(b))u.call(a,e)||e===c||n(a,e,{get:()=>b[e],enumerable:!(d=p(b,e))||d.enumerable});return a})(!b&&a&&a.__esModule?c:n(c,"default",{value:a,enumerable:!0}),a)),B=z({"node_modules/bops/from.js"(a,b){var d=c(79428).Buffer;b.exports=6>Number(((process||{}).version||"v0.0.0").slice(1).split(".")[0])?function(a,b){return new d(a,b)}:function(a,b){return d.from(a,b)}}}),C=z({"node_modules/bops/to.js"(a,b){b.exports=function(a,b){return a.toString(b)}}}),D=z({"node_modules/bops/is.js"(a,b){var d=c(79428).Buffer;b.exports=function(a){return d.isBuffer(a)}}}),E=z({"node_modules/bops/subarray.js"(a,b){b.exports=function(a,b,c){return 2==arguments.length?a.slice(b):a.slice(b,c)}}}),F=z({"node_modules/bops/join.js"(a,b){var d=c(79428).Buffer;b.exports=function(a,b){return void 0!==b?d.concat(a,b):d.concat(a)}}}),G=z({"node_modules/bops/copy.js"(a,b){b.exports=function(a,b,c,d,e){return a.copy(b,c,d,e)}}}),H=z({"node_modules/bops/create.js"(a,b){var d=c(79428).Buffer;b.exports=6>Number(((process||{}).version||"v0.0.0").slice(1).split(".")[0])?function(a){return new d(a)}:function(a){return d.alloc(a)}}}),I=z({"node_modules/bops/read.js"(a,b){var c,d={},e=/read.+/;for(c in b.exports=d,Buffer.prototype)e.test(c)&&(d[c]=Function(["buf","a","b","c"],"return buf."+c+"(a,b,c)"))}}),J=z({"node_modules/bops/write.js"(a,b){var d,e=c(79428).Buffer,f={},g=/write.+/;for(d in b.exports=f,e.prototype)g.test(d)&&(f[d]=Function(["buf","a","b","c"],"return buf."+d+"(a,b,c)"))}}),K=z({"node_modules/bops/index.js"(a,b){var c={};function d(a,b){for(var c in a)b[c]=a[c]}b.exports=c,c.from=B(),c.to=C(),c.is=D(),c.subarray=E(),c.join=F(),c.copy=G(),c.create=H(),d(I(),c),d(J(),c)}}),L=z({"node_modules/@ably/msgpack-js/msgpack.js"(a){var b=K();a.encode=function(a,d){var f=function a(c,d,f){var g,h,i=typeof c;if("string"===i){if((g=b.from(c).length)<32)return 1+g;if(g<256)return 2+g;if(g<65536)return 3+g;if(g<0x100000000)return 5+g}if(b.is(c)){if((g=c.length)<256)return 2+g;if(g<65536)return 3+g;if(g<0x100000000)return 5+g}if("number"===i){if(Math.floor(c)!==c)return 9;if(c>=0){if(c<128)return 1;if(c<256)return 2;if(c<65536)return 3;if(c<0x100000000)return 5;if(c<0xffffffffffffffff)return 9;throw Error("Number too big 0x"+c.toString(16))}if(c>=-32)return 1;if(c>=-128)return 2;if(c>=-32768)return 3;if(c>=-0x80000000)return 5;if(c>=-0x8000000000000000)return 9;throw Error("Number too small -0x"+c.toString(16).substr(1))}if("boolean"===i)return 1;if(null===c)return d&&f?0:1;if(void 0===c)return d&&f?0:3;if("function"==typeof c.toJSON)return a(c.toJSON(),d);if("object"===i){if(h=0,Array.isArray(c)){g=c.length;for(var j=0;j<g;j++)h+=a(c[j],d)}else{var k=e(c,d);g=k.length;for(var j=0;j<g;j++){var l=k[j];h+=a(l)+a(c[l],d,!0)}}if(g<16)return 1+h;if(g<65536)return 3+h;if(g<0x100000000)return 5+h;throw Error("Array or object too long 0x"+g.toString(16))}if("function"===i)return 0;throw Error("Unknown type "+i)}(a,d);if(0!=f){var g=b.create(f);return function a(d,f,g,h,i){var j,k,l,m,n,o,p=typeof d;if("string"===p){if((n=(d=b.from(d)).length)<32)return f[g]=160|n,b.copy(d,f,g+1),1+n;if(n<256)return f[g]=217,b.writeUInt8(f,n,g+1),b.copy(d,f,g+2),2+n;if(n<65536)return f[g]=218,b.writeUInt16BE(f,n,g+1),b.copy(d,f,g+3),3+n;if(n<0x100000000)return f[g]=219,b.writeUInt32BE(f,n,g+1),b.copy(d,f,g+5),5+n}if(b.is(d)){if((n=d.length)<256)return f[g]=196,b.writeUInt8(f,n,g+1),b.copy(d,f,g+2),2+n;if(n<65536)return f[g]=197,b.writeUInt16BE(f,n,g+1),b.copy(d,f,g+3),3+n;if(n<0x100000000)return f[g]=198,b.writeUInt32BE(f,n,g+1),b.copy(d,f,g+5),5+n}if("number"===p){if(Math.floor(d)!==d)return f[g]=203,b.writeDoubleBE(f,d,g+1),9;if(d>=0){if(d<128)return f[g]=d,1;if(d<256)return f[g]=204,f[g+1]=d,2;if(d<65536)return f[g]=205,b.writeUInt16BE(f,d,g+1),3;if(d<0x100000000)return f[g]=206,b.writeUInt32BE(f,d,g+1),5;if(d<0xffffffffffffffff)return f[g]=207,j=d,k=g+1,j<0xffffffffffffffff?(f.writeUInt32BE(Math.floor(j*c),k),f.writeInt32BE(-1&j,k+4)):(f.writeUInt32BE(0xffffffff,k),f.writeUInt32BE(0xffffffff,k+4)),9;throw Error("Number too big 0x"+d.toString(16))}if(d>=-32)return b.writeInt8(f,d,g),1;if(d>=-128)return f[g]=208,b.writeInt8(f,d,g+1),2;if(d>=-32768)return f[g]=209,b.writeInt16BE(f,d,g+1),3;if(d>=-0x80000000)return f[g]=210,b.writeInt32BE(f,d,g+1),5;if(d>=-0x8000000000000000)return f[g]=211,l=d,m=g+1,l<0x8000000000000000?(f.writeInt32BE(Math.floor(l*c),m),f.writeInt32BE(-1&l,m+4)):(f.writeUInt32BE(0x7fffffff,m),f.writeUInt32BE(0xffffffff,m+4)),9;throw Error("Number too small -0x"+d.toString(16).substr(1))}if("undefined"===p)return h&&i?0:(f[g]=212,f[g+1]=0,f[g+2]=0,3);if(null===d)return h&&i?0:(f[g]=192,1);if("boolean"===p)return f[g]=d?195:194,1;if("function"==typeof d.toJSON)return a(d.toJSON(),f,g,h);if("object"===p){o=0;var q=Array.isArray(d);if(q)n=d.length;else{var r=e(d,h);n=r.length}if(n<16?(f[g]=n|(q?144:128),o=1):n<65536?(f[g]=q?220:222,b.writeUInt16BE(f,n,g+1),o=3):n<0x100000000&&(f[g]=q?221:223,b.writeUInt32BE(f,n,g+1),o=5),q)for(var s=0;s<n;s++)o+=a(d[s],f,g+o,h);else for(var s=0;s<n;s++){var t=r[s];o+=a(t,f,g+o),o+=a(d[t],f,g+o,h,!0)}return o}if("function"!==p)throw Error("Unknown type "+p)}(a,g,0,d),g}},a.decode=function(a){var b=new d(a),c=b.parse();if(b.offset!==a.length)throw Error(a.length-b.offset+" trailing bytes");return c};var c=23283064365386963e-26;function d(a,b){this.offset=b||0,this.buffer=a,this.bufferLength=a.length}function e(a,b){return Object.keys(a).filter(function(c){var d=a[c],e=typeof d;return(!b||null!=d)&&("function"!==e||!!d.toJSON)})}d.prototype.map=function(a){if(2*a>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced a map of length ${a})`);for(var b={},c=0;c<a;c++)b[this.parse()]=this.parse();return b},d.prototype.bin=d.prototype.buf=function(a){if(a>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced a binary of length ${a})`);var c=b.subarray(this.buffer,this.offset,this.offset+a);return this.offset+=a,c},d.prototype.str=function(a){if(a>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced a string of length ${a})`);var c=b.to(b.subarray(this.buffer,this.offset,this.offset+a));return this.offset+=a,c},d.prototype.array=function(a){if(a>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced an array of length ${a})`);for(var b=Array(a),c=0;c<a;c++)b[c]=this.parse();return b},d.prototype.parse=function(){var a,c,d,e,f,g,h,i=this.buffer[this.offset];if(void 0===i)throw Error("malformed messagepack (referenced offset is outside buffer)");if((128&i)==0)return this.offset++,i;if((240&i)==128)return g=15&i,this.offset++,this.map(g);if((240&i)==144)return g=15&i,this.offset++,this.array(g);if((224&i)==160)return g=31&i,this.offset++,this.str(g);if((224&i)==224)return f=b.readInt8(this.buffer,this.offset),this.offset++,f;switch(i){case 192:return this.offset++,null;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return g=b.readUInt8(this.buffer,this.offset+1),this.offset+=2,this.bin(g);case 197:return g=b.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.bin(g);case 198:return g=b.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.bin(g);case 199:return g=b.readUInt8(this.buffer,this.offset+1),h=b.readUInt8(this.buffer,this.offset+2),this.offset+=3,[h,this.bin(g)];case 200:return g=b.readUInt16BE(this.buffer,this.offset+1),h=b.readUInt8(this.buffer,this.offset+3),this.offset+=4,[h,this.bin(g)];case 201:return g=b.readUInt32BE(this.buffer,this.offset+1),h=b.readUInt8(this.buffer,this.offset+5),this.offset+=6,[h,this.bin(g)];case 202:return f=b.readFloatBE(this.buffer,this.offset+1),this.offset+=5,f;case 203:return f=b.readDoubleBE(this.buffer,this.offset+1),this.offset+=9,f;case 204:return f=this.buffer[this.offset+1],this.offset+=2,f;case 205:return f=b.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,f;case 206:return f=b.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,f;case 207:return a=this.buffer,c=(c=this.offset+1)||0,f=0x100000000*a.readUInt32BE(c+0)+a.readUInt32BE(c+4),this.offset+=9,f;case 208:return f=b.readInt8(this.buffer,this.offset+1),this.offset+=2,f;case 209:return f=b.readInt16BE(this.buffer,this.offset+1),this.offset+=3,f;case 210:return f=b.readInt32BE(this.buffer,this.offset+1),this.offset+=5,f;case 211:return d=this.buffer,e=(e=this.offset+1)||0,f=0x100000000*d.readInt32BE(e+0)+d.readUInt32BE(e+4),this.offset+=9,f;case 212:return h=b.readUInt8(this.buffer,this.offset+1),f=b.readUInt8(this.buffer,this.offset+2),this.offset+=3,0===h&&0===f?void 0:[h,f];case 213:return h=b.readUInt8(this.buffer,this.offset+1),this.offset+=2,[h,this.bin(2)];case 214:return h=b.readUInt8(this.buffer,this.offset+1),this.offset+=2,[h,this.bin(4)];case 215:return h=b.readUInt8(this.buffer,this.offset+1),this.offset+=2,[h,this.bin(8)];case 216:return h=b.readUInt8(this.buffer,this.offset+1),this.offset+=2,[h,this.bin(16)];case 217:return g=b.readUInt8(this.buffer,this.offset+1),this.offset+=2,this.str(g);case 218:return g=b.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.str(g);case 219:return g=b.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.str(g);case 220:return g=b.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.array(g);case 221:return g=b.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.array(g);case 222:return g=b.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.map(g);case 223:return g=b.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.map(g)}throw Error("Unknown type 0x"+i.toString(16))}}}),M=class{},N="undefined"!=typeof global?global:"undefined"!=typeof window?window:self;function O(a,b){return`${a}`.padStart(b?3:2,"0")}function P(a){return M.Config.logTimestamps?function(b){let c=new Date;a(O(c.getHours())+":"+O(c.getMinutes())+":"+O(c.getSeconds())+"."+O(c.getMilliseconds(),1)+" "+b)}:function(b){a(b)}}var Q=class a{constructor(){this.deprecated=(a,b)=>{this.deprecationWarning(`${a} is deprecated and will be removed in a future version. ${b}`)},this.shouldLog=a=>a<=this.logLevel,this.setLog=(a,b)=>{void 0!==a&&(this.logLevel=a),void 0!==b&&(this.logHandler=this.logErrorHandler=b)},this.logLevel=a.defaultLogLevel,this.logHandler=a.defaultLogHandler,this.logErrorHandler=a.defaultLogErrorHandler}static initLogHandlers(){var b;let c,d,[e,f]=("function"==typeof(null==(b=null==N?void 0:N.console)?void 0:b.log)?(c=function(...a){console.log.apply(console,a)},d=console.warn?function(...a){console.warn.apply(console,a)}:c):c=d=function(){},[c,d].map(P));this.defaultLogHandler=e,this.defaultLogErrorHandler=f,this.defaultLogger=new a}static logActionNoStrip(a,b,c,d){a.logAction(b,c,d)}logAction(a,b,c){this.shouldLog(a)&&(1===a?this.logErrorHandler:this.logHandler)("Ably: "+b+": "+c,a)}renamedClientOption(a,b){this.deprecationWarning(`The \`${a}\` client option has been renamed to \`${b}\`. Please update your code to use \`${b}\` instead. \`${a}\` will be removed in a future version.`)}renamedMethod(a,b,c){this.deprecationWarning(`\`${a}\`\u2019s \`${b}\` method has been renamed to \`${c}\`. Please update your code to use \`${c}\` instead. \`${b}\` will be removed in a future version.`)}deprecationWarning(a){this.shouldLog(1)&&this.logErrorHandler(`Ably: Deprecation warning - ${a}`,1)}};Q.defaultLogLevel=1,Q.LOG_NONE=0,Q.LOG_ERROR=1,Q.LOG_MAJOR=2,Q.LOG_MINOR=3,Q.LOG_MICRO=4,Q.logAction=(a,b,c,d)=>{Q.logActionNoStrip(a,b,c,d)};var R={},S={Format:()=>ao,allSame:()=>an,allToLowerCase:()=>aC,allToUpperCase:()=>aD,arrChooseN:()=>ay,arrDeleteValue:()=>ai,arrEquals:()=>aL,arrIntersect:()=>ag,arrIntersectOb:()=>ah,arrPopRandomElement:()=>ap,arrWithoutValue:()=>aj,cheapRandStr:()=>aw,containsValue:()=>ae,copy:()=>Y,createMissingPluginError:()=>aM,dataSizeBytes:()=>av,decodeBody:()=>aA,encodeBody:()=>aB,ensureArray:()=>Z,forInOwnNonNullProperties:()=>am,getBackoffCoefficient:()=>aE,getGlobalObject:()=>aH,getJitterCoefficient:()=>aF,getRetryTime:()=>aG,inherits:()=>ad,inspectBody:()=>au,inspectError:()=>at,intersect:()=>af,isEmpty:()=>_,isErrorInfoOrPartialErrorInfo:()=>as,isNil:()=>aa,isObject:()=>$,keysArray:()=>ak,matchDerivedChannel:()=>aJ,mixin:()=>X,parseQueryString:()=>ar,prototypicalClone:()=>ac,randomString:()=>ax,shallowClone:()=>ab,shallowEquals:()=>aI,throwMissingPluginError:()=>aN,toBase64:()=>aK,toQueryString:()=>aq,valuesArray:()=>al,whenPromiseSettles:()=>az,withTimeoutAsync:()=>aO};for(var T in S)n(R,T,{get:S[T],enumerable:!0});function U(a){let b="["+a.constructor.name;return a.message&&(b+=": "+a.message),a.statusCode&&(b+="; statusCode="+a.statusCode),a.code&&(b+="; code="+a.code),a.cause&&(b+="; cause="+at(a.cause)),a.href&&!(a.message&&a.message.indexOf("help.ably.io")>-1)&&(b+="; see "+a.href+" "),b+="]"}var V=class a extends Error{constructor(b,c,d,e){super(b),void 0!==Object.setPrototypeOf&&Object.setPrototypeOf(this,a.prototype),this.code=c,this.statusCode=d,this.cause=e}toString(){return U(this)}static fromValues(b){let{message:c,code:d,statusCode:e}=b;if("string"!=typeof c||"number"!=typeof d||"number"!=typeof e)throw Error("ErrorInfo.fromValues(): invalid values: "+M.Config.inspect(b));let f=Object.assign(new a(c,d,e),b);return f.code&&!f.href&&(f.href="https://help.ably.io/error/"+f.code),f}},W=class a extends Error{constructor(b,c,d,e){super(b),void 0!==Object.setPrototypeOf&&Object.setPrototypeOf(this,a.prototype),this.code=c,this.statusCode=d,this.cause=e}toString(){return U(this)}static fromValues(b){let{message:c,code:d,statusCode:e}=b;if("string"!=typeof c||!aa(d)&&"number"!=typeof d||!aa(e)&&"number"!=typeof e)throw Error("PartialErrorInfo.fromValues(): invalid values: "+M.Config.inspect(b));let f=Object.assign(new a(c,d,e),b);return f.code&&!f.href&&(f.href="https://help.ably.io/error/"+f.code),f}};function X(a,...b){for(let c=0;c<b.length;c++){let d=b[c];if(!d)break;for(let b in d)Object.prototype.hasOwnProperty.call(d,b)&&(a[b]=d[b])}return a}function Y(a){return X({},a)}function Z(a){return aa(a)?[]:Array.isArray(a)?a:[a]}function $(a){return"[object Object]"==Object.prototype.toString.call(a)}function _(a){for(let b in a)return!1;return!0}function aa(a){return null==a}function ab(a){let b={};for(let c in a)b[c]=a[c];return b}function ac(a,b){class c{}c.prototype=a;let d=new c;return b&&X(d,b),d}var ad=function(a,b){if(M.Config.inherits)return void M.Config.inherits(a,b);a.super_=b,a.prototype=ac(b.prototype,{constructor:a})};function ae(a,b){for(let c in a)if(a[c]==b)return!0;return!1}function af(a,b){return Array.isArray(b)?ag(a,b):ah(a,b)}function ag(a,b){let c=[];for(let d=0;d<a.length;d++){let e=a[d];-1!=b.indexOf(e)&&c.push(e)}return c}function ah(a,b){let c=[];for(let d=0;d<a.length;d++){let e=a[d];e in b&&c.push(e)}return c}function ai(a,b){let c=a.indexOf(b),d=-1!=c;return d&&a.splice(c,1),d}function aj(a,b){let c=a.slice();return ai(c,b),c}function ak(a,b){let c=[];for(let d in a)(!b||Object.prototype.hasOwnProperty.call(a,d))&&c.push(d);return c}function al(a,b){let c=[];for(let d in a)(!b||Object.prototype.hasOwnProperty.call(a,d))&&c.push(a[d]);return c}function am(a,b){for(let c in a)Object.prototype.hasOwnProperty.call(a,c)&&a[c]&&b(c)}function an(a,b){if(0===a.length)return!0;let c=a[0][b];return a.every(function(a){return a[b]===c})}var ao=((d=ao||{}).msgpack="msgpack",d.json="json",d);function ap(a){return a.splice(Math.floor(Math.random()*a.length),1)[0]}function aq(a){let b=[];if(a)for(let c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.length?"?"+b.join("&"):""}function ar(a){let b,c=/([^?&=]+)=?([^&]*)/g,d={};for(;b=c.exec(a);)d[decodeURIComponent(b[1])]=decodeURIComponent(b[2]);return d}function as(a){return"object"==typeof a&&null!==a&&(a instanceof V||a instanceof W)}function at(a){var b,c;return a instanceof Error||(null==(b=null==a?void 0:a.constructor)?void 0:b.name)==="ErrorInfo"||(null==(c=null==a?void 0:a.constructor)?void 0:c.name)==="PartialErrorInfo"?a.toString():M.Config.inspect(a)}function au(a){return M.BufferUtils.isBuffer(a)?a.toString():"string"==typeof a?a:M.Config.inspect(a)}function av(a){if(M.BufferUtils.isBuffer(a))return M.BufferUtils.byteLength(a);if("string"==typeof a)return M.Config.stringByteSize(a);if("number"==typeof a)return 8;if("boolean"==typeof a)return 1;throw Error(`Expected input of Utils.dataSizeBytes to be a string, a number, a boolean or a buffer, but was: ${typeof a}`)}function aw(){return String(Math.random()).substr(2)}var ax=async a=>{let b=await M.Config.getRandomArrayBuffer(a);return M.BufferUtils.base64Encode(b)};function ay(a,b){let c=Math.min(b,a.length),d=a.slice(),e=[];for(let a=0;a<c;a++)e.push(ap(d));return e}function az(a,b){a.then(a=>{null==b||b(null,a)}).catch(a=>{null==b||b(a)})}function aA(a,b,c){return"msgpack"==c?(b||aN("MsgPack"),b.decode(a)):JSON.parse(String(a))}function aB(a,b,c){return"msgpack"==c?(b||aN("MsgPack"),b.encode(a,!0)):JSON.stringify(a)}function aC(a){return a.map(function(a){return a&&a.toLowerCase()})}function aD(a){return a.map(function(a){return a&&a.toUpperCase()})}function aE(a){return Math.min((a+2)/3,2)}function aF(){return 1-.2*Math.random()}function aG(a,b){return a*aE(b)*aF()}function aH(){return"undefined"!=typeof global?global:"undefined"!=typeof window?window:self}function aI(a,b){return Object.keys(a).every(c=>a[c]===b[c])&&Object.keys(b).every(c=>b[c]===a[c])}function aJ(a){let b=a.match(/^(\[([^?]*)(?:(.*))\])?(.+)$/);if(!b||!b.length||b.length<5)throw new V("regex match failed",400,40010);if(b[2])throw new V(`cannot use a derived option with a ${b[2]} channel`,400,40010);return{qualifierParam:b[3]||"",channelName:b[4]}}function aK(a){let b=M.BufferUtils,c=b.utf8Encode(a);return b.base64Encode(c)}function aL(a,b){return a.length===b.length&&a.every(function(a,c){return a===b[c]})}function aM(a){return new V(`${a} plugin not provided`,40019,400)}function aN(a){throw aM(a)}async function aO(a,b=5e3,c="Timeout expired"){let d=new V(c,5e4,500);return Promise.race([a,new Promise((a,c)=>setTimeout(()=>c(d),b))])}var aP="2.14.0",aQ={ENDPOINT:"main",ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["main.a.fallback.ably-realtime.com","main.b.fallback.ably-realtime.com","main.c.fallback.ably-realtime.com","main.d.fallback.ably-realtime.com","main.e.fallback.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:1e4,httpMaxRetryDuration:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4e3},httpMaxRetryCount:3,maxMessageSize:65536,version:aP,protocolVersion:4,agent:"ably-js/"+aP,getPort:function(a,b){return b||a.tls?a.tlsPort:a.port},getHttpScheme:function(a){return a.tls?"https://":"http://"},getPrimaryDomainFromEndpoint:aS,getEndpointFallbackHosts:aT,getFallbackHosts:aV,getHosts:function(a){return[a.primaryDomain].concat(aV(a))},checkHost:aW,objectifyOptions:function(a,b,c,d,e){let f;if(void 0===a){let a=b?`${c} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${c} must be initialized with a client options object`;throw Q.logAction(d,Q.LOG_ERROR,`${c}()`,a),Error(a)}if("string"==typeof a)if(-1==a.indexOf(":")){if(!b){let a=`${c} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object\u2019s \`token\` property.)`;throw Q.logAction(d,Q.LOG_ERROR,`${c}()`,a),Error(a)}f={token:a}}else{if(!b){let a=`${c} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object\u2019s \`key\` property.)`;throw Q.logAction(d,Q.LOG_ERROR,`${c}()`,a),Error(a)}f={key:a}}else f=a;return e&&(f=y(x({},f),{plugins:x(x({},e),f.plugins)})),f},normaliseOptions:function(a,b,c){let d=null!=c?c:Q.defaultLogger;a.environment&&d.deprecated("The `environment` client option","Use the `endpoint` client option instead."),a.restHost&&d.deprecated("The `restHost` client option","Use the `endpoint` client option instead."),a.realtimeHost&&d.deprecated("The `realtimeHost` client option","Use the `endpoint` client option instead.");if(a.endpoint&&(a.environment||a.restHost||a.realtimeHost))throw new V("The `endpoint` option cannot be used in conjunction with the `environment`, `restHost`, or `realtimeHost` options.",40106,400);if(a.environment&&(a.restHost||a.realtimeHost))throw new V("The `environment` option cannot be used in conjunction with the `restHost`, or `realtimeHost` options.",40106,400);"function"==typeof a.recover&&!0===a.closeOnUnload&&(Q.logAction(d,Q.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),a.recover=void 0),"closeOnUnload"in a||(a.closeOnUnload=!a.recover),"queueMessages"in a||(a.queueMessages=!0);let e=a.endpoint||aQ.ENDPOINT;a.fallbackHosts||a.restHost||a.realtimeHost||a.port||a.tlsPort||(a.fallbackHosts=aT(a.environment||e));let f=a.environment&&`${a.environment}.realtime.ably.net`,g=a.restHost||a.realtimeHost||f||aS(e);(a.fallbackHosts||[]).concat(g).forEach(aW),a.port=a.port||aQ.PORT,a.tlsPort=a.tlsPort||aQ.TLS_PORT,"tls"in a||(a.tls=!0);let h=function(a){let b={};for(let c in aQ.TIMEOUTS)b[c]=a[c]||aQ.TIMEOUTS[c];return b}(a);b?"useBinaryProtocol"in a?a.useBinaryProtocol=M.Config.supportsBinary&&a.useBinaryProtocol:a.useBinaryProtocol=M.Config.preferBinary:a.useBinaryProtocol=!1;let i={};a.clientId&&(i["X-Ably-ClientId"]=M.BufferUtils.base64Encode(M.BufferUtils.utf8Encode(a.clientId))),"idempotentRestPublishing"in a||(a.idempotentRestPublishing=!0);let j=null,k=a.connectivityCheckUrl;if(a.connectivityCheckUrl){let[b,c]=a.connectivityCheckUrl.split("?");j=c?ar(c):{},-1===b.indexOf("://")&&(b="https://"+b),k=b}let l=a.wsConnectivityCheckUrl;return l&&-1===l.indexOf("://")&&(l="wss://"+l),y(x({},a),{primaryDomain:g,maxMessageSize:a.maxMessageSize||aQ.maxMessageSize,timeouts:h,connectivityCheckParams:j,connectivityCheckUrl:k,wsConnectivityCheckUrl:l,headers:i})},defaultGetHeaders:function(a,{format:b=a$.format,protocolVersion:c=a$.protocolVersion}={}){return{accept:aZ[b],"X-Ably-Version":c.toString(),"Ably-Agent":aX(a)}},defaultPostHeaders:function(a,{format:b=a$.format,protocolVersion:c=a$.protocolVersion}={}){let d;return{accept:d=aZ[b],"content-type":d,"X-Ably-Version":c.toString(),"Ably-Agent":aX(a)}}};function aR(a){return a.includes(".")||a.includes("::")||"localhost"===a}function aS(a){if(aR(a))return a;if(a.startsWith("nonprod:")){let b=a.replace("nonprod:","");return`${b}.realtime.ably-nonprod.net`}return`${a}.realtime.ably.net`}function aT(a){return aR(a)?[]:a.startsWith("nonprod:")?aU(a.replace("nonprod:",""),"ably-realtime-nonprod.com"):aU(a,"ably-realtime.com")}function aU(a,b){return["a","b","c","d","e"].map(c=>`${a}.${c}.fallback.${b}`)}function aV(a){let b=a.fallbackHosts,c=void 0!==a.httpMaxRetryCount?a.httpMaxRetryCount:aQ.httpMaxRetryCount;return b?ay(b,c):[]}function aW(a){if("string"!=typeof a)throw new V("host must be a string; was a "+typeof a,4e4,400);if(!a.length)throw new V("host must not be zero-length",4e4,400)}function aX(a){let b=aQ.agent;if(a.agents)for(var c in a.agents)b+=" "+c+"/"+a.agents[c];return b}function aY(a,b,c){let d=c||{};if(d.cipher){a||aN("Crypto");let c=a.getCipher(d.cipher,b);d.cipher=c.cipherParams,d.channelCipher=c.cipher}else"cipher"in d&&(d.cipher=void 0,d.channelCipher=null);return d}var aZ={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},a$={format:"json",protocolVersion:aQ.protocolVersion},a_=class a{constructor(a,b){this.logger=a,this.members=b||[]}call(a,b){for(let c of this.members)if(c)try{c(a,b)}catch(a){Q.logAction(this.logger,Q.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+a+"; stack = "+a.stack)}}push(...a){this.members.push(...a)}createPromise(){return new Promise((a,b)=>{this.push((c,d)=>{c?b(c):a(d)})})}resolveAll(a){this.call(null,a)}rejectAll(a){this.call(a)}static create(b,c){let d=new a(b,c);return Object.assign((a,b)=>d.call(a,b),{push:a=>d.push(a),createPromise:()=>d.createPromise(),resolveAll:a=>d.resolveAll(a),rejectAll:a=>d.rejectAll(a)})}},a0=((e=a0||{}).Get="get",e.Delete="delete",e.Post="post",e.Put="put",e.Patch="patch",e),a1=((f=a1||{})[f.Success=200]="Success",f[f.NoContent=204]="NoContent",f[f.BadRequest=400]="BadRequest",f[f.Unauthorized=401]="Unauthorized",f[f.Forbidden=403]="Forbidden",f[f.RequestTimeout=408]="RequestTimeout",f[f.InternalServerError=500]="InternalServerError",f);function a2(a){return as(a)?(a.code||(403===a.statusCode?a.code=40300:(a.code=40170,a.statusCode=401)),a):new V(at(a),a.code||40170,a.statusCode||401)}function a3(a){if(!a)return"";"string"==typeof a&&(a=JSON.parse(a));let b=Object.create(null),c=ak(a,!0);if(!c)return"";c.sort();for(let d=0;d<c.length;d++)b[c[d]]=a[c[d]].sort();return JSON.stringify(b)}function a4(a,b){if(a.authCallback)Q.logAction(b,Q.LOG_MINOR,"Auth()","using token auth with authCallback");else if(a.authUrl)Q.logAction(b,Q.LOG_MINOR,"Auth()","using token auth with authUrl");else if(a.key)Q.logAction(b,Q.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(a.tokenDetails)Q.logAction(b,Q.LOG_MINOR,"Auth()","using token auth with supplied token only");else{let a="authOptions must include valid authentication parameters";throw Q.logAction(b,Q.LOG_ERROR,"Auth()",a),Error(a)}}function a5(a){return a.useTokenAuth||!("useTokenAuth"in a&&!a.useTokenAuth)&&(a.authCallback||a.authUrl||a.token||a.tokenDetails)}var a6=0,a7=class{constructor(a,b){if(this.authOptions={},this.client=a,this.tokenParams=b.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,a5(b))(function(a){return!a.key&&!a.authCallback&&!a.authUrl})(b)&&Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(b.defaultTokenParams,b),a4(this.authOptions,this.logger);else{if(!b.key){let a="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw Q.logAction(this.logger,Q.LOG_ERROR,"Auth()",a),new V(a,40160,401)}Q.logAction(this.logger,Q.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(b)}}get logger(){return this.client.logger}async authorize(a,b){if(b&&b.key&&this.authOptions.key!==b.key)throw new V("Unable to update auth options with incompatible key",40102,401);try{let c=await this._forceNewToken(null!=a?a:null,null!=b?b:null);if(this.client.connection)return new Promise((a,b)=>{this.client.connection.connectionManager.onAuthUpdated(c,(c,d)=>c?b(c):a(d))});return c}catch(a){throw this.client.connection&&a.statusCode===a1.Forbidden&&this.client.connection.connectionManager.actOnErrorFromAuthorize(a),a}}async _forceNewToken(a,b){this.tokenDetails=null,this._saveTokenOptions(a,b),a4(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(a,b){let c=b||this.authOptions,d=a||Y(this.tokenParams),e,f=this.client;if(c.authCallback)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),e=c.authCallback;else if(c.authUrl)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),e=(a,b)=>{let d,e=X({accept:"application/json, text/plain"},c.authHeaders),f=c.authMethod&&"post"===c.authMethod.toLowerCase(),g=c.authUrl.indexOf("?");g>-1&&(d=ar(c.authUrl.slice(g)),c.authUrl=c.authUrl.slice(0,g),f||(c.authParams=X(d,c.authParams)));let h=X({},c.authParams||{},a),i=a=>{var c,d;let e=null!=(c=a.body)?c:null,f=null;if(a.error)Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+at(a.error));else{let b=null!=(d=a.headers["content-type"])?d:null;f=Array.isArray(b)?b.join(", "):b,Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+f+"; body: "+au(e))}if(a.error)return void b(a.error,null);if(a.unpacked)return void b(null,e);if(M.BufferUtils.isBuffer(e)&&(e=e.toString()),!f)return void b(new V("authUrl response is missing a content-type header",40170,401),null);let g=f.indexOf("application/json")>-1,h=f.indexOf("text/plain")>-1||f.indexOf("application/jwt")>-1;if(!g&&!h)return void b(new V("authUrl responded with unacceptable content-type "+f+", should be either text/plain, application/jwt or application/json",40170,401),null);if(g){if(e.length>131072)return void b(new V("authUrl response exceeded max permitted length",40170,401),null);try{e=JSON.parse(e)}catch(a){b(new V("Unexpected error processing authURL response; err = "+a.message,40170,401),null);return}}b(null,e,f)};if(Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+c.authUrl+"; Params: "+JSON.stringify(h)+"; method: "+(f?"POST":"GET")),f){let a=e||{};a["content-type"]="application/x-www-form-urlencoded";let b=aq(h).slice(1);az(this.client.http.doUri(a0.Post,c.authUrl,a,b,d),(a,b)=>a?i(a):i(b))}else az(this.client.http.doUri(a0.Get,c.authUrl,e||{},null,h),(a,b)=>a?i(a):i(b))};else if(c.key)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),e=(a,b)=>{az(this.createTokenRequest(a,c),(a,c)=>b(a,null!=c?c:null))};else throw Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new V("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403);"capability"in d&&(d.capability=a3(d.capability));let g=(a,b)=>{let d="/keys/"+a.keyName+"/requestToken",e=aQ.defaultPostHeaders(this.client.options);c.requestHeaders&&X(e,c.requestHeaders),Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+d+"; Token params: "+JSON.stringify(a)),az(this.client.http.do(a0.Post,function(a){return f.baseUri(a)+d},e,JSON.stringify(a),null),(a,c)=>a?b(a):b(c.error,c.body,c.unpacked))};return new Promise((a,b)=>{let f=!1,h=this.client.options.timeouts.realtimeRequestTimeout,i=setTimeout(()=>{f=!0;let a="Token request callback timed out after "+h/1e3+" seconds";Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",a),b(new V(a,40170,401))},h);e(d,(d,e,h)=>{if(f)return;if(clearTimeout(i),d){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+at(d)),b(a2(d));return}if("string"==typeof e)return void(0===e.length?b(new V("Token string is empty",40170,401)):e.length>131072?b(new V("Token string exceeded max permitted length (was "+e.length+" bytes)",40170,401)):"undefined"===e||"null"===e?b(new V("Token string was literal null/undefined",40170,401)):"{"!==e[0]||h&&h.indexOf("application/jwt")>-1?a({token:e}):b(new V("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401)));if("object"!=typeof e||null===e){let a="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof e;Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",a),b(new V(a,40170,401));return}let j=JSON.stringify(e).length;if(j>131072&&!c.suppressMaxLengthCheck)return void b(new V("Token request/details object exceeded max permitted stringified size (was "+j+" bytes)",40170,401));if("issued"in e)return void a(e);if(!("keyName"in e)){let a="Expected token request callback to call back with a token string, token request object, or token details object";Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",a),b(new V(a,40170,401));return}g(e,(c,d,e)=>{if(c){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+at(c)),b(a2(c));return}e||(d=JSON.parse(d)),Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","token received"),a(d)})})})}async createTokenRequest(a,b){b=b||this.authOptions,a=a||Y(this.tokenParams);let c=b.key;if(!c)throw new V("No key specified",40101,403);let d=c.split(":"),e=d[0],f=d[1];if(!f)throw new V("Invalid key specified",40101,403);if(""===a.clientId)throw new V("clientId cant be an empty string",40012,400);"capability"in a&&(a.capability=a3(a.capability));let g=X({keyName:e},a),h=a.clientId||"",i=a.ttl||"",j=a.capability||"";g.timestamp||(g.timestamp=await this._getTimestamp(b&&b.queryTime));let k=g.nonce||(g.nonce=("000000"+Math.floor(1e16*Math.random())).slice(-16)),l=g.timestamp,m=g.keyName+"\n"+i+"\n"+j+"\n"+h+"\n"+l+"\n"+k+"\n";return g.mac=g.mac||((a,b)=>{let c=M.BufferUtils,d=c.utf8Encode(a),e=c.utf8Encode(b),f=c.hmacSha256(d,e);return c.base64Encode(f)})(m,f),Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),g}async getAuthParams(){if("basic"==this.method)return{key:this.key};{let a=await this._ensureValidAuthCredentials(!1);if(!a)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:a.token}}}async getAuthHeaders(){if("basic"==this.method)return{authorization:"Basic "+this.basicKey};{let a=await this._ensureValidAuthCredentials(!1);if(!a)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+aK(a.token)}}}_saveBasicOptions(a){this.method="basic",this.key=a.key,this.basicKey=aK(a.key),this.authOptions=a||{},"clientId"in a&&this._userSetClientId(a.clientId)}_saveTokenOptions(a,b){this.method="token",a&&(this.tokenParams=a),b&&(b.token&&(b.tokenDetails="string"==typeof b.token?{token:b.token}:b.token),b.tokenDetails&&(this.tokenDetails=b.tokenDetails),"clientId"in b&&this._userSetClientId(b.clientId),this.authOptions=b)}async _ensureValidAuthCredentials(a){let b=this.tokenDetails;if(b){if(this._tokenClientIdMismatch(b.clientId))throw new V("Mismatch between clientId in token ("+b.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.client.isTimeOffsetSet()||!b.expires||b.expires>=this.client.getTimestampUsingOffset())return Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+b.expires),b;Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}let c=(this.waitingForTokenRequest||(this.waitingForTokenRequest=a_.create(this.logger))).createPromise();if(null!==this.currentTokenRequestId&&!a)return c;let d=this.currentTokenRequestId=a6++,e,f=null;try{e=await this.requestToken(this.tokenParams,this.authOptions)}catch(a){f=a}if(this.currentTokenRequestId>d)return Q.logAction(this.logger,Q.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),c;this.currentTokenRequestId=null;let g=this.waitingForTokenRequest;return(this.waitingForTokenRequest=null,f)?null==g||g.rejectAll(f):null==g||g.resolveAll(this.tokenDetails=e),c}_userSetClientId(a){if("string"!=typeof a&&null!==a)throw new V("clientId must be either a string or null",40012,400);if("*"===a)throw new V('Cant use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);{let b=this._uncheckedSetClientId(a);if(b)throw b}}_uncheckedSetClientId(a){if(!this._tokenClientIdMismatch(a))return this.clientId=this.tokenParams.clientId=a,null;{let b="Unexpected clientId mismatch: client has "+this.clientId+", requested "+a,c=new V(b,40102,401);return Q.logAction(this.logger,Q.LOG_ERROR,"Auth._uncheckedSetClientId()",b),c}}_tokenClientIdMismatch(a){return!!(this.clientId&&"*"!==this.clientId&&a&&"*"!==a&&this.clientId!==a)}static isTokenErr(a){return a.code&&a.code>=40140&&a.code<40150}revokeTokens(a,b){return this.client.rest.revokeTokens(a,b)}async _getTimestamp(a){return this.client.getTimestamp(a||!!this.authOptions.queryTime)}};function a8(a){let b=[];if(a)for(let c in a)b.push(c+"="+a[c]);return b.join("&")}function a9(a,b){return a+(b?"?":"")+a8(b)}var ba=class{constructor(a){this.client=a,this.platformHttp=new M.Http(a),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var a,b;return null!=(b=null==(a=this.client)?void 0:a.logger)?b:Q.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(a){let b=a.connection,c=b&&b.connectionManager.host;return c?[c].concat(aQ.getFallbackHosts(a.options)):aQ.getHosts(a.options)}async do(a,b,c,d,e){try{let f=this.client;if(!f)return{error:new V("http.do called without client",5e4,500)};let g="function"==typeof b?b:function(a){return f.baseUri(a)+b},h=f._currentFallback;if(h)if(h.validUntil>Date.now()){let i=await this.doUri(a,g(h.host),c,d,e);if(i.error&&this.platformHttp.shouldFallback(i.error))return f._currentFallback=null,this.do(a,b,c,d,e);return i}else f._currentFallback=null;let i=this._getHosts(f);if(1===i.length)return this.doUri(a,g(i[0]),c,d,e);let j=null,k=async(b,h)=>{let i=b.shift();j=null!=j?j:new Date;let l=await this.doUri(a,g(i),c,d,e);return l.error&&this.platformHttp.shouldFallback(l.error)&&b.length?Date.now()-j.getTime()>f.options.timeouts.httpMaxRetryDuration?{error:new V(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${f.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)}:k(b,!0):(h&&(f._currentFallback={host:i,validUntil:Date.now()+f.options.timeouts.fallbackRetryTimeout}),l)};return k(i)}catch(a){return{error:new V(`Unexpected error in Http.do: ${at(a)}`,500,5e4)}}}async doUri(a,b,c,d,e){try{var f,g;(f=this.logger).shouldLog(Q.LOG_MICRO)&&Q.logActionNoStrip(f,Q.LOG_MICRO,"Http."+a+"()","Sending; "+a9(b,e)+"; Body"+(M.BufferUtils.isBuffer(d)?" (Base64): "+M.BufferUtils.base64Encode(d):": "+d));let h=await this.platformHttp.doUri(a,b,c,d,e);return this.logger.shouldLog(Q.LOG_MICRO)&&(g=this.logger,h.error?Q.logActionNoStrip(g,Q.LOG_MICRO,"Http."+a+"()","Received Error; "+a9(b,e)+"; Error: "+at(h.error)):Q.logActionNoStrip(g,Q.LOG_MICRO,"Http."+a+"()","Received; "+a9(b,e)+"; Headers: "+a8(h.headers)+"; StatusCode: "+h.statusCode+"; Body"+(M.BufferUtils.isBuffer(h.body)?" (Base64): "+M.BufferUtils.base64Encode(h.body):": "+h.body))),h}catch(a){return{error:new V(`Unexpected error in Http.doUri: ${at(a)}`,500,5e4)}}}};function bb(a,b,c){let d,e,f;for(let g=0;g<a.length;g++)if(d=a[g],c&&(d=d[c]),Array.isArray(d)){for(;-1!==(e=d.indexOf(b));)d.splice(e,1);c&&0===d.length&&delete a[g][c]}else if($(d))for(f in d)Object.prototype.hasOwnProperty.call(d,f)&&Array.isArray(d[f])&&bb([d],b,f)}var bc=class{constructor(a){this.logger=a,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...a){if(1===a.length){let b=a[0];if("function"==typeof b)this.any.push(b);else throw Error("EventListener.on(): Invalid arguments: "+M.Config.inspect(a))}if(2===a.length){let[b,c]=a;if("function"!=typeof c)throw Error("EventListener.on(): Invalid arguments: "+M.Config.inspect(a));if(aa(b))this.any.push(c);else if(Array.isArray(b))b.forEach(a=>{this.on(a,c)});else{if("string"!=typeof b)throw Error("EventListener.on(): Invalid arguments: "+M.Config.inspect(a));(this.events[b]||(this.events[b]=[])).push(c)}}}off(...a){if(0==a.length||aa(a[0])&&aa(a[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}let[b,c]=a,d=null,e=null;if(1!==a.length&&c){if("function"!=typeof c)throw Error("EventEmitter.off(): invalid arguments:"+M.Config.inspect(a));[e,d]=[b,c]}else"function"==typeof b?d=b:e=b;if(d&&aa(e))return void bb([this.any,this.events,this.anyOnce,this.eventsOnce],d);if(Array.isArray(e))return void e.forEach(a=>{this.off(a,d)});if("string"!=typeof e)throw Error("EventEmitter.off(): invalid arguments:"+M.Config.inspect(a));d?bb([this.events,this.eventsOnce],d,e):(delete this.events[e],delete this.eventsOnce[e])}listeners(a){if(a){let b=this.events[a]||[];return this.eventsOnce[a]&&Array.prototype.push.apply(b,this.eventsOnce[a]),b.length?b:null}return this.any.length?this.any:null}emit(a,...b){let c={event:a},d=[];this.anyOnce.length&&(Array.prototype.push.apply(d,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(d,this.any);let e=this.eventsOnce[a];e&&(Array.prototype.push.apply(d,e),delete this.eventsOnce[a]);let f=this.events[a];f&&Array.prototype.push.apply(d,f),d.forEach(a=>{var d=this.logger;try{a.apply(c,b)}catch(a){Q.logAction(d,Q.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+a+"; stack = "+(a&&a.stack))}})}once(...a){let b=a.length;if(0===b||1===b&&"function"!=typeof a[0]){let b=a[0];return new Promise(a=>{this.once(b,a)})}let[c,d]=a;if(1===a.length&&"function"==typeof c)this.anyOnce.push(c);else if(aa(c)){if("function"!=typeof d)throw Error("EventEmitter.once(): Invalid arguments:"+M.Config.inspect(a));this.anyOnce.push(d)}else if(Array.isArray(c)){let b=this,e=function(){let f=Array.prototype.slice.call(arguments);if(c.forEach(function(a){b.off(a,e)}),"function"!=typeof d)throw Error("EventEmitter.once(): Invalid arguments:"+M.Config.inspect(a));d.apply(this,f)};c.forEach(function(a){b.on(a,e)})}else{if("string"!=typeof c)throw Error("EventEmitter.once(): Invalid arguments:"+M.Config.inspect(a));let b=this.eventsOnce[c]||(this.eventsOnce[c]=[]);if(d){if("function"!=typeof d)throw Error("EventEmitter.once(): Invalid arguments:"+M.Config.inspect(a));b.push(d)}}}async whenState(a,b){if("string"!=typeof a||"string"!=typeof b)throw Error("whenState requires a valid state String argument");return a===b?null:this.once(a)}},bd={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18,OBJECT:19,OBJECT_SYNC:20,ANNOTATION:21},be=[];Object.keys(bd).forEach(function(a){be[bd[a]]=a});var bf={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,HAS_OBJECTS:128,PRESENCE:65536,PUBLISH:131072,SUBSCRIBE:262144,PRESENCE_SUBSCRIBE:524288,ANNOTATION_PUBLISH:2097152,ANNOTATION_SUBSCRIBE:4194304,OBJECT_SUBSCRIBE:0x1000000,OBJECT_PUBLISH:0x2000000},bg=Object.keys(bf);bf.MODE_ALL=bf.PRESENCE|bf.PUBLISH|bf.SUBSCRIBE|bf.PRESENCE_SUBSCRIBE|bf.ANNOTATION_PUBLISH|bf.ANNOTATION_SUBSCRIBE|bf.OBJECT_SUBSCRIBE|bf.OBJECT_PUBLISH;var bh=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE","ANNOTATION_PUBLISH","ANNOTATION_SUBSCRIBE","OBJECT_SUBSCRIBE","OBJECT_PUBLISH"];function bi(a,b,c){if(c&&c.cipher){a||aN("Crypto");let d=a.getCipher(c.cipher,b);return{cipher:d.cipherParams,channelCipher:d.cipher}}return null!=c?c:{}}async function bj(a,b){let{data:c,encoding:d}=await bk(a.data,a.encoding,b);return a.data=c,a.encoding=d,a}async function bk(a,b,c){let d=c.channelCipher,e=a,f=b?b+"/":"";return M.BufferUtils.isBuffer(e)||(e=M.BufferUtils.utf8Encode(String(e)),f+="utf-8/"),{data:await d.encrypt(e),encoding:f=f+"cipher+"+d.algorithm}}async function bl(a,b){let{data:c,encoding:d}=bm(a.data,a.encoding);return(a.data=c,a.encoding=d,null!=b&&b.cipher)?bj(a,b):a}function bm(a,b){if("string"==typeof a||M.BufferUtils.isBuffer(a)||null==a)return{data:a,encoding:b};if($(a)||Array.isArray(a))return{data:JSON.stringify(a),encoding:b?b+"/json":"json"};throw new V("Data type is unsupported",40013,400)}async function bn(a,b){let{data:c,encoding:d,error:e}=await bo(a.data,a.encoding,b);if(a.data=c,a.encoding=d,e)throw e}async function bo(a,b,c){let d,e=c&&c.channelOptions?c:{channelOptions:c,plugins:{},baseEncodedPreviousPayload:void 0},f=a,g=a,h=b;if(b){let a,c=b.split("/"),i=c.length,j="";try{for(;(a=i)>0;){let b=c[--i].match(/([-\w]+)(\+([\w-]+))?/);if(!b)break;switch(j=b[1]){case"base64":g=M.BufferUtils.base64Decode(String(g)),a==c.length&&(f=g);continue;case"utf-8":g=M.BufferUtils.utf8Decode(g);continue;case"json":g=JSON.parse(g);continue;case"cipher":if(null!=e.channelOptions&&e.channelOptions.cipher&&e.channelOptions.channelCipher){let a=b[3],c=e.channelOptions.channelCipher;if(a!=c.algorithm)throw Error("Unable to decrypt message with given cipher; incompatible cipher params");g=await c.decrypt(g);continue}throw Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!e.plugins||!e.plugins.vcdiff)throw new V("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if("undefined"==typeof Uint8Array)throw new V("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let a=e.baseEncodedPreviousPayload;"string"==typeof a&&(a=M.BufferUtils.utf8Encode(a));let b=M.BufferUtils.toBuffer(a);g=M.BufferUtils.toBuffer(g),f=g=M.BufferUtils.arrayBufferViewToBuffer(e.plugins.vcdiff.decode(g,b))}catch(a){throw new V("Vcdiff delta decode failed with "+a,40018,400)}continue;default:throw Error("Unknown encoding")}}}catch(a){d=new V(`Error processing the ${j} encoding, decoder returned \u2018${a.message}\u2019`,a.code||40013,400)}finally{h=a<=0?null:c.slice(0,a).join("/")}}return d?{error:d,data:g,encoding:h}:(e.baseEncodedPreviousPayload=f,{data:g,encoding:h})}function bp(...a){let b=a.length>0?"json":"msgpack",{data:c,encoding:d}=bq(this.data,this.encoding,b);return Object.assign({},this,{encoding:d,data:c})}function bq(a,b,c){return a&&M.BufferUtils.isBuffer(a)?"msgpack"===c?{data:M.BufferUtils.toBuffer(a),encoding:b}:{data:M.BufferUtils.base64Encode(a),encoding:b?b+"/base64":"base64"}:{data:a,encoding:b}}var br={encryptData:bk,encodeData:bm,encodeDataForWire:bq,decodeData:bo};function bs(a){let b,{id:c,connectionId:d,timestamp:e}=a;switch(a.action){case bd.MESSAGE:b=a.messages;break;case bd.PRESENCE:case bd.SYNC:b=a.presence;break;case bd.ANNOTATION:b=a.annotations;break;case bd.OBJECT:case bd.OBJECT_SYNC:b=a.state;break;default:throw new V("Unexpected action "+a.action,4e4,400)}for(let a=0;a<b.length;a++){let f=b[a];f.connectionId||(f.connectionId=d),f.timestamp||(f.timestamp=e),c&&!f.id&&(f.id=c+":"+a)}}function bt(a,b){let c="["+b;for(let b in a)"data"===b?"string"==typeof a.data?c+="; data="+a.data:M.BufferUtils.isBuffer(a.data)?c+="; data (buffer)="+M.BufferUtils.base64Encode(a.data):void 0!==a.data&&(c+="; data (json)="+JSON.stringify(a.data)):b&&("extras"===b||"operation"===b)?c+="; "+b+"="+JSON.stringify(a[b]):"version"===b?c+="; version="+JSON.stringify(a[b]):"annotations"===b?c+="; annotations="+JSON.stringify(a[b]):void 0!==a[b]&&(c+="; "+b+"="+a[b]);return c+"]"}var bu=class{},bv=class{constructor(a){var b,c,d,e,f,g,h,i,j,k;this.Platform=M,this.ErrorInfo=V,this.Logger=Q,this.Defaults=aQ,this.Utils=R,this.EventEmitter=bc,this.MessageEncoding=br,this._additionalHTTPRequestImplementations=null!=(b=a.plugins)?b:null,this.logger=new Q,this.logger.setLog(a.logLevel,a.logHandler),Q.logAction(this.logger,Q.LOG_MICRO,"BaseClient()","initialized with clientOptions "+M.Config.inspect(a)),this._MsgPack=null!=(d=null==(c=a.plugins)?void 0:c.MsgPack)?d:null;let l=this.options=aQ.normaliseOptions(a,this._MsgPack,this.logger);if(l.key){let a=l.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!a){let a="invalid key parameter";throw Q.logAction(this.logger,Q.LOG_ERROR,"BaseClient()",a),new V(a,40400,404)}l.keyName=a[1],l.keySecret=a[2]}if("clientId"in l){if("string"!=typeof l.clientId&&null!==l.clientId)throw new V("clientId must be either a string or null",40012,400);else if("*"===l.clientId)throw new V('Cant use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}Q.logAction(this.logger,Q.LOG_MINOR,"BaseClient()","started; version = "+aQ.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new ba(this),this.auth=new a7(this,l),this._rest=(null==(e=a.plugins)?void 0:e.Rest)?new a.plugins.Rest(this):null,this._Crypto=null!=(g=null==(f=a.plugins)?void 0:f.Crypto)?g:null,this.__FilteredSubscriptions=null!=(i=null==(h=a.plugins)?void 0:h.MessageInteractions)?i:null,this._Annotations=null!=(k=null==(j=a.plugins)?void 0:j.Annotations)?k:null}get rest(){return this._rest||aN("Rest"),this._rest}get _FilteredSubscriptions(){return this.__FilteredSubscriptions||aN("MessageInteractions"),this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}device(){var a;return(null==(a=this.options.plugins)?void 0:a.Push)&&this.push.LocalDevice||aN("Push"),this._device||(this._device=this.push.LocalDevice.load(this)),this._device}baseUri(a){return aQ.getHttpScheme(this.options)+a+":"+aQ.getPort(this.options,!1)}async stats(a){return this.rest.stats(a)}async time(a){return this.rest.time(a)}async request(a,b,c,d,e,f){return this.rest.request(a,b,c,d,e,f)}batchPublish(a){return this.rest.batchPublish(a)}batchPresence(a){return this.rest.batchPresence(a)}setLog(a){this.logger.setLog(a.level,a.handler)}async getTimestamp(a){return!this.isTimeOffsetSet()&&a?this.time():this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.serverTimeOffset||0)}isTimeOffsetSet(){return null!==this.serverTimeOffset}};bv.Platform=M;var bw=bv,bx=class a{toJSON(){var a,b,c;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:null==(a=this.push)?void 0:a.recipient,state:null==(b=this.push)?void 0:b.state,error:null==(c=this.push)?void 0:c.error}}}toString(){var a,b,c,d;let e="[DeviceDetails";return this.id&&(e+="; id="+this.id),this.platform&&(e+="; platform="+this.platform),this.formFactor&&(e+="; formFactor="+this.formFactor),this.clientId&&(e+="; clientId="+this.clientId),this.metadata&&(e+="; metadata="+this.metadata),this.deviceIdentityToken&&(e+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),(null==(a=this.push)?void 0:a.recipient)&&(e+="; push.recipient="+JSON.stringify(this.push.recipient)),(null==(b=this.push)?void 0:b.state)&&(e+="; push.state="+this.push.state),(null==(c=this.push)?void 0:c.error)&&(e+="; push.error="+JSON.stringify(this.push.error)),(null==(d=this.push)?void 0:d.metadata)&&(e+="; push.metadata="+this.push.metadata),e+="]"}static toRequestBody(a,b,c){return aB(a,b,c)}static fromResponseBody(b,c,d){return(d&&(b=aA(b,c,d)),Array.isArray(b))?a.fromValuesArray(b):a.fromValues(b)}static fromValues(b){return b.error=b.error&&V.fromValues(b.error),Object.assign(new a,b)}static fromLocalDevice(b){return Object.assign(new a,b)}static fromValuesArray(b){let c=b.length,d=Array(c);for(let e=0;e<c;e++)d[e]=a.fromValues(b[e]);return d}};async function by(a,b,c,d){return a.http.supportsAuthHeaders?d(X(await a.auth.getAuthHeaders(),b),c):d(b,X(await a.auth.getAuthParams(),c))}var bz=class a{static async get(b,c,d,e,f,g){return a.do(a0.Get,b,c,null,d,e,f,null!=g&&g)}static async delete(b,c,d,e,f,g){return a.do(a0.Delete,b,c,null,d,e,f,g)}static async post(b,c,d,e,f,g,h){return a.do(a0.Post,b,c,d,e,f,g,h)}static async patch(b,c,d,e,f,g,h){return a.do(a0.Patch,b,c,d,e,f,g,h)}static async put(b,c,d,e,f,g,h){return a.do(a0.Put,b,c,d,e,f,g,h)}static async do(a,b,c,d,e,f,g,h){var i,j;g&&((f=f||{}).envelope=g);let k=b.logger;async function l(e,f){var g;if(k.shouldLog(Q.LOG_MICRO)){let h=d;if((null==(g=e["content-type"])?void 0:g.indexOf("msgpack"))>0)try{b._MsgPack||aN("MsgPack"),h=b._MsgPack.decode(d)}catch(b){Q.logAction(k,Q.LOG_MICRO,"Resource."+a+"()","Sending MsgPack Decoding Error: "+at(b))}Q.logAction(k,Q.LOG_MICRO,"Resource."+a+"()","Sending; "+a9(c,f)+"; Body: "+h)}let h=await b.http.do(a,c,e,d,f);return h.error&&a7.isTokenErr(h.error)?(await b.auth.authorize(null,null),by(b,e,f,l)):{err:h.error,body:h.body,headers:h.headers,unpacked:h.unpacked,statusCode:h.statusCode}}let m=await by(b,e,f,l);if(g&&(m=function(a,b,c){if(a.err&&!a.body)return{err:a.err};if(a.statusCode===a1.NoContent)return y(x({},a),{body:[],unpacked:!0});let d=a.body;if(!a.unpacked)try{d=aA(d,b,c)}catch(a){if(as(a))return{err:a};return{err:new W(at(a),null)}}if(!d)return{err:new W("unenvelope(): Response body is missing",null)};let{statusCode:e,response:f,headers:g}=d;if(void 0===e)return y(x({},a),{body:d,unpacked:!0});if(e<200||e>=300){let b=f&&f.error||a.err;return b||((b=Error("Error in unenveloping "+d)).statusCode=e),{err:b,body:f,headers:g,unpacked:!0,statusCode:e}}return{err:a.err,body:f,headers:g,unpacked:!0,statusCode:e}}(m,b._MsgPack,g)),k.shouldLog(Q.LOG_MICRO)&&(i=m,j=f,i.err?Q.logAction(k,Q.LOG_MICRO,"Resource."+a+"()","Received Error; "+a9(c,j)+"; Error: "+at(i.err)):Q.logAction(k,Q.LOG_MICRO,"Resource."+a+"()","Received; "+a9(c,j)+"; Headers: "+a8(i.headers)+"; StatusCode: "+i.statusCode+"; Body: "+(M.BufferUtils.isBuffer(i.body)?" (Base64): "+M.BufferUtils.base64Encode(i.body):": "+M.Config.inspect(i.body)))),h)if(m.err)throw m.err;else{let a=x({},m);return delete a.err,a}return m}},bA=class{constructor(a,b,c,d,e,f){this.client=a,this.path=b,this.headers=c,this.envelope=null!=d?d:null,this.bodyHandler=e,this.useHttpPaginatedResponse=f||!1}get logger(){return this.client.logger}async get(a){let b=await bz.get(this.client,this.path,this.headers,a,this.envelope,!1);return this.handlePage(b)}async delete(a){let b=await bz.delete(this.client,this.path,this.headers,a,this.envelope,!1);return this.handlePage(b)}async post(a,b){let c=await bz.post(this.client,this.path,b,this.headers,a,this.envelope,!1);return this.handlePage(c)}async put(a,b){let c=await bz.put(this.client,this.path,b,this.headers,a,this.envelope,!1);return this.handlePage(c)}async patch(a,b){let c=await bz.patch(this.client,this.path,b,this.headers,a,this.envelope,!1);return this.handlePage(c)}async handlePage(a){var b,c;let d,e,f;if(a.err&&(b=a.err,c=a.body,!(this.useHttpPaginatedResponse&&(c||"number"==typeof b.code))))throw Q.logAction(this.logger,Q.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+at(a.err)),a.err;try{d=a.statusCode==a1.NoContent?[]:await this.bodyHandler(a.body,a.headers||{},a.unpacked)}catch(b){throw a.err||b}return(a.headers&&(e=a.headers.Link||a.headers.link)&&(f=function(a){"string"==typeof a&&(a=a.split(","));let b={};for(let c=0;c<a.length;c++){let d=a[c].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(d){let a=function(a){let b=a.match(/^\.\/(\w+)\?(.*)$/);return b&&b[2]&&ar(b[2])}(d[1]);a&&(b[d[2]]=a)}}return b}(e)),this.useHttpPaginatedResponse)?new bC(this,d,a.headers||{},a.statusCode,f,a.err):new bB(this,d,f)}},bB=class{constructor(a,b,c){this.resource=a,this.items=b,this._relParams=c}async first(){if(this.hasFirst())return this.get(this._relParams.first);throw new V("No link to the first page of results",40400,404)}async current(){if(this.hasCurrent())return this.get(this._relParams.current);throw new V("No link to the current page of results",40400,404)}async next(){return this.hasNext()?this.get(this._relParams.next):null}hasFirst(){return null!=this._relParams&&"first"in this._relParams}hasCurrent(){return null!=this._relParams&&"current"in this._relParams}hasNext(){return null!=this._relParams&&"next"in this._relParams}isLast(){return!this.hasNext()}async get(a){let b=this.resource,c=await bz.get(b.client,b.path,b.headers,a,b.envelope,!1);return b.handlePage(c)}},bC=class extends bB{constructor(a,b,c,d,e,f){super(a,b,e),this.statusCode=d,this.success=d<300&&d>=200,this.headers=c,this.errorCode=f&&f.code,this.errorMessage=f&&f.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},bD=class a{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let a="[PushChannelSubscription";return this.channel&&(a+="; channel="+this.channel),this.deviceId&&(a+="; deviceId="+this.deviceId),this.clientId&&(a+="; clientId="+this.clientId),a+="]"}static fromResponseBody(b,c,d){return(d&&(b=aA(b,c,d)),Array.isArray(b))?a.fromValuesArray(b):a.fromValues(b)}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){let c=b.length,d=Array(c);for(let e=0;e<c;e++)d[e]=a.fromValues(b[e]);return d}};bD.toRequestBody=aB;var bE=class{constructor(a){var b;this.client=a,this.admin=new bF(a),M.Config.push&&(null==(b=a.options.plugins)?void 0:b.Push)&&(this.stateMachine=new a.options.plugins.Push.ActivationStateMachine(a),this.LocalDevice=a.options.plugins.Push.localDeviceFactory(bx))}async activate(a,b){await new Promise((c,d)=>{var e;return(null==(e=this.client.options.plugins)?void 0:e.Push)?this.stateMachine?this.stateMachine.activatedCallback?void d(new V("Activation already in progress",4e4,400)):void(this.stateMachine.activatedCallback=a=>{if(a)return void d(a);c()},this.stateMachine.updateFailedCallback=b,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,a))):void d(new V("This platform is not supported as a target of push notifications",4e4,400)):void d(aM("Push"))})}async deactivate(a){await new Promise((b,c)=>{var d;return(null==(d=this.client.options.plugins)?void 0:d.Push)?this.stateMachine?this.stateMachine.deactivatedCallback?void c(new V("Deactivation already in progress",4e4,400)):void(this.stateMachine.deactivatedCallback=a=>{if(a)return void c(a);b()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,a))):void c(new V("This platform is not supported as a target of push notifications",4e4,400)):void c(aM("Push"))})}},bF=class{constructor(a){this.client=a,this.deviceRegistrations=new bG(a),this.channelSubscriptions=new bH(a)}async publish(a,b){let c=this.client,d=c.options.useBinaryProtocol?"msgpack":"json",e=aQ.defaultPostHeaders(c.options,{format:d}),f={},g=X({recipient:a},b);X(e,c.options.headers),c.options.pushFullWait&&X(f,{fullWait:"true"});let h=aB(g,c._MsgPack,d);await bz.post(c,"/push/publish",h,e,f,null,!0)}},bG=class{constructor(a){this.client=a}async save(a){let b=this.client,c=bx.fromValues(a),d=b.options.useBinaryProtocol?"msgpack":"json",e=aQ.defaultPostHeaders(b.options,{format:d}),f={};X(e,b.options.headers),b.options.pushFullWait&&X(f,{fullWait:"true"});let g=aB(c,b._MsgPack,d),h=await bz.put(b,"/push/deviceRegistrations/"+encodeURIComponent(a.id),g,e,f,null,!0);return bx.fromResponseBody(h.body,b._MsgPack,h.unpacked?void 0:d)}async get(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=aQ.defaultGetHeaders(b.options,{format:c}),e=a.id||a;if("string"!=typeof e||!e.length)throw new V("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400);X(d,b.options.headers);let f=await bz.get(b,"/push/deviceRegistrations/"+encodeURIComponent(e),d,{},null,!0);return bx.fromResponseBody(f.body,b._MsgPack,f.unpacked?void 0:c)}async list(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=this.client.http.supportsLinkHeaders?void 0:c,e=aQ.defaultGetHeaders(b.options,{format:c});return X(e,b.options.headers),new bA(b,"/push/deviceRegistrations",e,d,async function(a,d,e){return bx.fromResponseBody(a,b._MsgPack,e?void 0:c)}).get(a)}async remove(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=aQ.defaultGetHeaders(b.options,{format:c}),e={},f=a.id||a;if("string"!=typeof f||!f.length)throw new V("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400);X(d,b.options.headers),b.options.pushFullWait&&X(e,{fullWait:"true"}),await bz.delete(b,"/push/deviceRegistrations/"+encodeURIComponent(f),d,e,null,!0)}async removeWhere(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=aQ.defaultGetHeaders(b.options,{format:c});X(d,b.options.headers),b.options.pushFullWait&&X(a,{fullWait:"true"}),await bz.delete(b,"/push/deviceRegistrations",d,a,null,!0)}},bH=class a{constructor(b){this.remove=a.prototype.removeWhere,this.client=b}async save(a){let b=this.client,c=bD.fromValues(a),d=b.options.useBinaryProtocol?"msgpack":"json",e=aQ.defaultPostHeaders(b.options,{format:d}),f={};X(e,b.options.headers),b.options.pushFullWait&&X(f,{fullWait:"true"});let g=aB(c,b._MsgPack,d),h=await bz.post(b,"/push/channelSubscriptions",g,e,f,null,!0);return bD.fromResponseBody(h.body,b._MsgPack,h.unpacked?void 0:d)}async list(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=this.client.http.supportsLinkHeaders?void 0:c,e=aQ.defaultGetHeaders(b.options,{format:c});return X(e,b.options.headers),new bA(b,"/push/channelSubscriptions",e,d,async function(a,d,e){return bD.fromResponseBody(a,b._MsgPack,e?void 0:c)}).get(a)}async removeWhere(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=aQ.defaultGetHeaders(b.options,{format:c});X(d,b.options.headers),b.options.pushFullWait&&X(a,{fullWait:"true"}),await bz.delete(b,"/push/channelSubscriptions",d,a,null,!0)}async listChannels(a){let b=this.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=this.client.http.supportsLinkHeaders?void 0:c,e=aQ.defaultGetHeaders(b.options,{format:c});return X(e,b.options.headers),b.options.pushFullWait&&X(a,{fullWait:"true"}),new bA(b,"/push/channels",e,d,async function(a,d,e){let f=!e&&c?aA(a,b._MsgPack,c):a;for(let a=0;a<f.length;a++)f[a]=String(f[a]);return f}).get(a)}},bI=["absent","present","enter","leave","update"];async function bJ(a,b,c,d){let e=bi(b,a,null!=d?d:null);return bO.fromValues(c).decode(e,a)}async function bK(a,b,c,d){return Promise.all(c.map(function(c){return bJ(a,b,c,d)}))}async function bL(a,b){return bO.fromValues(a).decode(b.channelOptions,b.logger)}async function bM(a,b){return Promise.all(a.map(function(a){return bL(a,b)}))}var bN=class a extends bu{isSynthesized(){return!this.id||!this.connectionId||this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw Error("parseId(): Presence message does not contain an id");let a=this.id.split(":");return{connectionId:a[0],msgSerial:parseInt(a[1],10),index:parseInt(a[2],10)}}async encode(a){return bl(Object.assign(new bO,this,{action:bI.indexOf(this.action||"present")}),a)}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){return b.map(b=>a.fromValues(b))}static fromData(b){return b instanceof a?b:a.fromValues({data:b})}toString(){return bt(this,"PresenceMessage")}},bO=class a extends bu{toJSON(...a){return bp.call(this,...a)}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){return b.map(b=>a.fromValues(b))}async decode(a,b){let c=Object.assign(new bN,y(x({},this),{action:bI[this.action]}));try{await bn(c,a)}catch(a){Q.logAction(b,Q.LOG_ERROR,"WirePresenceMessage.decode()",at(a))}return c}toString(){return bt(this,"WirePresenceMessage")}},bP=bN,bQ=class{constructor(a){this.channel=a}get logger(){return this.channel.logger}async get(a){Q.logAction(this.logger,Q.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);let b=this.channel.client,c=b.options.useBinaryProtocol?"msgpack":"json",d=this.channel.client.http.supportsLinkHeaders?void 0:c,e=aQ.defaultGetHeaders(b.options,{format:c});return X(e,b.options.headers),new bA(b,this.channel.client.rest.presenceMixin.basePath(this),e,d,async(a,d,e)=>bM(e?a:aA(a,b._MsgPack,c),this.channel)).get(a)}async history(a){return Q.logAction(this.logger,Q.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,a)}},bR=["message.create","message.update","message.delete","meta","message.summary"];async function bS(a,b,c,d){let e=bi(b,a,null!=d?d:null);return bZ.fromValues(c).decode(e,a)}async function bT(a,b,c,d){return Promise.all(c.map(function(c){return bS(a,b,c,d)}))}async function bU(a,b){return bZ.fromValues(a).decode(b.channelOptions,b.logger)}async function bV(a,b){return Promise.all(a.map(function(a){return bU(a,b)}))}async function bW(a,b){return Promise.all(a.map(a=>a.encode(b)))}function bX(a){let b,c=0;for(let d=0;d<a.length;d++)c+=(b=a[d]).size||(b.size=function(a){let b=0;return a.name&&(b+=a.name.length),a.clientId&&(b+=a.clientId.length),a.extras&&(b+=JSON.stringify(a.extras).length),a.data&&(b+=av(a.data)),b}(b));return c}var bY=class a extends bu{expandFields(){if(this.version||(this.version={}),!this.version.serial&&this.serial&&(this.version.serial=this.serial),!this.version.timestamp&&this.timestamp&&(this.version.timestamp=this.timestamp),this.annotations?this.annotations.summary||(this.annotations.summary={}):this.annotations={summary:{}},this.annotations&&this.annotations.summary)for(let[a,b]of Object.entries(this.annotations.summary))if(a.endsWith(":distinct.v1")||a.endsWith(":unique.v1")||a.endsWith(":multiple.v1"))for(let[,a]of Object.entries(b))a.clipped||(a.clipped=!1);else a.endsWith(":flag.v1")&&!b.clipped&&(b.clipped=!1)}async encode(a){return bl(Object.assign(new bZ,this,{action:bR.indexOf(this.action||"message.create")}),a)}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){return b.map(b=>a.fromValues(b))}toString(){return bt(this,"Message")}},bZ=class a extends bu{toJSON(...a){return bp.call(this,...a)}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){return b.map(b=>a.fromValues(b))}async decodeWithErr(a,b){let c,d=Object.assign(new bY,y(x({},this),{action:bR[this.action||0]||"unknown"}));try{await bn(d,a)}catch(a){Q.logAction(b,Q.LOG_ERROR,"WireMessage.decode()",at(a)),c=a}return d.expandFields(),{decoded:d,err:c}}async decode(a,b){let{decoded:c}=await this.decodeWithErr(a,b);return c}toString(){return bt(this,"WireMessage")}},b$=bY,b_=class{constructor(a,b,c){var d,e;this._annotations=null,Q.logAction(a.logger,Q.LOG_MINOR,"RestChannel()","started; name = "+b),this.name=b,this.client=a,this.presence=new bQ(this),this.channelOptions=aY(null!=(d=a._Crypto)?d:null,this.logger,c),(null==(e=a.options.plugins)?void 0:e.Push)&&(this._push=new a.options.plugins.Push.PushChannel(this)),a._Annotations&&(this._annotations=new a._Annotations.RestAnnotations(this))}get annotations(){return this._annotations||aN("Annotations"),this._annotations}get push(){return this._push||aN("Push"),this._push}get logger(){return this.client.logger}setOptions(a){var b;this.channelOptions=aY(null!=(b=this.client._Crypto)?b:null,this.logger,a)}async history(a){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,a)}async publish(...a){let b,c,d=a[0],e=a[1];if("string"==typeof d||null===d)b=[b$.fromValues({name:d,data:e})],c=a[2];else if($(d))b=[b$.fromValues(d)],c=a[1];else if(Array.isArray(d))b=b$.fromValuesArray(d),c=a[1];else throw new V("The single-argument form of publish() expects a message object or an array of message objects",40013,400);c||(c={});let f=this.client,g=f.options,h=g.useBinaryProtocol?"msgpack":"json",i=f.options.idempotentRestPublishing,j=aQ.defaultPostHeaders(f.options,{format:h});if(X(j,g.headers),i&&b.every(function(a){return!a.id})){let a=await ax(9);b.forEach(function(b,c){b.id=a+":"+c.toString()})}let k=await bW(b,this.channelOptions),l=bX(k),m=g.maxMessageSize;if(l>m)throw new V(`Maximum size of messages that can be published at once exceeded (was ${l} bytes; limit is ${m} bytes)`,40009,400);await this._publish(aB(k,f._MsgPack,h),j,c)}async _publish(a,b,c){await bz.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",a,b,c,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}},b0=class a{constructor(a){this.entries=a&&a.entries||void 0,this.schema=a&&a.schema||void 0,this.appId=a&&a.appId||void 0,this.inProgress=a&&a.inProgress||void 0,this.unit=a&&a.unit||void 0,this.intervalId=a&&a.intervalId||void 0}static fromValues(b){return new a(b)}},b1=class{static basePath(a){return"/channels/"+encodeURIComponent(a.name)}static history(a,b){let c=a.client,d=c.options.useBinaryProtocol?"msgpack":"json",e=a.client.http.supportsLinkHeaders?void 0:d,f=aQ.defaultGetHeaders(c.options,{format:d});return X(f,c.options.headers),new bA(c,this.basePath(a)+"/messages",f,e,async function(b,e,f){return bV(f?b:aA(b,c._MsgPack,d),a)}).get(b)}static async status(a){let b=a.client.options.useBinaryProtocol?"msgpack":"json",c=aQ.defaultPostHeaders(a.client.options,{format:b});return(await bz.get(a.client,this.basePath(a),c,{},b,!0)).body}},b2=class{static basePath(a){return b1.basePath(a.channel)+"/presence"}static async history(a,b){let c=a.channel.client,d=c.options.useBinaryProtocol?"msgpack":"json",e=a.channel.client.http.supportsLinkHeaders?void 0:d,f=aQ.defaultGetHeaders(c.options,{format:d});return X(f,c.options.headers),new bA(c,this.basePath(a)+"/history",f,e,async(b,e,f)=>bM(f?b:aA(b,c._MsgPack,d),a.channel)).get(b)}},b3=class{constructor(a){this.channelMixin=b1,this.presenceMixin=b2,this.Resource=bz,this.PaginatedResource=bA,this.DeviceDetails=bx,this.PushChannelSubscription=bD,this.client=a,this.channels=new b4(this.client),this.push=new bE(this.client)}async stats(a){let b=aQ.defaultGetHeaders(this.client.options),c=this.client.options.useBinaryProtocol?"msgpack":"json",d=this.client.http.supportsLinkHeaders?void 0:c;return X(b,this.client.options.headers),new bA(this.client,"/stats",b,d,function(a,b,c){let d=c?a:JSON.parse(a);for(let a=0;a<d.length;a++)d[a]=b0.fromValues(d[a]);return d}).get(a)}async time(a){let b=aQ.defaultGetHeaders(this.client.options);this.client.options.headers&&X(b,this.client.options.headers);let c=a=>this.client.baseUri(a)+"/time",{error:d,body:e,unpacked:f}=await this.client.http.do(a0.Get,c,b,null,a);if(d)throw d;f||(e=JSON.parse(e));let g=e[0];if(!g)throw new V("Internal error (unexpected result type from GET /time)",5e4,500);return this.client.serverTimeOffset=g-Date.now(),g}async request(a,b,c,d,e,f){var g;let[h,i,j]=this.client.options.useBinaryProtocol?(this.client._MsgPack||aN("MsgPack"),[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]):[JSON.stringify,JSON.parse,"json"],k=this.client.http.supportsLinkHeaders?void 0:j;d=d||{};let l=a.toLowerCase(),m="get"==l?aQ.defaultGetHeaders(this.client.options,{format:j,protocolVersion:c}):aQ.defaultPostHeaders(this.client.options,{format:j,protocolVersion:c});"string"!=typeof e&&(e=null!=(g=h(e))?g:null),X(m,this.client.options.headers),f&&X(m,f);let n=new bA(this.client,b,m,k,async function(a,b,c){return Z(c?a:i(a))},!0);if(!M.Http.methods.includes(l))throw new V("Unsupported method "+l,40500,405);return M.Http.methodsWithBody.includes(l)?n[l](d,e):n[l](d)}async batchPublish(a){let b,c;Array.isArray(a)?(b=a,c=!1):(b=[a],c=!0);let d=this.client.options.useBinaryProtocol?"msgpack":"json",e=aQ.defaultPostHeaders(this.client.options,{format:d});this.client.options.headers&&X(e,this.client.options.headers);let f=aB(b,this.client._MsgPack,d),g=await bz.post(this.client,"/messages",f,e,{},null,!0),h=g.unpacked?g.body:aA(g.body,this.client._MsgPack,d);return c?h[0]:h}async batchPresence(a){let b=this.client.options.useBinaryProtocol?"msgpack":"json",c=aQ.defaultPostHeaders(this.client.options,{format:b});this.client.options.headers&&X(c,this.client.options.headers);let d=a.join(","),e=await bz.get(this.client,"/presence",c,{channels:d},null,!0);return e.unpacked?e.body:aA(e.body,this.client._MsgPack,b)}async revokeTokens(a,b){if(a5(this.client.options))throw new V("Cannot revoke tokens when using token auth",40162,401);let c=this.client.options.keyName,d=x({targets:a.map(a=>`${a.type}:${a.value}`)},null!=b?b:{}),e=this.client.options.useBinaryProtocol?"msgpack":"json",f=aQ.defaultPostHeaders(this.client.options,{format:e});this.client.options.headers&&X(f,this.client.options.headers);let g=aB(d,this.client._MsgPack,e),h=await bz.post(this.client,`/keys/${c}/revokeTokens`,g,f,{},null,!0);return h.unpacked?h.body:aA(h.body,this.client._MsgPack,e)}},b4=class{constructor(a){this.client=a,this.all=Object.create(null)}get(a,b){a=String(a);let c=this.all[a];return c?b&&c.setOptions(b):this.all[a]=c=new b_(this.client,a,b),c}release(a){delete this.all[String(a)]}},b5=class extends bw{constructor(a){super(aQ.objectifyOptions(a,!1,"BaseRest",Q.defaultLogger,{Rest:b3}))}},b6={Rest:b3},b7=class extends b${static async fromEncoded(a,b){return bS(Q.defaultLogger,M.Crypto,a,b)}static async fromEncodedArray(a,b){return bT(Q.defaultLogger,M.Crypto,a,b)}static fromValues(a){return b$.fromValues(a)}},b8=class extends bP{static async fromEncoded(a,b){return bJ(Q.defaultLogger,M.Crypto,a,b)}static async fromEncodedArray(a,b){return bK(Q.defaultLogger,M.Crypto,a,b)}static fromValues(a){return bP.fromValues(a)}},b9=["annotation.create","annotation.delete"];async function ca(a,b,c){return cf.fromValues(b).decode(c||{},a)}async function cb(a,b,c){return Promise.all(b.map(function(b){return ca(a,b,c)}))}async function cc(a,b){return cf.fromValues(a).decode(b.channelOptions,b.logger)}async function cd(a,b){return Promise.all(a.map(function(a){return cc(a,b)}))}var ce=class a extends bu{async encode(){return bl(Object.assign(new cf,this,{action:b9.indexOf(this.action||"annotation.create")}),{})}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){return b.map(b=>a.fromValues(b))}toString(){return bt(this,"Annotation")}},cf=class a extends bu{toJSON(...a){return bp.call(this,...a)}static fromValues(b){return Object.assign(new a,b)}static fromValuesArray(b){return b.map(b=>a.fromValues(b))}async decode(a,b){let c=Object.assign(new ce,y(x({},this),{action:b9[this.action]}));try{await bn(c,a)}catch(a){Q.logAction(b,Q.LOG_ERROR,"WireAnnotation.decode()",at(a))}return c}toString(){return bt(this,"WireAnnotation")}},cg=ce,ch=class extends cg{static async fromEncoded(a,b){return ca(Q.defaultLogger,a,b)}static async fromEncodedArray(a,b){return cb(Q.defaultLogger,a,b)}static fromValues(a){return cg.fromValues(a)}};function ci(a){let b;switch(typeof a){case"string":b=a;break;case"object":b=a.serial}if(!b||"string"!=typeof b)throw new V("First argument of annotations.publish() must be either a Message (or at least an object with a string `serial` property) or a message serial (string)",40003,400);return b}function cj(a,b){let c=ci(a);if(!b||"object"!=typeof b)throw new V("Second argument of annotations.publish() must be an object (the intended annotation to publish)",40003,400);let d=cg.fromValues(b);return d.messageSerial=c,d.action||(d.action="annotation.create"),d}function ck(a,b){return a.client.rest.channelMixin.basePath(a)+"/messages/"+encodeURIComponent(b)+"/annotations"}var cl=class{constructor(a){this.channel=a}async publish(a,b){let c=cj(a,b),d=await c.encode(),e=this.channel.client,f=e.options.useBinaryProtocol?"msgpack":"json",g=aQ.defaultPostHeaders(e.options,{format:f});X(g,e.options.headers);let h=aB([d],e._MsgPack,f);await bz.post(e,ck(this.channel,c.messageSerial),h,g,{},null,!0)}async delete(a,b){return b.action="annotation.delete",this.publish(a,b)}async get(a,b){let c=this.channel.client,d=ci(a),e=c.options.useBinaryProtocol?"msgpack":"json",f=c.http.supportsLinkHeaders?void 0:e,g=aQ.defaultGetHeaders(c.options,{format:e});return X(g,c.options.headers),new bA(c,ck(this.channel,d),g,f,async(a,b,d)=>cd(d?a:aA(a,c._MsgPack,e),this.channel)).get(b)}};function cm(a){let b=[];if(a)for(let c=0;c<a.length;c++)b.push(a[c].toString());return"[ "+b.join(", ")+" ]"}function cn(a,b,c,d){let e,f,g,h,i;return a.error&&(e=V.fromValues(a.error)),a.messages&&(f=bZ.fromValuesArray(a.messages)),b&&a.presence&&(g=b.WirePresenceMessage.fromValuesArray(a.presence)),c&&a.annotations&&(h=c.WireAnnotation.fromValuesArray(a.annotations)),d&&a.state&&(i=d.WireObjectMessage.fromValuesArray(a.state,R,br)),Object.assign(new cq,y(x({},a),{presence:g,messages:f,annotations:h,state:i,error:e}))}function co(a){return Object.assign(new cq,a)}function cp(a,b,c,d){let e,f="[ProtocolMessage";void 0!==a.action&&(f+="; action="+be[a.action]);let g=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"];for(let b=0;b<g.length;b++)void 0!==a[e=g[b]]&&(f+="; "+e+"="+a[e]);if(a.messages&&(f+="; messages="+cm(bZ.fromValuesArray(a.messages))),a.presence&&b&&(f+="; presence="+cm(b.WirePresenceMessage.fromValuesArray(a.presence))),a.annotations&&c&&(f+="; annotations="+cm(c.WireAnnotation.fromValuesArray(a.annotations))),a.state&&d&&(f+="; state="+cm(d.WireObjectMessage.fromValuesArray(a.state,R,br))),a.error&&(f+="; error="+V.fromValues(a.error).toString()),a.auth&&a.auth.accessToken&&(f+="; token="+a.auth.accessToken),a.flags&&(f+="; flags="+bg.filter(a.hasFlag).join(",")),a.params){let b="";am(a.params,function(c){b.length>0&&(b+="; "),b+=c+"="+a.params[c]}),b.length>0&&(f+="; params=["+b+"]")}return f+"]"}var cq=class{constructor(){this.hasFlag=a=>(this.flags&bf[a])>0}setFlag(a){return this.flags=this.flags|bf[a]}getMode(){return(this.flags||0)&bf.MODE_ALL}encodeModesToFlags(a){a.forEach(a=>this.setFlag(a))}decodeModesFromFlags(){let a=[];return bh.forEach(b=>{this.hasFlag(b)&&a.push(b)}),a.length>0?a:void 0}},cr=class{constructor(a,b,c,d,e){this.previous=a,this.current=b,"attached"===b&&(this.resumed=c,this.hasBacklog=d),e&&(this.reason=e)}},cs=function(){},ct=class a extends bc{constructor(a,b,c){var d,e,f;super(a.logger),this._annotations=null,this._mode=0,this.retryCount=0,this.history=async function(a){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);let b=this.client.rest.channelMixin;if(a&&a.untilAttach){if("attached"!==this.state)throw new V("option untilAttach requires the channel to be attached",4e4,400);if(!this.properties.attachSerial)throw new V("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400);delete a.untilAttach,a.from_serial=this.properties.attachSerial}return b.history(this,a)},this.whenState=a=>bc.prototype.whenState.call(this,a,this.state),Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel()","started; name = "+b),this.name=b,this.channelOptions=aY(null!=(d=a._Crypto)?d:null,this.logger,c),this.client=a,this._presence=a._RealtimePresence?new a._RealtimePresence.RealtimePresence(this):null,a._Annotations&&(this._annotations=new a._Annotations.RealtimeAnnotations(this)),this.connectionManager=a.connection.connectionManager,this.state="initialized",this.subscriptions=new bc(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(c),this.errorReason=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:a.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new bc(this.logger),(null==(e=a.options.plugins)?void 0:e.Push)&&(this._push=new a.options.plugins.Push.PushChannel(this)),(null==(f=a.options.plugins)?void 0:f.Objects)&&(this._objects=new a.options.plugins.Objects.Objects(this))}get presence(){return this._presence||aN("RealtimePresence"),this._presence}get annotations(){return this._annotations||aN("Annotations"),this._annotations}get push(){return this._push||aN("Push"),this._push}get objects(){return this._objects||aN("Objects"),this._objects}invalidStateError(){return new V("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs(a){return"function"==typeof(a=Array.prototype.slice.call(a))[0]&&a.unshift(null),a}async setOptions(a){var b;let c=this.channelOptions,d=function(a){if(a&&"params"in a&&!$(a.params))return new V("options.params must be an object",4e4,400);if(a&&"modes"in a){if(!Array.isArray(a.modes))return new V("options.modes must be an array",4e4,400);for(let b=0;b<a.modes.length;b++){let c=a.modes[b];if(!c||"string"!=typeof c||!bh.includes(String.prototype.toUpperCase.call(c)))return new V("Invalid channel mode: "+c,4e4,400)}}}(a);if(d)throw d;if(this.channelOptions=aY(null!=(b=this.client._Crypto)?b:null,this.logger,a),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(a,c))return this.attachImpl(),new Promise((a,b)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(c){switch(this.event){case"update":case"attached":a();break;default:b(c.reason)}})})}_shouldReattachToSetOptions(a,b){if("attached"!==this.state&&"attaching"!==this.state)return!1;if(null==a?void 0:a.params){let c=cu(a.params),d=cu(b.params);if(Object.keys(c).length!==Object.keys(d).length||!aI(d,c))return!0}return!(null==a||!a.modes||b.modes&&aL(a.modes,b.modes))}async publish(...a){let b;if(1==a.length)if($(a[0]))b=[b$.fromValues(a[0])];else if(Array.isArray(a[0]))b=b$.fromValuesArray(a[0]);else throw new V("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else b=[b$.fromValues({name:a[0],data:a[1]})];let c=this.client.options.maxMessageSize,d=await bW(b,this.channelOptions),e=bX(d);if(e>c)throw new V(`Maximum size of messages that can be published at once exceeded (was ${e} bytes; limit is ${c} bytes)`,40009,400);this.throwIfUnpublishableState(),Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+this.state+", message count = "+d.length);let f=co({action:bd.MESSAGE,channel:this.name,messages:d});return this.sendMessage(f)}throwIfUnpublishableState(){if(!this.connectionManager.activeState())throw this.connectionManager.getError();if("failed"===this.state||"suspended"===this.state)throw this.invalidStateError()}onEvent(a){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.onEvent()","received message");let b=this.subscriptions;for(let c=0;c<a.length;c++){let d=a[c];b.emit(d.name,d)}}async attach(){return"attached"===this.state?null:new Promise((a,b)=>{this._attach(!1,null,(c,d)=>c?b(c):a(d))})}_attach(a,b,c){c||(c=a=>{a&&Q.logAction(this.logger,Q.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+a.toString())});let d=this.connectionManager;if(!d.activeState())return void c(d.getError());("attaching"!==this.state||a)&&this.requestState("attaching",b),this.once(function(a){switch(this.event){case"attached":null==c||c(null,a);break;case"detached":case"suspended":case"failed":null==c||c(a.reason||d.getError()||new V("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":null==c||c(new V("Attach request superseded by a subsequent detach request",9e4,409))}})}attachImpl(){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");let a=co({action:bd.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});this.channelOptions.modes&&a.encodeModesToFlags(aD(this.channelOptions.modes)),this._attachResume&&a.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(a.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(a).catch(cs)}async detach(){let a=this.connectionManager;if(!a.activeState())throw a.getError();switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new V("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((b,c)=>{this.once(function(d){switch(this.event){case"detached":b();break;case"attached":case"suspended":case"failed":c(d.reason||a.getError()||new V("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":c(new V("Detach request superseded by a subsequent attach request",9e4,409))}})})}}detachImpl(){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");let a=co({action:bd.DETACH,channel:this.name});this.sendMessage(a).catch(cs)}async subscribe(...b){let[c,d]=a.processListenerArgs(b);if("failed"===this.state)throw V.fromValues(this.invalidStateError());return(c&&"object"==typeof c&&!Array.isArray(c)?this.client._FilteredSubscriptions.subscribeFilter(this,c,d):this.subscriptions.on(c,d),!1!==this.channelOptions.attachOnSubscribe)?this.attach():null}unsubscribe(...b){var c;let[d,e]=a.processListenerArgs(b);if("object"==typeof d&&!e||(null==(c=this.filteredSubscriptions)?void 0:c.has(e)))return void this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,d,e).forEach(a=>this.subscriptions.off(a));this.subscriptions.off(d,e)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new W("Unable to sync to channel; not attached",4e4)}let a=this.connectionManager;if(!a.activeState())throw a.getError();let b=co({action:bd.SYNC,channel:this.name});this.syncChannelSerial&&(b.channelSerial=this.syncChannelSerial),a.send(b)}async sendMessage(a){return new Promise((b,c)=>{this.connectionManager.send(a,this.client.options.queueMessages,a=>{a?c(a):b()})})}async sendPresence(a){let b=co({action:bd.PRESENCE,channel:this.name,presence:a});return this.sendMessage(b)}sendState(a){let b=co({action:bd.OBJECT,channel:this.name,state:a});return this.sendMessage(b)}async processMessage(a){(a.action===bd.ATTACHED||a.action===bd.MESSAGE||a.action===bd.PRESENCE||a.action===bd.OBJECT||a.action===bd.ANNOTATION)&&this.setChannelSerial(a.channelSerial);let b,c=!1;switch(a.action){case bd.ATTACHED:{this.properties.attachSerial=a.channelSerial,this._mode=a.getMode(),this.params=a.params||{};let b=a.decodeModesFromFlags();this.modes=b&&aC(b)||void 0;let c=a.hasFlag("RESUMED"),d=a.hasFlag("HAS_PRESENCE"),e=a.hasFlag("HAS_BACKLOG"),f=a.hasFlag("HAS_OBJECTS");if("attached"===this.state){!c&&(this._presence&&this._presence.onAttached(d),this._objects&&this._objects.onAttached(f));let b=new cr(this.state,this.state,c,e,a.error);this._allChannelChanges.emit("update",b),(!c||this.channelOptions.updateOnAttached)&&this.emit("update",b)}else"detaching"===this.state?this.checkPendingState():this.notifyState("attached",a.error,c,d,e,f);break}case bd.DETACHED:{let b=a.error?V.fromValues(a.error):new V("Channel detached",90001,404);"detaching"===this.state?this.notifyState("detached",b):"attaching"===this.state?this.notifyState("suspended",b):("attached"===this.state||"suspended"===this.state)&&this.requestState("attaching",b);break}case bd.SYNC:if(c=!0,b=this.syncChannelSerial=a.channelSerial,!a.presence)break;case bd.PRESENCE:{if(!a.presence)break;bs(a);let d=this.channelOptions;if(this._presence){let e=await Promise.all(a.presence.map(a=>a.decode(d,this.logger)));this._presence.setPresence(e,c,b)}break}case bd.OBJECT:case bd.OBJECT_SYNC:{if(!this._objects||!a.state)return;bs(a);let b=this.client.connection.connectionManager.getActiveTransportFormat(),c=a.state.map(a=>a.decode(this.client,b));a.action===bd.OBJECT?this._objects.handleObjectMessages(c):this._objects.handleObjectSyncMessages(c,a.channelSerial);break}case bd.MESSAGE:{if("attached"!==this.state)return void Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+a.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');bs(a);let b=a.messages,c=b[0],d=b[b.length-1];if(c.extras&&c.extras.delta&&c.extras.delta.from!==this._lastPayload.messageId){let b='Delta message decode failure - previous message not available for message "'+a.id+'" on this channel "'+this.name+'".';Q.logAction(this.logger,Q.LOG_ERROR,"RealtimeChannel.processMessage()",b),this._startDecodeFailureRecovery(new V(b,40018,400));break}let e=[];for(let a=0;a<b.length;a++){let{decoded:c,err:d}=await b[a].decodeWithErr(this._decodingContext,this.logger);if(e[a]=c,d)switch(d.code){case 40018:this._startDecodeFailureRecovery(d);return;case 40019:case 40021:this.notifyState("failed",d);return}}this._lastPayload.messageId=d.id,this._lastPayload.protocolMessageChannelSerial=a.channelSerial,this.onEvent(e);break}case bd.ANNOTATION:{bs(a);let b=this.channelOptions;if(this._annotations){let c=await Promise.all((a.annotations||[]).map(a=>a.decode(b,this.logger)));this._annotations._processIncoming(c)}break}case bd.ERROR:{let b=a.error;b&&80016==b.code?this.checkPendingState():this.notifyState("failed",V.fromValues(b));break}default:Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+a.action+")")}}_startDecodeFailureRecovery(a){this._lastPayload.decodeFailureRecoveryInProgress||(Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,a,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1}))}onAttached(){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState(a,b,c,d,e,f){if(Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+a),this.clearStateTimer(),["detached","suspended","failed"].includes(a)&&(this.properties.channelSerial=null),a===this.state)return;this._presence&&this._presence.actOnChannelState(a,d,b),this._objects&&this._objects.actOnChannelState(a,f),"suspended"===a&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),b&&(this.errorReason=b);let g=new cr(this.state,a,c,e,b),h='Channel state for channel "'+this.name+'"',i=a+(b?"; reason: "+b:"");"failed"===a?Q.logAction(this.logger,Q.LOG_ERROR,h,i):Q.logAction(this.logger,Q.LOG_MAJOR,h,i),"attaching"!==a&&"suspended"!==a&&(this.retryCount=0),"attached"===a&&this.onAttached(),"attached"===a?this._attachResume=!0:("detaching"===a||"failed"===a)&&(this._attachResume=!1),this.state=a,this._allChannelChanges.emit(a,g),this.emit(a,g)}requestState(a,b){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+a),this.notifyState(a,b),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents)return void Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);switch(Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync()}}timeoutPendingState(){switch(this.state){case"attaching":{let a=new V("Channel attach timed out",90007,408);this.notifyState("suspended",a);break}case"detaching":{let a=new V("Channel detach timed out",90007,408);this.notifyState("attached",a);break}default:this.checkPendingState()}}startStateTimerIfNotRunning(){this.stateTimer||(this.stateTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout))}clearStateTimer(){let a=this.stateTimer;a&&(clearTimeout(a),this.stateTimer=null)}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;let a=aG(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{"suspended"===this.state&&this.connectionManager.state.sendEvents&&(this.retryTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching"))},a)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}getReleaseErr(){let a=this.state;return"initialized"===a||"detached"===a||"failed"===a?null:new V("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+a,90001,400)}setChannelSerial(a){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+a+"; previous = "+this.properties.channelSerial),a&&(this.properties.channelSerial=a)}async status(){return this.client.rest.channelMixin.status(this)}};function cu(a){let b=a||{},{agent:c}=b;var d=b,e=["agent"],f={};for(var g in d)u.call(d,g)&&0>e.indexOf(g)&&(f[g]=d[g]);if(null!=d&&s)for(var g of s(d))0>e.indexOf(g)&&v.call(d,g)&&(f[g]=d[g]);return f}var cv=class{constructor(a){this.channel=a,this.logger=a.logger,this.subscriptions=new bc(this.logger)}async publish(a,b){let c=this.channel.name,d=cj(a,b),e=await d.encode();this.channel.throwIfUnpublishableState(),Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeAnnotations.publish()","channelName = "+c+", sending annotation with messageSerial = "+d.messageSerial+", type = "+d.type);let f=co({action:bd.ANNOTATION,channel:c,annotations:[e]});return this.channel.sendMessage(f)}async delete(a,b){return b.action="annotation.delete",this.publish(a,b)}async subscribe(...a){let b=ct.processListenerArgs(a),c=b[0],d=b[1],e=this.channel;if("failed"===e.state)throw V.fromValues(e.invalidStateError());if(this.subscriptions.on(c,d),!1!==this.channel.channelOptions.attachOnSubscribe&&await e.attach(),0===("attached"===this.channel.state&&this.channel._mode&bf.ANNOTATION_SUBSCRIBE))throw new V("You are trying to add an annotation listener, but you haven't requested the annotation_subscribe channel mode in ChannelOptions, so this won't do anything (we only deliver annotations to clients who have explicitly requested them)",93001,400)}unsubscribe(...a){let b=ct.processListenerArgs(a),c=b[0],d=b[1];this.subscriptions.off(c,d)}_processIncoming(a){for(let b of a)this.subscriptions.emit(b.type||"",b)}async get(a,b){return cl.prototype.get.call(this,a,b)}},cw=class a extends b5{constructor(b){var c,d;if(!a._MsgPack)throw Error("Expected DefaultRest._MsgPack to have been set");super(aQ.objectifyOptions(b,!0,"Rest",Q.defaultLogger,y(x({},b6),{Crypto:null!=(c=a.Crypto)?c:void 0,MsgPack:null!=(d=a._MsgPack)?d:void 0,Annotations:{Annotation:cg,WireAnnotation:cf,RealtimeAnnotations:cv,RestAnnotations:cl}})))}static get Crypto(){if(null===this._Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(a){this._Crypto=a}};cw._Crypto=null,cw.Message=b7,cw.PresenceMessage=b8,cw.Annotation=ch,cw._MsgPack=null,cw._Http=ba;var cx=class extends bc{constructor(a){super(a),this.messages=[]}count(){return this.messages.length}push(a){this.messages.push(a)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(a){this.messages.push.apply(this.messages,a)}prepend(a){this.messages.unshift.apply(this.messages,a)}completeMessages(a,b,c){Q.logAction(this.logger,Q.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+a+"; count = "+b),c=c||null;let d=this.messages;if(0===d.length)throw Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");let e=d[0];if(e){let f=e.message.msgSerial,g=a+b;if(g>f)for(let a of d.splice(0,g-f))a.callback(c);0==d.length&&this.emit("idle")}}completeAllMessages(a){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,a)}resetSendAttempted(){for(let a of this.messages)a.sendAttempted=!1}clear(){Q.logAction(this.logger,Q.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},cy=class{constructor(a,b){this.message=a,this.callback=b,this.merged=!1;let c=a.action;this.sendAttempted=!1,this.ackRequired="number"==typeof c&&[bd.MESSAGE,bd.PRESENCE,bd.ANNOTATION,bd.OBJECT].includes(c)}},cz=class extends bc{constructor(a){super(a.logger),this.transport=a,this.messageQueue=new cx(this.logger),a.on("ack",(a,b)=>{this.onAck(a,b)}),a.on("nack",(a,b,c)=>{this.onNack(a,b,c)})}onAck(a,b){Q.logAction(this.logger,Q.LOG_MICRO,"Protocol.onAck()","serial = "+a+"; count = "+b),this.messageQueue.completeMessages(a,b)}onNack(a,b,c){Q.logAction(this.logger,Q.LOG_ERROR,"Protocol.onNack()","serial = "+a+"; count = "+b+"; err = "+at(c)),c||(c=new V("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages(a,b,c)}onceIdle(a){let b=this.messageQueue;if(0===b.count())return void a();b.once("idle",a)}send(a){a.ackRequired&&this.messageQueue.push(a),this.logger.shouldLog(Q.LOG_MICRO)&&Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Protocol.send()","sending msg; "+cp(a.message,this.transport.connectionManager.realtime._RealtimePresence,this.transport.connectionManager.realtime._Annotations,this.transport.connectionManager.realtime._objectsPlugin)),a.sendAttempted=!0,this.transport.send(a.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){let a=this.transport;this.onceIdle(function(){a.disconnect()})}},cA=class{constructor(a,b,c,d){this.previous=a,this.current=b,c&&(this.retryIn=c),d&&(this.reason=d)}},cB={DISCONNECTED:80003,SUSPENDED:80002,FAILED:8e4,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},cC={disconnected:()=>V.fromValues({statusCode:400,code:cB.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>V.fromValues({statusCode:400,code:cB.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>V.fromValues({statusCode:400,code:cB.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>V.fromValues({statusCode:400,code:cB.CLOSING,message:"Connection closing"}),closed:()=>V.fromValues({statusCode:400,code:cB.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>V.fromValues({statusCode:500,code:cB.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>V.fromValues({statusCode:500,code:cB.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})},cD=co({action:bd.CLOSE}),cE=co({action:bd.DISCONNECT}),cF=class extends bc{constructor(a,b,c,d){super(a.logger),d&&(c.format=void 0,c.heartbeats=!0),this.connectionManager=a,this.auth=b,this.params=c,this.timeouts=c.options.timeouts,this.format=c.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){this.isConnected&&this.requestClose(),this.finish("closed",cC.closed())}disconnect(a){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",a||cC.disconnected())}fail(a){this.isConnected&&this.requestDisconnect(),this.finish("failed",a||cC.failed())}finish(a,b){var c;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout(null!=(c=this.idleTimer)?c:void 0),this.idleTimer=null,this.emit(a,b),this.dispose())}onProtocolMessage(a){switch(this.logger.shouldLog(Q.LOG_MICRO)&&Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+cp(a,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),a.action){case bd.HEARTBEAT:Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",a.id);break;case bd.CONNECTED:this.onConnect(a),this.emit("connected",a.error,a.connectionId,a.connectionDetails,a);break;case bd.CLOSED:this.onClose(a);break;case bd.DISCONNECTED:this.onDisconnect(a);break;case bd.ACK:this.emit("ack",a.msgSerial,a.count);break;case bd.NACK:this.emit("nack",a.msgSerial,a.count,a.error);break;case bd.SYNC:this.connectionManager.onChannelMessage(a,this);break;case bd.ACTIVATE:break;case bd.AUTH:az(this.auth.authorize(),a=>{a&&Q.logAction(this.logger,Q.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+at(a))});break;case bd.ERROR:if(Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+M.Config.inspect(a.error)+(a.channel?", channel: "+a.channel:"")),void 0===a.channel){this.onFatalError(a);break}this.connectionManager.onChannelMessage(a,this);break;default:this.connectionManager.onChannelMessage(a,this)}}onConnect(a){if(this.isConnected=!0,!a.connectionDetails)throw Error("Transport.onConnect(): Connect message recieved without connectionDetails");let b=a.connectionDetails.maxIdleInterval;b&&(this.maxIdleInterval=b+this.timeouts.realtimeRequestTimeout,this.onActivity())}onDisconnect(a){let b=a&&a.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onDisconnect()","err = "+at(b)),this.finish("disconnected",b)}onFatalError(a){let b=a&&a.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onFatalError()","err = "+at(b)),this.finish("failed",b)}onClose(a){let b=a&&a.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onClose()","err = "+at(b)),this.finish("closed",b)}requestClose(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.requestClose()",""),this.send(cD)}requestDisconnect(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(cE)}ping(a){let b={action:bd.HEARTBEAT};a&&(b.id=a),this.send(co(b))}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100))}setIdleTimer(a){this.idleTimer||(this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},a))}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;let a=Date.now()-this.lastActivity,b=this.maxIdleInterval-a;if(b<=0){let b="No activity seen from realtime in "+a+"ms; assuming connection has dropped";Q.logAction(this.logger,Q.LOG_ERROR,"Transport.onIdleTimerExpire()",b),this.disconnect(new V(b,80003,408))}else this.setIdleTimer(b+100)}static tryConnect(a,b,c,d,e){let f,g=new a(b,c,d),h=function(a){clearTimeout(f),e({event:this.event,error:a})};return f=setTimeout(()=>{g.off(["preconnect","disconnected","failed"]),g.dispose(),h.call({event:"disconnected"},new V("Timeout waiting for transport to indicate itself viable",5e4,500))},b.options.timeouts.realtimeRequestTimeout),g.on(["failed","disconnected"],h),g.on("preconnect",function(){Q.logAction(b.logger,Q.LOG_MINOR,"Transport.tryConnect()","viable transport "+g),clearTimeout(f),g.off(["failed","disconnected"],h),e(null,g)}),g.connect(),g}static isAvailable(){throw new V("isAvailable not implemented for transport",5e4,500)}};(g=i||(i={})).WebSocket="web_socket",g.Comet="comet",g.XhrPolling="xhr_polling";var cG="undefined"!=typeof global?global:"undefined"!=typeof window?window:self,cH=()=>{var a;return void 0!==M.WebStorage&&(null==(a=M.WebStorage)?void 0:a.localSupported)},cI=()=>{var a;return void 0!==M.WebStorage&&(null==(a=M.WebStorage)?void 0:a.sessionSupported)},cJ=function(){},cK="ably-transport-preference";function cL(a){try{return JSON.parse(a)}catch(a){return null}}var cM=class{constructor(a,b,c,d){this.options=a,this.host=b,this.mode=c,this.connectionKey=d,this.format=a.useBinaryProtocol?"msgpack":"json"}getConnectParams(a){let b=a?Y(a):{},c=this.options;switch(this.mode){case"resume":b.resume=this.connectionKey;break;case"recover":{let a=cL(c.recover);a&&(b.recover=a.connectionKey)}}return void 0!==c.clientId&&(b.clientId=c.clientId),!1===c.echoMessages&&(b.echo="false"),void 0!==this.format&&(b.format=this.format),void 0!==this.stream&&(b.stream=this.stream),void 0!==this.heartbeats&&(b.heartbeats=this.heartbeats),b.v=aQ.protocolVersion,b.agent=aX(this.options),void 0!==c.transportParams&&X(b,c.transportParams),b}toString(){let a="[mode="+this.mode;return this.host&&(a+=",host="+this.host),this.connectionKey&&(a+=",connectionKey="+this.connectionKey),this.format&&(a+=",format="+this.format),a+="]"}},cN=class a extends bc{constructor(a,b){super(a.logger),this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=a,this.initTransports(),this.options=b;let c=b.timeouts,d=c.webSocketConnectTimeout+c.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:d,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:c.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:c.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:c.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new cx(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=c.connectionStateTtl,this.maxIdleInterval=null,this.transports=af(b.transports||aQ.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(i.WebSocket)&&(this.webSocketTransportAvailable=!0),this.transports.includes(i.XhrPolling)?this.baseTransport=i.XhrPolling:this.transports.includes(i.Comet)&&(this.baseTransport=i.Comet),this.domains=aQ.getHosts(b),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.ConnectionManager()","started"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(b.transports||aQ.defaultTransports)+"]"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","http domains = ["+this.domains+"]"),!this.transports.length){let a="no requested transports available";throw Q.logAction(this.logger,Q.LOG_ERROR,"realtime.ConnectionManager()",a),Error(a)}let e=M.Config.addEventListener;e&&(cI()&&"function"==typeof b.recover&&e("beforeunload",this.persistConnection.bind(this)),!0===b.closeOnUnload&&e("beforeunload",()=>{Q.logAction(this.logger,Q.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})}),e("online",()=>{var a;this.state==this.states.disconnected||this.state==this.states.suspended?(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager caught browser online event","reattempting connection"),this.requestState({state:"connecting"})):this.state==this.states.connecting&&(null==(a=this.pendingTransport)||a.off(),this.disconnectAllTransports(),this.startConnect())}),e("offline",()=>{this.state==this.states.connected&&(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager caught browser offline event","disconnecting active transport"),this.disconnectAllTransports())}))}static supportedTransports(a){let b={supportedTransports:{}};return this.initTransports(a,b),b.supportedTransports}static initTransports(a,b){let c=x(x({},M.Transports.bundledImplementations),a);[i.WebSocket,...M.Transports.order].forEach(a=>{let d=c[a];d&&d.isAvailable()&&(b.supportedTransports[a]=d)})}initTransports(){a.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams(a,b){return new cM(this.options,a,b,this.connectionKey)}getTransportParams(a){(a=>{if(this.connectionKey)return a("resume");if("string"==typeof this.options.recover)return a("recover");let b=this.options.recover,c=this.getSessionRecoverData(),d=this.sessionRecoveryName();if(c&&"function"==typeof b){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+d+")"),b(c,b=>{b?(this.options.recover=c.recoveryKey,a("recover")):a("clean")});return}a("clean")})(b=>{let c=this.createTransportParams(null,b);if("recover"===b){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);let a=cL(this.options.recover);a&&(this.msgSerial=a.msgSerial)}else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+c.toString());a(c)})}tryATransport(a,b,c){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+b),this.proposedTransport=cF.tryConnect(this.supportedTransports[b],this,this.realtime.auth,a,(d,e)=>{let f=this.state;if(f==this.states.closing||f==this.states.closed||f==this.states.failed){e&&(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+f.state+" while we were attempting the transport; closing "+e),e.close()),c(!0);return}if(d){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+b+" "+d.event+", err: "+d.error.toString()),a7.isTokenErr(d.error)&&!(this.errorReason&&a7.isTokenErr(this.errorReason)))this.errorReason=d.error,az(this.realtime.auth._forceNewToken(null,null),d=>{if(d)return void this.actOnErrorFromAuthorize(d);this.tryATransport(a,b,c)});else if("failed"===d.event)this.notifyState({state:"failed",error:d.error}),c(!0);else if("disconnected"===d.event){var g;!(g=d.error).statusCode||!g.code||g.statusCode>=500||Object.values(cB).includes(g.code)?c(!1):(this.notifyState({state:this.states.connecting.failState,error:d.error}),c(!0))}return}Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+b+"; setting pending"),this.setTransportPending(e,a),c(null,e)})}setTransportPending(a,b){let c=b.mode;Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+a+"; mode = "+c),this.pendingTransport=a,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),a.once("connected",(b,d,e)=>{this.activateTransport(b,a,d,e),"recover"===c&&this.options.recover&&(delete this.options.recover,this.unpersistConnection())});let d=this;a.on(["disconnected","closed","failed"],function(b){d.deactivateTransport(a,this.event,b)}),this.emit("transport.pending",a)}activateTransport(a,b,c,d){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+b),a&&Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+a),c&&Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+c),d&&Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(d)),this.persistTransportPreference(b);let e=this.state,f=this.states.connected.state;if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+e.state),e.state==this.states.closing.state||e.state==this.states.closed.state||e.state==this.states.failed.state)return Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),b.disconnect(),!1;if(delete this.pendingTransport,!b.isConnected)return Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+b+" since it appears to no longer be connected"),!1;let g=this.activeProtocol;this.activeProtocol=new cz(b),this.host=b.params.host;let h=d.connectionKey;if(h&&this.connectionKey!=h&&this.setConnection(c,d,!!a),this.onConnectionDetailsUpdate(d,b),M.Config.nextTick(()=>{b.on("connected",(a,c,d)=>{this.onConnectionDetailsUpdate(d,b),this.emit("update",new cA(f,f,null,a))})}),e.state===this.states.connected.state?a&&(this.errorReason=this.realtime.connection.errorReason=a,this.emit("update",new cA(f,f,null,a))):(this.notifyState({state:"connected",error:a}),this.errorReason=this.realtime.connection.errorReason=a||null),this.emit("transport.active",b),g)if(g.messageQueue.count()>0&&Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+g.transport.shortName+", new one is "+b.shortName+") finishing with "+g.messageQueue.count()+" messages still pending"),g.transport===b){let a="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+b.shortName+"; stack = "+Error().stack;Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()",a)}else g.finish();return!0}deactivateTransport(a,b,c){let d=this.activeProtocol,e=d&&d.getTransport()===a,f=a===this.pendingTransport,g=this.noTransportsScheduledForActivation();if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+a),Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+b+(e?"; was active":f?"; was pending":"")+(g?"":"; another transport is scheduled for activation")),c&&c.message&&Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+c.message),e&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(d.getPendingMessages()),d.clearPendingMessages(),this.activeProtocol=this.host=null),this.emit("transport.inactive",a),e&&g||e&&"failed"===b||"closed"===b||null===d&&f){if("disconnected"===b&&c&&c.statusCode>500&&this.domains.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:b,error:c,retryImmediately:!0});return}let a="failed"===b&&a7.isTokenErr(c)?"disconnected":b;this.notifyState({state:a,error:c});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection(a,b,c){let d=this.connectionId;(d&&d!==a||!d&&c)&&(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted()),this.connectionId!==a&&Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),this.realtime.connection.id=this.connectionId=a,this.realtime.connection.key=this.connectionKey=b.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){return this.connectionKey?JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()}):null}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;let a=Date.now()-this.lastActivity;a>this.connectionStateTtl+this.maxIdleInterval&&(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+a+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}persistConnection(){if(cI()){let a=this.createRecoveryKey();a&&this.setSessionRecoverData({recoveryKey:a,disconnectedAt:Date.now(),location:cG.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getActiveTransportFormat(){var a;return null==(a=this.activeProtocol)?void 0:a.getTransport().format}getError(){if(this.errorReason){let a=W.fromValues(this.errorReason);return a.cause=this.errorReason,a}return this.getStateError()}getStateError(){var a;return null==(a=cC[this.state.state])?void 0:a.call(cC)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange(a){let b="Connection state",c=a.current+(a.reason?"; reason: "+a.reason:"");"failed"===a.current?Q.logAction(this.logger,Q.LOG_ERROR,b,c):Q.logAction(this.logger,Q.LOG_MAJOR,b,c),Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+a.current+"; reason = "+(a.reason&&a.reason.message));let d=this.state=this.states[a.current];a.reason&&(this.errorReason=a.reason,this.realtime.connection.errorReason=a.reason),(d.terminal||"suspended"===d.state)&&this.clearConnection(),this.emit("connectionstate",a)}startTransitionTimer(a){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+a.state),this.transitionTimer&&(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(()=>{this.transitionTimer&&(this.transitionTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager "+a.state+" timer expired","requesting new state: "+a.failState),this.notifyState({state:a.failState}))},a.retryDelay)}cancelTransitionTimer(){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)}startSuspendTimer(){this.suspendTimer||(this.suspendTimer=setTimeout(()=>{this.suspendTimer&&(this.suspendTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"}))},this.connectionStateTtl))}checkSuspendTimer(a){"disconnected"!==a&&"suspended"!==a&&"connecting"!==a&&this.cancelSuspendTimer()}cancelSuspendTimer(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)}startRetryTimer(a){this.retryTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},a)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity&&az(this.realtime.http.checkConnectivity(),(a,b)=>{a||!b?(Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new V("Unable to connect (network unreachable)",80003,404)})):Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){this.webSocketSlowTimer&&(clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null)}startWebSocketGiveUpTimer(a){this.webSocketGiveUpTimer=setTimeout(()=>{var b,c;this.wsCheckResult||(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport?(this.abandonedWebSocket=!0,null==(b=this.proposedTransport)||b.dispose(),null==(c=this.pendingTransport)||c.dispose(),this.connectBase(a,++this.connectCounter)):Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try"))},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){this.webSocketGiveUpTimer&&(clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null)}notifyState(a){var b;let c=a.state,d="disconnected"===c&&(this.state===this.states.connected||a.retryImmediately||this.state===this.states.connecting&&a.error&&a7.isTokenErr(a.error)&&!(this.errorReason&&a7.isTokenErr(this.errorReason)));if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+c+(d?"; will retry connection immediately":"")),c==this.state.state||(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer(a.state),("suspended"===c||"connected"===c)&&(this.disconnectedRetryCount=0),this.state.terminal))return;let e=this.states[a.state],f=e.retryDelay;"disconnected"===e.state&&(this.disconnectedRetryCount++,f=aG(e.retryDelay,this.disconnectedRetryCount));let g=new cA(this.state.state,e.state,f,a.error||(null==(b=cC[e.state])?void 0:b.call(cC)));if(d){let a=()=>{this.state===this.states.disconnected&&(this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"}))},b=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;b&&b<1e3?(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+b+"ms ago, waiting another "+(1e3-b)+"ms before trying again"),setTimeout(a,1e3-b)):M.Config.nextTick(a)}else("disconnected"===c||"suspended"===c)&&this.startRetryTimer(f);("disconnected"===c&&!d||"suspended"===c||e.terminal)&&M.Config.nextTick(()=>{this.disconnectAllTransports()}),"connected"!=c||this.activeProtocol||Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(g),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(c,g.reason),this.failQueuedMessages(g.reason))}requestState(a){var b;let c=a.state;if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+c+"; current state: "+this.state.state),c==this.state.state||(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(c),"connecting"==c&&"connected"==this.state.state||"closing"==c&&"closed"==this.state.state))return;let d=this.states[c],e=new cA(this.state.state,d.state,null,a.error||(null==(b=cC[d.state])?void 0:b.call(cC)));this.enactStateChange(e),"connecting"==c&&M.Config.nextTick(()=>{this.startConnect()}),"closing"==c&&this.closeImpl()}startConnect(){if(this.state!==this.states.connecting)return void Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);let a=this.realtime.auth,b=++this.connectCounter,c=()=>{this.checkConnectionStateFreshness(),this.getTransportParams(a=>{if("recover"===a.mode&&a.options.recover){let b=cL(a.options.recover);b&&this.realtime.channels.recoverChannels(b.channelSerials)}b===this.connectCounter&&this.connectImpl(a,b)})};if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),"basic"===a.method)c();else{let d=a=>{b===this.connectCounter&&(a?this.actOnErrorFromAuthorize(a):c())};this.errorReason&&a7.isTokenErr(this.errorReason)?az(a._forceNewToken(null,null),d):az(a._ensureValidAuthCredentials(!1),d)}}connectImpl(a,b){let c=this.state.state;if(c!==this.states.connecting.state)return void Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+c);let d=this.getTransportPreference();d&&d===this.baseTransport&&this.webSocketTransportAvailable&&this.checkWsConnectivity().then(()=>{this.unpersistTransportPreference(),this.state===this.states.connecting&&(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs(a,++this.connectCounter))}).catch(cJ),d&&d===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable?this.connectBase(a,b):this.connectWs(a,b)}connectWs(a,b){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer(a),this.tryTransportWithFallbacks("web_socket",a,!0,b,()=>!1!==this.wsCheckResult&&!this.abandonedWebSocket)}connectBase(a,b){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport?this.tryTransportWithFallbacks(this.baseTransport,a,!1,b,()=>!0):this.notifyState({state:"disconnected",error:new V("No transports left to try",8e4,404)})}tryTransportWithFallbacks(a,b,c,d,e){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",a);let f=a=>{this.notifyState({state:this.states.connecting.failState,error:a})},g=this.domains.slice(),h=(a,b)=>{if(d===this.connectCounter){if(!e()){b&&b.dispose();return}b||a||j()}},i=g.shift();if(!i)return void f(new V("Unable to connect (no available host)",80003,404));b.host=i;let j=()=>g.length?this.realtime.http.checkConnectivity?void az(this.realtime.http.checkConnectivity(),(c,i)=>{if(d===this.connectCounter&&e()){if(c)return void f(c);if(!i)return void f(new V("Unable to connect (network unreachable)",80003,404));b.host=ap(g),this.tryATransport(b,a,h)}}):void f(new W("Internal error: Http.checkConnectivity not set",null,500)):void f(new V("Unable to connect (and no more fallback hosts to try)",80003,404));if(this.forceFallbackHost&&g.length){this.forceFallbackHost=!1,j();return}this.tryATransport(b,a,h)}closeImpl(){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close()),this.activeProtocol&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})}onAuthUpdated(a,b){var c;switch(this.state.state){case"connected":{Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");let d=null==(c=this.activeProtocol)?void 0:c.getTransport();d&&d.onAuthUpdated&&d.onAuthUpdated(a);let e=co({action:bd.AUTH,auth:{accessToken:a.token}});this.send(e);let f=()=>{this.off(g),b(null,a)},g=a=>{"failed"===a.current&&(this.off(f),this.off(g),b(a.reason||this.getStateError()))};this.once("connectiondetails",f),this.on("connectionstate",g);break}case"connecting":Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");let c=d=>{switch(d.current){case"connected":this.off(c),b(null,a);break;case"failed":case"closed":case"suspended":this.off(c),b(d.reason||this.getStateError())}};this.on("connectionstate",c),"connecting"===this.state.state?this.startConnect():this.requestState({state:"connecting"})}}}disconnectAllTransports(){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect()),delete this.pendingTransport,this.proposedTransport&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect()),delete this.pendingTransport,this.activeProtocol&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())}send(a,b,c){c=c||cJ;let d=this.state;if(d.sendEvents){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new cy(a,c));return}if(!(b&&d.queueEvents)){let a="rejecting event, queueEvent was "+b+", state was "+d.state;Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()",a),c(this.errorReason||new V(a,9e4,400));return}this.logger.shouldLog(Q.LOG_MICRO)&&Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+cp(a,this.realtime._RealtimePresence,this.realtime._Annotations,this.realtime._objectsPlugin)),this.queue(a,c)}sendImpl(a){let b=a.message;a.ackRequired&&!a.sendAttempted&&(b.msgSerial=this.msgSerial++);try{this.activeProtocol.send(a)}catch(a){Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+a.stack)}}queue(a,b){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.queue()","queueing event");let c=this.queuedMessages.last(),d=this.options.maxMessageSize;c&&!c.sendAttempted&&function(a,b,c){let d;if(a.channel!==b.channel||(d=a.action)!==bd.PRESENCE&&d!==bd.MESSAGE||d!==b.action)return!1;let e=d===bd.PRESENCE?"presence":"messages",f=a[e].concat(b[e]);return!(bX(f)>c)&&!!an(f,"clientId")&&!!f.every(function(a){return!a.id})&&(a[e]=f,!0)}(c.message,a,d)?(c.merged||(c.callback=a_.create(this.logger,[c.callback]),c.merged=!0),c.callback.push(b)):this.queuedMessages.push(new cy(a,b))}sendQueuedMessages(){let a;for(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");a=this.queuedMessages.shift();)this.sendImpl(a)}queuePendingMessages(a){a&&a.length&&(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+a.length+" pending messages"),this.queuedMessages.prepend(a))}failQueuedMessages(a){let b=this.queuedMessages.count();b>0&&(Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+b+" queued messages, err = "+at(a)),this.queuedMessages.completeAllMessages(a))}onChannelMessage(a,b){this.pendingChannelMessagesState.queue.push({message:a,transport:b}),this.pendingChannelMessagesState.isProcessing||this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;let a=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage(a.message).catch(a=>{Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",a)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage(a){await this.realtime.channels.processChannelMessage(a)}async ping(){var a;if("connected"!==this.state.state)throw new V("Unable to ping service; not connected",4e4,400);let b=null==(a=this.activeProtocol)?void 0:a.getTransport();if(!b)throw this.getStateError();Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.ping()","transport = "+b);let c=Date.now(),d=aw();return aO(new Promise(a=>{let e=f=>{f===d&&(b.off("heartbeat",e),a(Date.now()-c))};b.on("heartbeat",e),b.ping(d)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort(a){this.activeProtocol.getTransport().fail(a)}getTransportPreference(){var a,b;return this.transportPreference||cH()&&(null==(b=null==(a=M.WebStorage)?void 0:a.get)?void 0:b.call(a,cK))}persistTransportPreference(a){var b,c;this.transportPreference=a.shortName,cH()&&(null==(c=null==(b=M.WebStorage)?void 0:b.set)||c.call(b,cK,a.shortName))}unpersistTransportPreference(){var a,b;this.transportPreference=null,cH()&&(null==(b=null==(a=M.WebStorage)?void 0:a.remove)||b.call(a,cK))}actOnErrorFromAuthorize(a){if(40171===a.code)this.notifyState({state:"failed",error:a});else if(40102===a.code)this.notifyState({state:"failed",error:a});else if(a.statusCode===a1.Forbidden){let b="Client configured authentication provider returned 403; failing the connection";Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",b),this.notifyState({state:"failed",error:new V(b,80019,403,a)})}else{let b="Client configured authentication provider request failed";Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",b),this.notifyState({state:this.state.failState,error:new V(b,80019,401,a)})}}onConnectionDetailsUpdate(a,b){if(!a)return;this.connectionDetails=a,a.maxMessageSize&&(this.options.maxMessageSize=a.maxMessageSize);let c=a.clientId;if(c){let a=this.realtime.auth._uncheckedSetClientId(c);if(a){Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",a.message),b.fail(a);return}}let d=a.connectionStateTtl;d&&(this.connectionStateTtl=d),this.maxIdleInterval=a.maxIdleInterval,this.emit("connectiondetails",a)}checkWsConnectivity(){let a=this.options.wsConnectivityCheckUrl||aQ.wsConnectivityCheckUrl,b=new M.Config.WebSocket(a);return new Promise((a,c)=>{let d=!1;b.onopen=()=>{d||(d=!0,a(),b.close())},b.onclose=b.onerror=()=>{d||(d=!0,c())}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var a,b;return cI()&&(null==(b=null==(a=M.WebStorage)?void 0:a.getSession)?void 0:b.call(a,this.sessionRecoveryName()))}setSessionRecoverData(a){var b,c;return cI()&&(null==(c=null==(b=M.WebStorage)?void 0:b.setSession)?void 0:c.call(b,this.sessionRecoveryName(),a))}clearSessionRecoverData(){var a,b;return cI()&&(null==(b=null==(a=M.WebStorage)?void 0:a.removeSession)?void 0:b.call(a,this.sessionRecoveryName()))}},cO=class extends bc{constructor(a,b){super(a.logger),this.whenState=a=>bc.prototype.whenState.call(this,a,this.state),this.ably=a,this.connectionManager=new cN(a,b),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",a=>{let b=this.state=a.current;M.Config.nextTick(()=>{this.emit(b,a)})}),this.connectionManager.on("update",a=>{M.Config.nextTick(()=>{this.emit("update",a)})})}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return Q.logAction(this.logger,Q.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){Q.logAction(this.logger,Q.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},cP=class a extends bw{constructor(b){var c,d,e,f;if(super(aQ.objectifyOptions(b,!1,"BaseRealtime",Q.defaultLogger)),Q.logAction(this.logger,Q.LOG_MINOR,"Realtime()",""),"string"==typeof EdgeRuntime)throw new V('Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === \'string\')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.',4e4,400);this._additionalTransportImplementations=a.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=null!=(d=null==(c=this.options.plugins)?void 0:c.RealtimePresence)?d:null,this._objectsPlugin=null!=(f=null==(e=this.options.plugins)?void 0:e.Objects)?f:null,this.connection=new cO(this,this.options),this._channels=new cQ(this),!1!==this.options.autoConnect&&this.connect()}static transportImplementationsFromPlugins(a){let b={};return(null==a?void 0:a.WebSocketTransport)&&(b[i.WebSocket]=a.WebSocketTransport),(null==a?void 0:a.XHRPolling)&&(b[i.XhrPolling]=a.XHRPolling),b}get channels(){return this._channels}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};cP.EventEmitter=bc;var cQ=class extends bc{constructor(a){super(a.logger),this.realtime=a,this.all=Object.create(null),a.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let a={};for(let b of ak(this.all,!0)){let c=this.all[b];c.properties.channelSerial&&(a[b]=c.properties.channelSerial)}return a}recoverChannels(a){for(let b of ak(a,!0))this.get(b).properties.channelSerial=a[b]}async processChannelMessage(a){let b=a.channel;if(void 0===b)return void Q.logAction(this.logger,Q.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+a.action);let c=this.all[b];if(!c)return void Q.logAction(this.logger,Q.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+b);await c.processMessage(a)}onTransportActive(){for(let a in this.all){let b=this.all[a];"attaching"===b.state||"detaching"===b.state?b.checkPendingState():"suspended"===b.state?b._attach(!1,null):"attached"===b.state&&b.requestState("attaching")}}propogateConnectionInterruption(a,b){let c=["attaching","attached","detaching","suspended"],d={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"}[a];for(let a in this.all){let e=this.all[a];c.includes(e.state)&&e.notifyState(d,b)}}get(a,b){a=String(a);let c=this.all[a];if(c){if(b){if(c._shouldReattachToSetOptions(b,c.channelOptions))throw new V("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);c.setOptions(b)}}else c=this.all[a]=new ct(this.realtime,a,b);return c}getDerived(a,b,c){if(b.filter){let c=aK(b.filter),d=aJ(a);a=`[filter=${c}${d.qualifierParam}]${d.channelName}`}return this.get(a,c)}release(a){a=String(a);let b=this.all[a];if(!b)return;let c=b.getReleaseErr();if(c)throw c;delete this.all[a]}},cR=cP;function cS(a,b){if(a.isSynthesized()||b.isSynthesized())return a.timestamp>=b.timestamp;let c=a.parseId(),d=b.parseId();return c.msgSerial===d.msgSerial?c.index>d.index:c.msgSerial>d.msgSerial}var cT=class extends bc{constructor(a,b,c=cS){super(a.logger),this.presence=a,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=b,this.newerThan=c}get(a){return this.map[a]}getClient(a){let b=this.map,c=[];for(let d in b){let e=b[d];e.clientId==a&&"absent"!=e.action&&c.push(e)}return c}list(a){let b=this.map,c=a&&a.clientId,d=a&&a.connectionId,e=[];for(let a in b){let f=b[a];"absent"!==f.action&&(!c||c==f.clientId)&&(d&&d!=f.connectionId||e.push(f))}return e}put(a){("enter"===a.action||"update"===a.action)&&((a=bP.fromValues(a)).action="present");let b=this.map,c=this.memberKey(a);this.residualMembers&&delete this.residualMembers[c];let d=b[c];return(!d||!!this.newerThan(a,d))&&(b[c]=a,!0)}values(){let a=this.map,b=[];for(let c in a){let d=a[c];"absent"!=d.action&&b.push(d)}return b}remove(a){let b=this.map,c=this.memberKey(a),d=b[c];return(!d||!!this.newerThan(a,d))&&(this.syncInProgress?((a=bP.fromValues(a)).action="absent",b[c]=a):delete b[c],!!d)}startSync(){let a=this.map,b=this.syncInProgress;Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+b),this.syncInProgress||(this.residualMembers=Y(a),this.setInProgress(!0))}endSync(){let a=this.map,b=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+b),b){for(let b in a)"absent"===a[b].action&&delete a[b];for(let b in this.presence._synthesizeLeaves(al(this.residualMembers)),this.residualMembers)delete a[b];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(a){let b=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+b),!b)return void a();this.once("sync",a)}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(a){Q.logAction(this.logger,Q.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+a),this.syncInProgress=a,this.presence.syncComplete=!a}};function cU(a){let b=a.channel.client,c=b.auth.clientId;return(!c||"*"===c)&&"connected"===b.connection.state}var cV=class extends bc{constructor(a){super(a.logger),this.channel=a,this.syncComplete=!1,this.members=new cT(this,a=>a.clientId+":"+a.connectionId),this._myMembers=new cT(this,a=>a.clientId),this.subscriptions=new bc(this.logger),this.pendingPresence=[]}async enter(a){if(cU(this))throw new V("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,a,"enter")}async update(a){if(cU(this))throw new V("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,a,"update")}async enterClient(a,b){return this._enterOrUpdateClient(void 0,a,b,"enter")}async updateClient(a,b){return this._enterOrUpdateClient(void 0,a,b,"update")}async _enterOrUpdateClient(a,b,c,d){let e=this.channel;if(!e.connectionManager.activeState())throw e.connectionManager.getError();Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence."+d+"Client()","channel = "+e.name+", id = "+a+", client = "+(b||"(implicit) "+this.channel.client.auth.clientId));let f=bP.fromData(c);f.action=d,a&&(f.id=a),b&&(f.clientId=b);let g=await f.encode(e.channelOptions);switch(e.state){case"attached":return e.sendPresence([g]);case"initialized":case"detached":e.attach();case"attaching":return new Promise((a,b)=>{this.pendingPresence.push({presence:g,callback:c=>c?b(c):a()})});default:{let a=new W("Unable to "+d+" presence channel while in "+e.state+" state",90001);throw a.code=90001,a}}}async leave(a){if(cU(this))throw new V("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,a)}async leaveClient(a,b){let c=this.channel;if(!c.connectionManager.activeState())throw c.connectionManager.getError();Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+a);let d=bP.fromData(b);d.action="leave",a&&(d.clientId=a);let e=await d.encode(c.channelOptions);switch(c.state){case"attached":return c.sendPresence([e]);case"attaching":return new Promise((a,b)=>{this.pendingPresence.push({presence:e,callback:c=>c?b(c):a()})});case"initialized":case"failed":throw new W("Unable to leave presence channel (incompatible state)",90001);default:throw c.invalidStateError()}}async get(a){let b=!a||!("waitForSync"in a)||a.waitForSync;return new Promise((c,d)=>{function e(b){c(a?b.list(a):b.values())}if("suspended"===this.channel.state)return void(b?d(V.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"})):e(this.members));!function(a,b,c){switch(a.state){case"attached":case"suspended":c();break;case"initialized":case"detached":case"detaching":case"attaching":az(a.attach(),function(a){a?b(a):c()});break;default:b(V.fromValues(a.invalidStateError()))}}(this.channel,a=>d(a),()=>{let a=this.members;b?a.waitSync(function(){e(a)}):e(a)})})}async history(a){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);let b=this.channel.client.rest.presenceMixin;if(a&&a.untilAttach)if("attached"===this.channel.state)delete a.untilAttach,a.from_serial=this.channel.properties.attachSerial;else throw new V("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400);return b.history(this,a)}setPresence(a,b,c){let d,e;Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+a.length+" participants; syncChannelSerial = "+c);let f=this.members,g=this._myMembers,h=[],i=this.channel.connectionManager.connectionId;for(let j of(b&&(this.members.startSync(),c&&(e=c.match(/^[\w-]+:(.*)$/))&&(d=e[1])),a))switch(j.action){case"leave":f.remove(j)&&h.push(j),j.connectionId!==i||j.isSynthesized()||g.remove(j);break;case"enter":case"present":case"update":f.put(j)&&h.push(j),j.connectionId===i&&g.put(j)}b&&!d&&(f.endSync(),this.channel.syncChannelSerial=null);for(let a=0;a<h.length;a++){let b=h[a];this.subscriptions.emit(b.action,b)}}onAttached(a){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+a),a?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear()),this._ensureMyMembersPresent();let b=this.pendingPresence,c=b.length;if(c){this.pendingPresence=[];let a=[],d=a_.create(this.logger);Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.onAttached","sending "+c+" queued presence messages");for(let e=0;e<c;e++){let c=b[e];a.push(c.presence),d.push(c.callback)}this.channel.sendPresence(a).then(()=>d()).catch(a=>d(a))}}actOnChannelState(a,b,c){switch(a){case"attached":this.onAttached(b);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(c)}}failPendingPresence(a){if(this.pendingPresence.length){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+at(a));for(let b=0;b<this.pendingPresence.length;b++)try{this.pendingPresence[b].callback(a)}catch(a){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){let a=this._myMembers,b=this.channel.connectionManager.connectionId;for(let c in a.map){let d=a.map[c];Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+d.clientId+'" into the presence set');let e=d.connectionId===b?d.id:void 0;this._enterOrUpdateClient(e,d.clientId,d.data,"enter").catch(a=>{let b=new V("Presence auto re-enter failed",91004,400,a);Q.logAction(this.logger,Q.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+at(a));let c=new cr(this.channel.state,this.channel.state,!0,!1,b);this.channel.emit("update",c)})}}_synthesizeLeaves(a){let b=this.subscriptions;a.forEach(function(a){let c=bP.fromValues({action:"leave",connectionId:a.connectionId,clientId:a.clientId,data:a.data,encoding:a.encoding,timestamp:Date.now()});b.emit("leave",c)})}async subscribe(...a){let b=ct.processListenerArgs(a),c=b[0],d=b[1],e=this.channel;if("failed"===e.state)throw V.fromValues(e.invalidStateError());this.subscriptions.on(c,d),!1!==e.channelOptions.attachOnSubscribe&&await e.attach()}unsubscribe(...a){let b=ct.processListenerArgs(a),c=b[0],d=b[1];this.subscriptions.off(c,d)}},cW=i.WebSocket,cX=class extends cF{constructor(a,b,c){super(a,b,c),this.shortName=cW,c.heartbeats=M.Config.useProtocolHeartbeats,this.wsHost=c.host}static isAvailable(){return!!M.Config.WebSocket}createWebSocket(a,b){return this.uri=a+aq(b),new M.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","starting"),cF.prototype.connect.call(this);let a=this,b=this.params,c=b.options,d=(c.tls?"wss://":"ws://")+this.wsHost+":"+aQ.getPort(c)+"/";Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","uri: "+d),az(this.auth.getAuthParams(),function(c,e){if(a.isDisposed)return;let f="";for(let a in e)f+=" "+a+": "+e[a]+";";if(Q.logAction(a.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+f+" err: "+c),c)return void a.disconnect(c);let g=b.getConnectParams(e);try{let b=a.wsConnection=a.createWebSocket(d,g);b.binaryType=M.Config.binaryType,b.onopen=function(){a.onWsOpen()},b.onclose=function(b){a.onWsClose(b)},b.onmessage=function(b){a.onWsData(b.data)},b.onerror=function(b){a.onWsError(b)},b.on&&b.on("ping",function(){a.onActivity()})}catch(b){Q.logAction(a.logger,Q.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(b.stack||b.message)),a.disconnect(b)}})}send(a){let b=this.wsConnection;if(!b)return void Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.send()","No socket connection");try{b.send(aB(a,this.connectionManager.realtime._MsgPack,this.params.format))}catch(b){let a="Exception from ws connection when trying to send: "+at(b);Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.send()",a),this.finish("disconnected",new V(a,5e4,500))}}onWsData(a){Q.logAction(this.logger,Q.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+a.length+"; type = "+typeof a);try{var b,c,d,e,f;this.onProtocolMessage((b=this.connectionManager.realtime._MsgPack,c=this.connectionManager.realtime._RealtimePresence,d=this.connectionManager.realtime._Annotations,e=this.connectionManager.realtime._objectsPlugin,f=this.format,cn(aA(a,b,f),c,d,e)))}catch(a){Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+a.stack)}}onWsOpen(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(a){let b,c;if("object"==typeof a?(c=a.code,b=a.wasClean||1e3===c):b=1e3==(c=a),delete this.wsConnection,b){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");let a=new V("Websocket closed",80003,400);this.finish("disconnected",a)}else{let a="Unclean disconnection of WebSocket ; code = "+c,b=new V(a,80003,400);Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsClose()",a),this.finish("disconnected",b)}this.emit("disposed")}onWsError(a){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+a.message),M.Config.nextTick(()=>{this.disconnect(Error(a.message))})}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;let a=this.wsConnection;a&&(a.onmessage=function(){},delete this.wsConnection,M.Config.nextTick(()=>{if(Q.logAction(this.logger,Q.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!a)throw Error("WebSocketTransport.dispose(): wsConnection is not defined");a.close()}))}},cY=class{static subscribeFilter(a,b,c){let d=a=>{var d,e,f,g,h,i;let j={name:a.name,refTimeserial:null==(e=null==(d=a.extras)?void 0:d.ref)?void 0:e.timeserial,refType:null==(g=null==(f=a.extras)?void 0:f.ref)?void 0:g.type,isRef:!!(null==(i=null==(h=a.extras)?void 0:h.ref)?void 0:i.timeserial),clientId:a.clientId};Object.entries(b).find(([a,b])=>void 0!==b&&j[a]!==b)||c(a)};this.addFilteredSubscription(a,b,c,d),a.subscriptions.on(d)}static addFilteredSubscription(a,b,c,d){var e;if(a.filteredSubscriptions||(a.filteredSubscriptions=new Map),a.filteredSubscriptions.has(c)){let f=a.filteredSubscriptions.get(c);f.set(b,(null==(e=null==f?void 0:f.get(b))?void 0:e.concat(d))||[d])}else a.filteredSubscriptions.set(c,new Map([[b,[d]]]))}static getAndDeleteFilteredSubscriptions(a,b,c){if(!a.filteredSubscriptions)return[];if(!c&&b)return Array.from(a.filteredSubscriptions.entries()).map(([c,d])=>{var e;let f=d.get(b);return d.delete(b),0===d.size&&(null==(e=a.filteredSubscriptions)||e.delete(c)),f}).reduce((a,b)=>b?a.concat(...b):a,[]);if(!c||!a.filteredSubscriptions.has(c))return[];let d=a.filteredSubscriptions.get(c);if(!b){let b=Array.from(d.values()).reduce((a,b)=>a.concat(...b),[]);return a.filteredSubscriptions.delete(c),b}let e=d.get(b);return d.delete(b),e||[]}},cZ=class a extends cR{constructor(b){var c;let d=a._MsgPack;if(!d)throw Error("Expected DefaultRealtime._MsgPack to have been set");super(aQ.objectifyOptions(b,!0,"Realtime",Q.defaultLogger,y(x({},b6),{Crypto:null!=(c=a.Crypto)?c:void 0,MsgPack:d,RealtimePresence:{RealtimePresence:cV,PresenceMessage:bP,WirePresenceMessage:bO},Annotations:{Annotation:cg,WireAnnotation:cf,RealtimeAnnotations:cv,RestAnnotations:cl},WebSocketTransport:cX,MessageInteractions:cY})))}static get Crypto(){if(null===this._Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(a){this._Crypto=a}};cZ.Utils=R,cZ.ConnectionManager=cN,cZ.ProtocolMessage=cq,cZ._Crypto=null,cZ.Message=b7,cZ.PresenceMessage=b8,cZ.Annotation=ch,cZ._MsgPack=null,cZ._Http=ba,cZ._PresenceMap=cT,cZ._MessageEncoding=br;var c$=A(c(55511)),c_=new class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}base64Decode(a){return Buffer.from(a,"base64")}base64Encode(a){return this.toBuffer(a).toString("base64")}base64UrlEncode(a){return this.toBuffer(a).toString("base64url")}areBuffersEqual(a,b){return!!a&&!!b&&0==this.toBuffer(a).compare(this.toBuffer(b))}byteLength(a){return a.byteLength}hexDecode(a){return Buffer.from(a,"hex")}hexEncode(a){return this.toBuffer(a).toString("hex")}isBuffer(a){return Buffer.isBuffer(a)||a instanceof ArrayBuffer||ArrayBuffer.isView(a)}toArrayBuffer(a){let b=this.toBuffer(a);return b.buffer.slice(b.byteOffset,b.byteOffset+b.byteLength)}toBuffer(a){return Buffer.isBuffer(a)?a:a instanceof ArrayBuffer?Buffer.from(a):Buffer.from(a.buffer,a.byteOffset,a.byteLength)}arrayBufferViewToBuffer(a){return this.toBuffer(a)}utf8Decode(a){if(!this.isBuffer(a))throw Error("Expected input of utf8Decode to be a buffer, arraybuffer, or view");return this.toBuffer(a).toString("utf8")}utf8Encode(a){return Buffer.from(a,"utf8")}concat(a){return Buffer.concat(a.map(a=>this.toBuffer(a)))}sha256(a){let b=this.toBuffer(a);return c$.default.createHash("SHA256").update(b).digest()}hmacSha256(a,b){let c=this.toBuffer(a),d=this.toBuffer(b);return c$.default.createHmac("SHA256",d).update(c).digest()}},c0=A(c(55511)),c1=A(c(28354)),c2=A(c(3162)),c3=A(c(81630)),c4=A(c(55591)),c5=[],c6=((j=class{constructor(a){this.agent=null,this.supportsAuthHeaders=!0,this.supportsLinkHeaders=!0,this.checkConnectivity=async()=>{var a,b,c,d,e;if(null==(a=this.client)?void 0:a.options.disableConnectivityCheck)return!0;let f=(null==(b=this.client)?void 0:b.options.connectivityCheckUrl)||aQ.connectivityCheckUrl,g=null!=(d=null==(c=this.client)?void 0:c.options.connectivityCheckParams)?d:null,h=!(null==(e=this.client)?void 0:e.options.connectivityCheckUrl),{error:i,statusCode:j,body:k}=await this.doUri(a0.Get,f,null,null,g);return i||h?!i&&(null==k?void 0:k.toString().trim())==="yes":function(a){return a>=200&&a<400}(j)},this.client=null!=a?a:null}async doUri(a,b,c,d,e){var f;let g=this.client&&this.client.options.restAgentOptions||aQ.restAgentOptions,h={headers:c||void 0,responseType:"buffer"};if(!this.agent){let a=null==(f=c5.find(a=>aI(g,a.options)))?void 0:f.agents;a?this.agent=a:(this.agent={http:new c3.default.Agent(g),https:new c4.default.Agent(g)},c5.push({options:g,agents:this.agent}))}d&&(h.body=d),e&&(h.searchParams=e),h.agent=this.agent,h.url=b,h.timeout={request:(this.client&&this.client.options.timeouts||aQ.TIMEOUTS).httpRequestTimeout},h.retry={limit:0};try{let b=await c2.default[a](h);return this._handler(null,b,b.body)}catch(a){if(a instanceof c2.default.HTTPError)return this._handler(null,a.response,a.response.body);return this._handler(a)}}shouldFallback(a){let{code:b,statusCode:c}=a;return"ENETUNREACH"===b||"EHOSTUNREACH"===b||"EHOSTDOWN"===b||"ETIMEDOUT"===b||"ESOCKETTIMEDOUT"===b||"ENOTFOUND"===b||"ECONNRESET"===b||"ECONNREFUSED"===b||c>=500&&c<=504}_handler(a,b,c){var d;if(a)return{error:a};let e=b.statusCode,f=b.headers;if(e>=300){switch(f["content-type"]){case"application/json":c=JSON.parse(c);break;case"application/x-msgpack":if(!(null==(d=this.client)?void 0:d._MsgPack))return{error:aM("MsgPack")};c=this.client._MsgPack.decode(c)}return{error:c.error?V.fromValues(c.error):new V(f["x-ably-errormessage"]||"Error response received from server: "+e+" body was: "+M.Config.inspect(c),Number(f["x-ably-errorcode"]),e),body:c,headers:f,unpacked:!0,statusCode:e}}return{error:null,body:c,headers:f,unpacked:!1,statusCode:e}}}).methods=[a0.Get,a0.Delete,a0.Post,a0.Put,a0.Patch],j.methodsWithoutBody=[a0.Get,a0.Delete],j.methodsWithBody=[a0.Post,a0.Put,a0.Patch],j),c7=A(c(55511)),c8=A(c(68135)),c9=A(c(28354)),da={agent:"nodejs/"+process.versions.node,logTimestamps:!0,userAgent:null,binaryType:"nodebuffer",WebSocket:c8.default,useProtocolHeartbeats:!1,supportsBinary:!0,preferBinary:!0,nextTick:process.nextTick,inspect:c9.default.inspect,stringByteSize:Buffer.byteLength,inherits:c9.default.inherits,addEventListener:null,getRandomArrayBuffer:async function(a){return c9.default.promisify(c7.default.randomBytes)(a)}},db=((h=db||{})[h.REQ_SEND=0]="REQ_SEND",h[h.REQ_RECV=1]="REQ_RECV",h[h.REQ_RECV_POLL=2]="REQ_RECV_POLL",h[h.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",h);function dc(a){return a.code&&!a7.isTokenErr(a)&&([80015,80017,80030].includes(a.code)||a.code>=4e4&&a.code<5e4)?[co({action:bd.ERROR,error:a})]:[co({action:bd.DISCONNECTED,error:a})]}var dd=class extends cF{constructor(a,b,c){super(a,b,c,!0),this.onAuthUpdated=a=>{this.authParams={access_token:a.token}},this.stream=!("stream"in c)||c.stream,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","starting"),cF.prototype.connect.call(this);let a=this.params,b=a.options,c=a.host||b.primaryDomain,d=aQ.getPort(b),e=b.tls?"https://":"http://";this.baseUri=e+c+":"+d+"/comet/";let f=this.baseUri+"connect";Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","uri: "+f),az(this.auth.getAuthParams(),(a,b)=>{if(a)return void this.disconnect(a);if(this.isDisposed)return;this.authParams=b;let c=this.params.getConnectParams(b);"stream"in c&&(this.stream=c.stream),Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","connectParams:"+aq(c));let d=!1,e=this.recvRequest=this.createRequest(f,null,c,null,this.stream?db.REQ_RECV_STREAM:db.REQ_RECV);e.on("data",a=>{this.recvRequest&&(d||(d=!0,this.emit("preconnect")),this.onData(a))}),e.on("complete",a=>{if(this.recvRequest||(a=a||new V("Request cancelled",80003,400)),this.recvRequest=null,d||a||(d=!0,this.emit("preconnect")),this.onActivity(),a)return void(a.code?this.onData(dc(a)):this.disconnect(a));M.Config.nextTick(()=>{this.recv()})}),e.exec()})}requestClose(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(a){let b=a?this.closeUri:this.disconnectUri;if(b){let c=this.createRequest(b,null,this.authParams,null,db.REQ_SEND);c.on("complete",b=>{b&&(Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.request"+(a?"Close()":"Disconnect()"),"request returned err = "+at(b)),this.finish("disconnected",b))}),c.exec()}}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",cC.disconnected()),M.Config.nextTick(()=>{this.emit("disposed")}))}onConnect(a){var b;if(this.isDisposed)return;let c=null==(b=a.connectionDetails)?void 0:b.connectionKey;cF.prototype.onConnect.call(this,a);let d=this.baseUri+c;Q.logAction(this.logger,Q.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+d),this.sendUri=d+"/send",this.recvUri=d+"/recv",this.closeUri=d+"/close",this.disconnectUri=d+"/disconnect"}send(a){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(a);return}let b=this.pendingItems||[];b.push(a),this.pendingItems=null,this.sendItems(b)}sendAnyPending(){let a=this.pendingItems;a&&(this.pendingItems=null,this.sendItems(a))}sendItems(a){let b=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(a),db.REQ_SEND);b.on("complete",(a,b)=>{if(a&&Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+at(a)),this.sendRequest=null,a)return void(a.code?this.onData(dc(a)):this.disconnect(a));b&&this.onData(b),this.pendingItems&&M.Config.nextTick(()=>{this.sendRequest||this.sendAnyPending()})}),b.exec()}recv(){if(this.recvRequest||!this.isConnected)return;let a=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?db.REQ_RECV_STREAM:db.REQ_RECV_POLL);a.on("data",a=>{this.onData(a)}),a.on("complete",a=>{if(this.recvRequest=null,this.onActivity(),a)return void(a.code?this.onData(dc(a)):this.disconnect(a));M.Config.nextTick(()=>{this.recv()})}),a.exec()}onData(a){try{let b=this.decodeResponse(a);if(b&&b.length)for(let a=0;a<b.length;a++)this.onProtocolMessage(cn(b[a],this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin))}catch(a){Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+a.stack)}}encodeRequest(a){return JSON.stringify(a)}decodeResponse(a){return"string"==typeof a?JSON.parse(a):a}},de=A(c(81630)),df=A(c(55591)),dg=A(c(79551)),dh=A(c(28354)),di=function(){},dj=i.Comet,dk=class extends dd{constructor(a,b,c){super(a,b,c),this.httpAgent=null,this.httpsAgent=null,this.pendingRequests=0,this.shortName=dj}static isAvailable(){return!0}toString(){return"NodeCometTransport; uri="+this.baseUri+"; isConnected="+this.isConnected+"; format="+this.format+"; stream="+this.stream}getAgent(a){var b=a?"httpsAgent":"httpAgent",c=this[b];return c||(c=this[b]=new(a?df.default:de.default).Agent({keepAlive:!0})),c}dispose(){var a=this;this.onceNoPending(function(){a.httpAgent&&a.httpAgent.destroy(),a.httpsAgent&&a.httpsAgent.destroy()}),dd.prototype.dispose.call(this)}request(a,b,c,d,e){var f=this.createRequest(a,b,c,d);return f.once("complete",e),f.exec(),f}createRequest(a,b,c,d,e){return new dl(a,b,c,d,e,this.format,this.timeouts,this)}addPending(){++this.pendingRequests}removePending(){--this.pendingRequests<=0&&this.emit("nopending")}onceNoPending(a){if(0==this.pendingRequests)return void a();this.once("nopending",a)}},dl=class extends bc{constructor(a,b,c,d,e,f,g,h){super(h.logger),"string"==typeof a&&(a=dg.default.parse(a));var i="https:"==a.protocol;this.client=i?df.default:de.default,this.requestMode=e,this.timeouts=g,this.transport=h,this.requestComplete=!1,this.req=this.res=null;var j="GET",k="msgpack"==f?"application/x-msgpack":"application/json";(b=b?X({},b):{}).accept=k,d&&(j="POST",Buffer.isBuffer(d)||("object"==typeof d&&(d=JSON.stringify(d)),d=Buffer.from(d)),this.body=d,b["Content-Length"]=d.length,b["Content-Type"]=k);var l=this.requestOptions={hostname:a.hostname,port:a.port,path:a.path+aq(c),method:j,headers:b};h&&(l.agent=h.getAgent(i))}exec(){var a=this.requestMode==db.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,b=this,c=this.timer=setTimeout(function(){b.abort()},a),d=this.req=this.client.request(this.requestOptions);d.on("error",this.onReqError=function(a){a=new W("Request error: "+a.message,null,400),clearTimeout(c),b.timer=null,b.complete(a)}),d.on("response",function(a){clearTimeout(c),b.timer=null;var d=a.statusCode;if(d==a1.NoContent){a.resume(),b.complete();return}a.on("error",b.onResError=function(a){a=new W("Response error: "+a.message,null,400),b.complete(a)}),b.res=a,b.requestMode==db.REQ_RECV_STREAM&&d<400?b.readStream():b.readFully()}),this.transport&&this.transport.addPending(),d.end(this.body)}readStream(){var a=this.res,b=this;function c(a){try{a=JSON.parse(a)}catch(a){var c="Malformed response body from server: "+a.message;Q.logAction(b.logger,Q.LOG_ERROR,"NodeCometTransport.Request.readStream()",c),b.complete(new W(c,null,400));return}b.emit("data",a)}this.chunks=[],this.streamComplete=!1,a.on("data",this.ondata=function(a){var d=String(a).split("\n"),e=b.chunks;d.length>1&&e.length>0&&(e.push(d.shift()),b.chunks=[],c(e.join("")));var f=d.pop();f.length&&b.chunks.push(f),d.map(c)}),a.on("end",function(){b.streamComplete=!0,process.nextTick(function(){b.complete()})})}readFully(){var a=this.res,b=[],c=this;a.on("data",function(a){b.push(a)}),a.on("end",function(){process.nextTick(function(){var d=Buffer.concat(b),e=a.statusCode;try{d=JSON.parse(String(d))}catch(a){var f="Malformed response body from server: "+a.message;Q.logAction(c.logger,Q.LOG_ERROR,"NodeCometTransport.Request.readFully()",f),c.complete(new W(f,null,400));return}if(e<400||Array.isArray(d))return void c.complete(null,d);var g=d.error&&V.fromValues(d.error);g||(g=new W("Error response received from server: "+e+", body was: "+dh.default.inspect(d),null,e)),c.complete(g)})})}complete(a,b){!this.requestComplete&&(this.requestComplete=!0,b&&this.emit("data",b),this.emit("complete",a,b),a&&this.ondata&&!this.streamComplete&&this.ondata&&this.res&&this.res.removeListener("data",this.ondata),this.transport&&this.transport.removePending())}abort(){Q.logAction(this.logger,Q.LOG_MINOR,"NodeCometTransport.Request.abort()","");var a=this.timer;a&&(clearTimeout(a),this.timer=null);var b=this.req;b&&(Q.logAction(this.logger,Q.LOG_MINOR,"NodeCometTransport.Request.abort()","aborting request"),b.removeListener("error",this.onReqError),b.on("error",di),b.abort(),this.req=null),this.complete({statusCode:400,code:80003,message:"Cancelled"})}},dm={order:[i.Comet],bundledImplementations:{[i.WebSocket]:cX,[i.Comet]:dk}},dn={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[i.WebSocket],restAgentOptions:{maxSockets:40,keepAlive:!0}},dp=L(),dq=function(a){async function b(a){return c1.default.promisify(c0.default.randomBytes)(a)}function c(a,b){var c=Buffer.alloc(a);return c.fill(b),c}for(var d=[c(16,16)],e=1;e<=16;e++)d.push(c(e,e));class f{constructor(a,b,c,d){this.algorithm=a,this.keyLength=b,this.mode=c,this.key=d,this.iv=null}}class g{static getDefaultParams(b){if(!b.key)throw Error("Crypto.getDefaultParams: a key is required");var c="string"==typeof b.key?a.base64Decode(b.key.replace("_","/").replace("-","+")):b.key instanceof ArrayBuffer?Buffer.from(b.key):b.key,d=new f(b.algorithm||"aes",8*c.length,b.mode||"cbc",c);if(b.keyLength&&b.keyLength!==d.keyLength)throw Error("Crypto.getDefaultParams: a keyLength of "+b.keyLength+" was specified, but the key actually has length "+d.keyLength);if("aes"===d.algorithm&&"cbc"===d.mode&&128!==d.keyLength&&256!==d.keyLength)throw Error("Unsupported key length "+d.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)");return d}static async generateRandomKey(a){try{return b((a||256)/8)}catch(a){throw new V("Failed to generate random key: "+a.message,500,5e4,a)}}static getCipher(a,b){var c,d=a.algorithm&&a.key&&a.keyLength&&a.mode?a:this.getDefaultParams(a);return{cipherParams:d,cipher:new h(d,null!=(c=a.iv)?c:null,b)}}}g.CipherParams=f;class h{constructor(a,b,c){this.logger=c,this.encryptCipher=null,this.algorithm=a.algorithm+"-"+String(a.keyLength)+"-"+a.mode,this.key=a.key,this.iv=b}async encrypt(b){Q.logAction(this.logger,Q.LOG_MICRO,"CBCCipher.encrypt()","");let c=await this.getIv();this.encryptCipher||(this.encryptCipher=c0.default.createCipheriv(this.algorithm,this.key,c));var e=a.toBuffer(b),f=e.length,g=this.encryptCipher.update(Buffer.concat([e,d[(f+16&-16)-f]]));return Buffer.concat([c,g])}async decrypt(a){var b=c0.default.createDecipheriv(this.algorithm,this.key,a.slice(0,16)),c=b.update(a.slice(16)),d=b.final();return d&&d.length&&(c=Buffer.concat([c,d])),c}async getIv(){if(this.iv){var a=this.iv;return this.iv=null,a}var c=await b(16);return this.encryptCipher?this.encryptCipher.update(c):c}}return g}(c_);for(let a of(M.Crypto=dq,M.BufferUtils=c_,M.Http=c6,M.Config=da,M.Transports=dm,M.WebStorage=null,[cw,cZ]))a.Crypto=dq,a._MsgPack=dp;return Q.initLogHandlers(),M.Defaults=Object.assign(aQ,dn),M.Config.agent&&(M.Defaults.agent+=" "+M.Config.agent),l.exports={ErrorInfo:V,Rest:cw,Realtime:cZ,msgpack:null,makeProtocolMessageFromDeserialized:function(a){return b=>{var c;return cn(b,{PresenceMessage:bP,WirePresenceMessage:bO},{Annotation:cg,WireAnnotation:cf,RealtimeAnnotations:cv,RestAnnotations:cl},null!=(c=null==a?void 0:a.ObjectsPlugin)?c:null)}}},"object"==typeof l.exports&&(l.exports=((a,b,c,d)=>{if(b&&"object"==typeof b||"function"==typeof b)for(let e of Object.getOwnPropertyNames(b))Object.prototype.hasOwnProperty.call(a,e)||e===c||Object.defineProperty(a,e,{get:()=>b[e],enumerable:!(d=Object.getOwnPropertyDescriptor(b,e))||d.enumerable});return a})(l.exports,k)),l.exports})(c(68135),c(3162))},52188:(a,b,c)=>{"use strict";let d;Object.defineProperty(b,"__esModule",{value:!0}),b.UnsupportedProtocolError=b.ReadError=b.TimeoutError=b.UploadError=b.CacheError=b.HTTPError=b.MaxRedirectsError=b.RequestError=b.setNonEnumerableProperties=b.knownHookEvents=b.withoutBody=b.kIsNormalizedAlready=void 0;let e=c(28354),f=c(27910),g=c(29021),h=c(79551),i=c(81630),j=c(81630),k=c(55591),l=c(35091),m=c(41126),n=c(77104),o=c(92582),p=c(36161),q=c(92513),r=c(35510),s=c(92577),t=c(90968),u=c(14050),v=c(48064),w=c(4138),x=c(72484),y=c(37827),z=c(62649),A=c(43026),B=c(92045),C=c(87935),D=c(45777),E=c(16513),F=Symbol("request"),G=Symbol("response"),H=Symbol("responseSize"),I=Symbol("downloadedSize"),J=Symbol("bodySize"),K=Symbol("uploadedSize"),L=Symbol("serverResponsesPiped"),M=Symbol("unproxyEvents"),N=Symbol("isFromCache"),O=Symbol("cancelTimeouts"),P=Symbol("startedReading"),Q=Symbol("stopReading"),R=Symbol("triggerRead"),S=Symbol("body"),T=Symbol("jobs"),U=Symbol("originalResponse"),V=Symbol("retryTimeout");b.kIsNormalizedAlready=Symbol("isNormalizedAlready");let W=r.default.string(process.versions.brotli);b.withoutBody=new Set(["GET","HEAD"]),b.knownHookEvents=["init","beforeRequest","beforeRedirect","beforeError","beforeRetry","afterResponse"];let X=new y.default,Y=async a=>new Promise((b,c)=>{let d=a=>{c(a)};a.pending||b(),a.once("error",d),a.once("ready",()=>{a.off("error",d),b()})}),Z=new Set([300,301,302,303,304,307,308]),$=["context","body","json","form"];b.setNonEnumerableProperties=(a,b)=>{let c={};for(let b of a)if(b)for(let a of $)a in b&&(c[a]={writable:!0,configurable:!0,enumerable:!1,value:b[a]});Object.defineProperties(b,c)};class _ extends Error{constructor(a,b,c){var d,e;if(super(a),Error.captureStackTrace(this,this.constructor),this.name="RequestError",this.code=null!=(d=b.code)?d:"ERR_GOT_REQUEST_ERROR",c instanceof ai?(Object.defineProperty(this,"request",{enumerable:!1,value:c}),Object.defineProperty(this,"response",{enumerable:!1,value:c[G]}),Object.defineProperty(this,"options",{enumerable:!1,value:c.options})):Object.defineProperty(this,"options",{enumerable:!1,value:c}),this.timings=null==(e=this.request)?void 0:e.timings,r.default.string(b.stack)&&r.default.string(this.stack)){let a=this.stack.indexOf(this.message)+this.message.length,c=this.stack.slice(a).split("\n").reverse(),d=b.stack.slice(b.stack.indexOf(b.message)+b.message.length).split("\n").reverse();for(;0!==d.length&&d[0]===c[0];)c.shift();this.stack=`${this.stack.slice(0,a)}${c.reverse().join("\n")}${d.reverse().join("\n")}`}}}b.RequestError=_;class aa extends _{constructor(a){super(`Redirected ${a.options.maxRedirects} times. Aborting.`,{},a),this.name="MaxRedirectsError",this.code="ERR_TOO_MANY_REDIRECTS"}}b.MaxRedirectsError=aa;class ab extends _{constructor(a){super(`Response code ${a.statusCode} (${a.statusMessage})`,{},a.request),this.name="HTTPError",this.code="ERR_NON_2XX_3XX_RESPONSE"}}b.HTTPError=ab;class ac extends _{constructor(a,b){super(a.message,a,b),this.name="CacheError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_CACHE_ACCESS":this.code}}b.CacheError=ac;class ad extends _{constructor(a,b){super(a.message,a,b),this.name="UploadError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_UPLOAD":this.code}}b.UploadError=ad;class ae extends _{constructor(a,b,c){super(a.message,a,c),this.name="TimeoutError",this.event=a.event,this.timings=b}}b.TimeoutError=ae;class af extends _{constructor(a,b){super(a.message,a,b),this.name="ReadError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_READING_RESPONSE_STREAM":this.code}}b.ReadError=af;class ag extends _{constructor(a){super(`Unsupported protocol "${a.url.protocol}"`,{},a),this.name="UnsupportedProtocolError",this.code="ERR_UNSUPPORTED_PROTOCOL"}}b.UnsupportedProtocolError=ag;let ah=["socket","connect","continue","information","upgrade","timeout"];class ai extends f.Duplex{constructor(a,c={},d){super({autoDestroy:!1,highWaterMark:0}),this[I]=0,this[K]=0,this.requestInitialized=!1,this[L]=new Set,this.redirects=[],this[Q]=!1,this[R]=!1,this[T]=[],this.retryCount=0,this._progressCallbacks=[];let e=()=>this._unlockWrite(),f=()=>this._lockWrite();this.on("pipe",a=>{a.prependListener("data",e),a.on("data",f),a.prependListener("end",e),a.on("end",f)}),this.on("unpipe",a=>{a.off("data",e),a.off("data",f),a.off("end",e),a.off("end",f)}),this.on("pipe",a=>{a instanceof j.IncomingMessage&&(this.options.headers={...a.headers,...this.options.headers})});let{json:h,body:i,form:k}=c;if((h||i||k)&&this._lockWrite(),b.kIsNormalizedAlready in c)this.options=c;else try{this.options=this.constructor.normalizeArguments(a,c,d)}catch(a){r.default.nodeStream(c.body)&&c.body.destroy(),this.destroy(a);return}(async()=>{var a;try{this.options.body instanceof g.ReadStream&&await Y(this.options.body);let{url:b}=this.options;if(!b)throw TypeError("Missing `url` property");if(this.requestUrl=b.toString(),decodeURI(this.requestUrl),await this._finalizeBody(),await this._makeRequest(),this.destroyed){null==(a=this[F])||a.destroy();return}for(let a of this[T])a();this[T].length=0,this.requestInitialized=!0}catch(a){if(a instanceof _)return void this._beforeError(a);this.destroyed||this.destroy(a)}})()}static normalizeArguments(a,c,f){var g,i,j,k,l;let o=c;if(r.default.object(a)&&!r.default.urlInstance(a))c={...f,...a,...c};else{if(a&&c&&void 0!==c.url)throw TypeError("The `url` option is mutually exclusive with the `input` argument");c={...f,...c},void 0!==a&&(c.url=a),r.default.urlInstance(c.url)&&(c.url=new h.URL(c.url.toString()))}if(!1===c.cache&&(c.cache=void 0),!1===c.dnsCache&&(c.dnsCache=void 0),r.assert.any([r.default.string,r.default.undefined],c.method),r.assert.any([r.default.object,r.default.undefined],c.headers),r.assert.any([r.default.string,r.default.urlInstance,r.default.undefined],c.prefixUrl),r.assert.any([r.default.object,r.default.undefined],c.cookieJar),r.assert.any([r.default.object,r.default.string,r.default.undefined],c.searchParams),r.assert.any([r.default.object,r.default.string,r.default.undefined],c.cache),r.assert.any([r.default.object,r.default.number,r.default.undefined],c.timeout),r.assert.any([r.default.object,r.default.undefined],c.context),r.assert.any([r.default.object,r.default.undefined],c.hooks),r.assert.any([r.default.boolean,r.default.undefined],c.decompress),r.assert.any([r.default.boolean,r.default.undefined],c.ignoreInvalidCookies),r.assert.any([r.default.boolean,r.default.undefined],c.followRedirect),r.assert.any([r.default.number,r.default.undefined],c.maxRedirects),r.assert.any([r.default.boolean,r.default.undefined],c.throwHttpErrors),r.assert.any([r.default.boolean,r.default.undefined],c.http2),r.assert.any([r.default.boolean,r.default.undefined],c.allowGetBody),r.assert.any([r.default.string,r.default.undefined],c.localAddress),r.assert.any([A.isDnsLookupIpVersion,r.default.undefined],c.dnsLookupIpVersion),r.assert.any([r.default.object,r.default.undefined],c.https),r.assert.any([r.default.boolean,r.default.undefined],c.rejectUnauthorized),c.https&&(r.assert.any([r.default.boolean,r.default.undefined],c.https.rejectUnauthorized),r.assert.any([r.default.function_,r.default.undefined],c.https.checkServerIdentity),r.assert.any([r.default.string,r.default.object,r.default.array,r.default.undefined],c.https.certificateAuthority),r.assert.any([r.default.string,r.default.object,r.default.array,r.default.undefined],c.https.key),r.assert.any([r.default.string,r.default.object,r.default.array,r.default.undefined],c.https.certificate),r.assert.any([r.default.string,r.default.undefined],c.https.passphrase),r.assert.any([r.default.string,r.default.buffer,r.default.array,r.default.undefined],c.https.pfx)),r.assert.any([r.default.object,r.default.undefined],c.cacheOptions),r.default.string(c.method)?c.method=c.method.toUpperCase():c.method="GET",c.headers===(null==f?void 0:f.headers)?c.headers={...c.headers}:c.headers=q({...null==f?void 0:f.headers,...c.headers}),"slashes"in c)throw TypeError("The legacy `url.Url` has been deprecated. Use `URL` instead.");if("auth"in c)throw TypeError("Parameter `auth` is deprecated. Use `username` / `password` instead.");if("searchParams"in c&&c.searchParams&&c.searchParams!==(null==f?void 0:f.searchParams)){let a;if(r.default.string(c.searchParams)||c.searchParams instanceof h.URLSearchParams)a=new h.URLSearchParams(c.searchParams);else{var p=c.searchParams;for(let a in p){let b=p[a];if(!r.default.string(b)&&!r.default.number(b)&&!r.default.boolean(b)&&!r.default.null_(b)&&!r.default.undefined(b))throw TypeError(`The \`searchParams\` value '${String(b)}' must be a string, number, boolean or null`)}for(let b in a=new h.URLSearchParams,c.searchParams){let d=c.searchParams[b];null===d?a.append(b,""):void 0!==d&&a.append(b,d)}}null==(g=null==f?void 0:f.searchParams)||g.forEach((b,c)=>{a.has(c)||a.append(c,b)}),c.searchParams=a}if(c.username=null!=(i=c.username)?i:"",c.password=null!=(j=c.password)?j:"",r.default.undefined(c.prefixUrl)?c.prefixUrl=null!=(k=null==f?void 0:f.prefixUrl)?k:"":(c.prefixUrl=c.prefixUrl.toString(),""===c.prefixUrl||c.prefixUrl.endsWith("/")||(c.prefixUrl+="/")),r.default.string(c.url)){if(c.url.startsWith("/"))throw Error("`input` must not start with a slash when using `prefixUrl`");c.url=x.default(c.prefixUrl+c.url,c)}else(r.default.undefined(c.url)&&""!==c.prefixUrl||c.protocol)&&(c.url=x.default(c.prefixUrl,c));if(c.url){"port"in c&&delete c.port;let{prefixUrl:a}=c;Object.defineProperty(c,"prefixUrl",{set:b=>{let d=c.url;if(!d.href.startsWith(b))throw Error(`Cannot change \`prefixUrl\` from ${a} to ${b}: ${d.href}`);c.url=new h.URL(b+d.href.slice(a.length)),a=b},get:()=>a});let{protocol:b}=c.url;if("unix:"===b&&(b="http:",c.url=new h.URL(`http://unix${c.url.pathname}${c.url.search}`)),c.searchParams&&(c.url.search=c.searchParams.toString()),"http:"!==b&&"https:"!==b)throw new ag(c);""===c.username?c.username=c.url.username:c.url.username=c.username,""===c.password?c.password=c.url.password:c.url.password=c.password}let{cookieJar:s}=c;if(s){let{setCookie:a,getCookieString:b}=s;r.assert.function_(a),r.assert.function_(b),4===a.length&&0===b.length&&(a=e.promisify(a.bind(c.cookieJar)),b=e.promisify(b.bind(c.cookieJar)),c.cookieJar={setCookie:a,getCookieString:b})}let{cache:t}=c;if(t&&!X.has(t)&&X.set(t,new n((a,b)=>{let c=a[F](a,b);return r.default.promise(c)&&(c.once=(a,b)=>{if("error"===a)c.catch(b);else if("abort"===a)(async()=>{try{(await c).once("abort",b)}catch(a){}})();else throw Error(`Unknown HTTP2 promise event: ${a}`);return c}),c},t)),c.cacheOptions={...c.cacheOptions},!0===c.dnsCache)d||(d=new m.default),c.dnsCache=d;else if(!r.default.undefined(c.dnsCache)&&!c.dnsCache.lookup)throw TypeError(`Parameter \`dnsCache\` must be a CacheableLookup instance or a boolean, got ${r.default(c.dnsCache)}`);r.default.number(c.timeout)?c.timeout={request:c.timeout}:f&&c.timeout!==f.timeout?c.timeout={...f.timeout,...c.timeout}:c.timeout={...c.timeout},c.context||(c.context={});let u=c.hooks===(null==f?void 0:f.hooks);for(let a of(c.hooks={...c.hooks},b.knownHookEvents))if(a in c.hooks)if(r.default.array(c.hooks[a]))c.hooks[a]=[...c.hooks[a]];else throw TypeError(`Parameter \`${a}\` must be an Array, got ${r.default(c.hooks[a])}`);else c.hooks[a]=[];if(f&&!u)for(let a of b.knownHookEvents)f.hooks[a].length>0&&(c.hooks[a]=[...f.hooks[a],...c.hooks[a]]);if("family"in c&&C.default('"options.family" was never documented, please use "options.dnsLookupIpVersion"'),(null==f?void 0:f.https)&&(c.https={...f.https,...c.https}),"rejectUnauthorized"in c&&C.default('"options.rejectUnauthorized" is now deprecated, please use "options.https.rejectUnauthorized"'),"checkServerIdentity"in c&&C.default('"options.checkServerIdentity" was never documented, please use "options.https.checkServerIdentity"'),"ca"in c&&C.default('"options.ca" was never documented, please use "options.https.certificateAuthority"'),"key"in c&&C.default('"options.key" was never documented, please use "options.https.key"'),"cert"in c&&C.default('"options.cert" was never documented, please use "options.https.certificate"'),"passphrase"in c&&C.default('"options.passphrase" was never documented, please use "options.https.passphrase"'),"pfx"in c&&C.default('"options.pfx" was never documented, please use "options.https.pfx"'),"followRedirects"in c)throw TypeError("The `followRedirects` option does not exist. Use `followRedirect` instead.");if(c.agent){for(let a in c.agent)if("http"!==a&&"https"!==a&&"http2"!==a)throw TypeError(`Expected the \`options.agent\` properties to be \`http\`, \`https\` or \`http2\`, got \`${a}\``)}return c.maxRedirects=null!=(l=c.maxRedirects)?l:0,b.setNonEnumerableProperties([f,o],c),D.default(c,f)}_lockWrite(){let a=()=>{throw TypeError("The payload has been already provided")};this.write=a,this.end=a}_unlockWrite(){this.write=super.write,this.end=super.end}async _finalizeBody(){let{options:a}=this,{headers:c}=a,d=!r.default.undefined(a.form),e=!r.default.undefined(a.json),g=!r.default.undefined(a.body),i=d||e||g,j=b.withoutBody.has(a.method)&&!("GET"===a.method&&a.allowGetBody);if(this._cannotHaveBody=j,i){if(j)throw TypeError(`The \`${a.method}\` method cannot be used with a body`);if([g,d,e].filter(a=>a).length>1)throw TypeError("The `body`, `json` and `form` options are mutually exclusive");if(g&&!(a.body instanceof f.Readable)&&!r.default.string(a.body)&&!r.default.buffer(a.body)&&!t.default(a.body))throw TypeError("The `body` option must be a stream.Readable, string or Buffer");if(d&&!r.default.object(a.form))throw TypeError("The `form` option must be an Object");{let b=!r.default.string(c["content-type"]);g?(t.default(a.body)&&b&&(c["content-type"]=`multipart/form-data; boundary=${a.body.getBoundary()}`),this[S]=a.body):d?(b&&(c["content-type"]="application/x-www-form-urlencoded"),this[S]=new h.URLSearchParams(a.form).toString()):(b&&(c["content-type"]="application/json"),this[S]=a.stringifyJson(a.json));let e=await s.default(this[S],a.headers);r.default.undefined(c["content-length"])&&r.default.undefined(c["transfer-encoding"])&&!j&&!r.default.undefined(e)&&(c["content-length"]=String(e))}}else j?this._lockWrite():this._unlockWrite();this[J]=Number(c["content-length"])||void 0}async _onResponseBase(a){let{options:b}=this,{url:c}=b;this[U]=a,b.decompress&&(a=o(a));let d=a.statusCode,e=a;e.statusMessage=e.statusMessage?e.statusMessage:i.STATUS_CODES[d],e.url=b.url.toString(),e.requestUrl=this.requestUrl,e.redirectUrls=this.redirects,e.request=this,e.isFromCache=a.fromCache||!1,e.ip=this.ip,e.retryCount=this.retryCount,this[N]=e.isFromCache,this[H]=Number(a.headers["content-length"])||void 0,this[G]=a,a.once("end",()=>{this[H]=this[I],this.emit("downloadProgress",this.downloadProgress)}),a.once("error",b=>{a.destroy(),this._beforeError(new af(b,this))}),a.once("aborted",()=>{this._beforeError(new af({name:"Error",message:"The server aborted pending request",code:"ECONNRESET"},this))}),this.emit("downloadProgress",this.downloadProgress);let f=a.headers["set-cookie"];if(r.default.object(b.cookieJar)&&f){let a=f.map(async a=>b.cookieJar.setCookie(a,c.toString()));b.ignoreInvalidCookies&&(a=a.map(async a=>a.catch(()=>{})));try{await Promise.all(a)}catch(a){this._beforeError(a);return}}if(b.followRedirect&&a.headers.location&&Z.has(d)){if(a.resume(),this[F]&&(this[O](),delete this[F],this[M]()),(303!==d||"GET"===b.method||"HEAD"===b.method)&&b.methodRewriting||(b.method="GET","body"in b&&delete b.body,"json"in b&&delete b.json,"form"in b&&delete b.form,this[S]=void 0,delete b.headers["content-length"]),this.redirects.length>=b.maxRedirects)return void this._beforeError(new aa(this));try{let d=Buffer.from(a.headers.location,"binary").toString(),f=new h.URL(d,c),i=f.toString();function g(a){return"unix:"===a.protocol||"unix"===a.hostname}if(decodeURI(i),!g(c)&&g(f))return void this._beforeError(new _("Cannot redirect to UNIX socket",{},this));for(let a of(f.hostname!==c.hostname||f.port!==c.port?("host"in b.headers&&delete b.headers.host,"cookie"in b.headers&&delete b.headers.cookie,"authorization"in b.headers&&delete b.headers.authorization,(b.username||b.password)&&(b.username="",b.password="")):(f.username=b.username,f.password=b.password),this.redirects.push(i),b.url=f,b.hooks.beforeRedirect))await a(b,e);this.emit("redirect",e,b),await this._makeRequest()}catch(a){this._beforeError(a)}return}if(b.isStream&&b.throwHttpErrors&&!B.isResponseOk(e))return void this._beforeError(new ab(e));for(let c of(a.on("readable",()=>{this[R]&&this._read()}),this.on("resume",()=>{a.resume()}),this.on("pause",()=>{a.pause()}),a.once("end",()=>{this.push(null)}),this.emit("response",a),this[L]))if(!c.headersSent){for(let d in a.headers){let e=!b.decompress||"content-encoding"!==d,f=a.headers[d];e&&c.setHeader(d,f)}c.statusCode=d}}async _onResponse(a){try{await this._onResponseBase(a)}catch(a){this._beforeError(a)}}_onRequest(a){let{options:b}=this,{timeout:c,url:d}=b;l.default(a),this[O]=v.default(a,c,d);let e=b.cache?"cacheableResponse":"response";a.once(e,a=>{this._onResponse(a)}),a.once("error",b=>{var c;a.destroy(),null==(c=a.res)||c.removeAllListeners("end"),b=b instanceof v.TimeoutError?new ae(b,this.timings,this):new _(b.message,b,this),this._beforeError(b)}),this[M]=u.default(a,this,ah),this[F]=a,this.emit("uploadProgress",this.uploadProgress);let f=this[S],g=0===this.redirects.length?this:a;r.default.nodeStream(f)?(f.pipe(g),f.once("error",a=>{this._beforeError(new ad(a,this))})):(this._unlockWrite(),r.default.undefined(f)?(this._cannotHaveBody||this._noPipe)&&(g.end(),this._lockWrite()):(this._writeRequest(f,void 0,()=>{}),g.end(),this._lockWrite())),this.emit("request",a)}async _createCacheableRequest(a,b){return new Promise((c,d)=>{let e;Object.assign(b,w.default(a)),delete b.url;let f=X.get(b.cache)(b,async a=>{a._readableState.autoDestroy=!1,e&&(await e).emit("cacheableResponse",a),c(a)});b.url=a,f.once("error",d),f.once("request",async a=>{c(e=a)})})}async _makeRequest(){var a,b,c,d,e,f;let g,{options:h}=this,{headers:j}=h;for(let a in j)if(r.default.undefined(j[a]))delete j[a];else if(r.default.null_(j[a]))throw TypeError(`Use \`undefined\` instead of \`null\` to delete the \`${a}\` header`);if(h.decompress&&r.default.undefined(j["accept-encoding"])&&(j["accept-encoding"]=W?"gzip, deflate, br":"gzip, deflate"),h.cookieJar){let a=await h.cookieJar.getCookieString(h.url.toString());r.default.nonEmptyString(a)&&(h.headers.cookie=a)}for(let a of h.hooks.beforeRequest){let b=await a(h);if(!r.default.undefined(b)){h.request=()=>b;break}}h.body&&this[S]!==h.body&&(this[S]=h.body);let{agent:l,request:m,timeout:o,url:q}=h;if(!h.dnsCache||"lookup"in h||(h.lookup=h.dnsCache.lookup),"unix"===q.hostname){let a=/(?<socketPath>.+?):(?<path>.+)/.exec(`${q.pathname}${q.search}`);if(null==a?void 0:a.groups){let{socketPath:b,path:c}=a.groups;Object.assign(h,{socketPath:b,path:c,host:""})}}let s="https:"===q.protocol;g=h.http2?p.auto:s?k.request:i.request;let t=null!=(a=h.request)?a:g,u=h.cache?this._createCacheableRequest:t;if(l&&!h.http2&&(h.agent=l[s?"https":"http"]),h[F]=t,delete h.request,delete h.timeout,h.shared=null==(b=h.cacheOptions)?void 0:b.shared,h.cacheHeuristic=null==(c=h.cacheOptions)?void 0:c.cacheHeuristic,h.immutableMinTimeToLive=null==(d=h.cacheOptions)?void 0:d.immutableMinTimeToLive,h.ignoreCargoCult=null==(e=h.cacheOptions)?void 0:e.ignoreCargoCult,void 0!==h.dnsLookupIpVersion)try{h.family=A.dnsLookupIpVersionToFamily(h.dnsLookupIpVersion)}catch(a){throw Error("Invalid `dnsLookupIpVersion` option value")}h.https&&("rejectUnauthorized"in h.https&&(h.rejectUnauthorized=h.https.rejectUnauthorized),h.https.checkServerIdentity&&(h.checkServerIdentity=h.https.checkServerIdentity),h.https.certificateAuthority&&(h.ca=h.https.certificateAuthority),h.https.certificate&&(h.cert=h.https.certificate),h.https.key&&(h.key=h.https.key),h.https.passphrase&&(h.passphrase=h.https.passphrase),h.https.pfx&&(h.pfx=h.https.pfx));try{let a=await u(q,h);(r.default.undefined(a)&&(a=g(q,h)),h.request=m,h.timeout=o,h.agent=l,h.https&&("rejectUnauthorized"in h.https&&delete h.rejectUnauthorized,h.https.checkServerIdentity&&delete h.checkServerIdentity,h.https.certificateAuthority&&delete h.ca,h.https.certificate&&delete h.cert,h.https.key&&delete h.key,h.https.passphrase&&delete h.passphrase,h.https.pfx&&delete h.pfx),f=a,!r.default.object(f)||"statusCode"in f)?this.writable?(this.once("finish",()=>{this._onResponse(a)}),this._unlockWrite(),this.end(),this._lockWrite()):this._onResponse(a):this._onRequest(a)}catch(a){if(a instanceof n.CacheError)throw new ac(a,this);throw new _(a.message,a,this)}}async _error(a){try{for(let b of this.options.hooks.beforeError)a=await b(a)}catch(b){a=new _(b.message,b,this)}this.destroy(a)}_beforeError(a){if(this[Q])return;let{options:b}=this,c=this.retryCount+1;this[Q]=!0,a instanceof _||(a=new _(a.message,a,this));let d=a,{response:e}=d;(async()=>{if(e&&!e.body){e.setEncoding(this._readableState.encoding);try{e.rawBody=await z.default(e),e.body=e.rawBody.toString()}catch(a){}}if(0!==this.listenerCount("retry")){let f;try{let a;e&&"retry-after"in e.headers&&(a=Number(e.headers["retry-after"]),Number.isNaN(a)?(a=Date.parse(e.headers["retry-after"])-Date.now())<=0&&(a=1):a*=1e3),f=await b.retry.calculateDelay({attemptCount:c,retryOptions:b.retry,error:d,retryAfter:a,computedValue:E.default({attemptCount:c,retryOptions:b.retry,error:d,retryAfter:a,computedValue:0})})}catch(a){this._error(new _(a.message,a,this));return}if(f){let b=async()=>{try{for(let a of this.options.hooks.beforeRetry)await a(this.options,d,c)}catch(b){this._error(new _(b.message,a,this));return}this.destroyed||(this.destroy(),this.emit("retry",c,a))};this[V]=setTimeout(b,f);return}}this._error(d)})()}_read(){this[R]=!0;let a=this[G];if(a&&!this[Q]){let b;for(a.readableLength&&(this[R]=!1);null!==(b=a.read());){this[I]+=b.length,this[P]=!0;let a=this.downloadProgress;a.percent<1&&this.emit("downloadProgress",a),this.push(b)}}}_write(a,b,c){let d=()=>{this._writeRequest(a,b,c)};this.requestInitialized?d():this[T].push(d)}_writeRequest(a,b,c){this[F].destroyed||(this._progressCallbacks.push(()=>{this[K]+=Buffer.byteLength(a,b);let c=this.uploadProgress;c.percent<1&&this.emit("uploadProgress",c)}),this[F].write(a,b,a=>{!a&&this._progressCallbacks.length>0&&this._progressCallbacks.shift()(),c(a)}))}_final(a){let b=()=>{for(;0!==this._progressCallbacks.length;)this._progressCallbacks.shift()();if(!(F in this)||this[F].destroyed)return void a();this[F].end(b=>{b||(this[J]=this[K],this.emit("uploadProgress",this.uploadProgress),this[F].emit("upload-complete")),a(b)})};this.requestInitialized?b():this[T].push(b)}_destroy(a,b){var c;this[Q]=!0,clearTimeout(this[V]),F in this&&(this[O](),(null==(c=this[G])?void 0:c.complete)||this[F].destroy()),null===a||r.default.undefined(a)||a instanceof _||(a=new _(a.message,a,this)),b(a)}get _isAboutToError(){return this[Q]}get ip(){var a;return null==(a=this.socket)?void 0:a.remoteAddress}get aborted(){var a,b,c;return(null!=(b=null==(a=this[F])?void 0:a.destroyed)?b:this.destroyed)&&!(null==(c=this[U])?void 0:c.complete)}get socket(){var a,b;return null!=(b=null==(a=this[F])?void 0:a.socket)?b:void 0}get downloadProgress(){return{percent:this[H]?this[I]/this[H]:+(this[H]===this[I]),transferred:this[I],total:this[H]}}get uploadProgress(){return{percent:this[J]?this[K]/this[J]:+(this[J]===this[K]),transferred:this[K],total:this[J]}}get timings(){var a;return null==(a=this[F])?void 0:a.timings}get isFromCache(){return this[N]}pipe(a,b){if(this[P])throw Error("Failed to pipe. The response has been emitted already.");return a instanceof j.ServerResponse&&this[L].add(a),super.pipe(a,b)}unpipe(a){return a instanceof j.ServerResponse&&this[L].delete(a),super.unpipe(a),this}}b.default=ai},52873:(a,b,c)=>{"use strict";let d=c(34631);a.exports=(a={},b=d.connect)=>new Promise((c,d)=>{let e,f=!1,g=async()=>{await i,e.off("timeout",h),e.off("error",d),a.resolveSocket?(c({alpnProtocol:e.alpnProtocol,socket:e,timeout:f}),f&&(await Promise.resolve(),e.emit("timeout"))):(e.destroy(),c({alpnProtocol:e.alpnProtocol,timeout:f}))},h=async()=>{f=!0,g()},i=(async()=>{try{(e=await b(a,g)).on("error",d),e.once("timeout",h)}catch(a){d(a)}})()})},53775:a=>{a.exports=function a(b,c){if(b&&c)return a(b)(c);if("function"!=typeof b)throw TypeError("need wrapper function");return Object.keys(b).forEach(function(a){d[a]=b[a]}),d;function d(){for(var a=Array(arguments.length),c=0;c<a.length;c++)a[c]=arguments[c];var d=b.apply(this,a),e=a[a.length-1];return"function"==typeof d&&d!==e&&Object.keys(e).forEach(function(a){d[a]=e[a]}),d}}},55874:a=>{"use strict";let b=["destroy","setTimeout","socket","headers","trailers","rawHeaders","statusCode","httpVersion","httpVersionMinor","httpVersionMajor","rawTrailers","statusMessage"];a.exports=(a,c)=>{for(let d of new Set(Object.keys(a).concat(b)))d in c||(c[d]="function"==typeof a[d]?a[d].bind(a):a[d])}},58986:(a,b,c)=>{"use strict";let{tokenChars:d}=c(86200);function e(a,b,c){void 0===a[b]?a[b]=[c]:a[b].push(c)}a.exports={format:function(a){return Object.keys(a).map(b=>{let c=a[b];return Array.isArray(c)||(c=[c]),c.map(a=>[b].concat(Object.keys(a).map(b=>{let c=a[b];return Array.isArray(c)||(c=[c]),c.map(a=>!0===a?b:`${b}=${a}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(a){let b,c,f=Object.create(null),g=Object.create(null),h=!1,i=!1,j=!1,k=-1,l=-1,m=-1,n=0;for(;n<a.length;n++)if(l=a.charCodeAt(n),void 0===b)if(-1===m&&1===d[l])-1===k&&(k=n);else if(0!==n&&(32===l||9===l))-1===m&&-1!==k&&(m=n);else if(59===l||44===l){if(-1===k)throw SyntaxError(`Unexpected character at index ${n}`);-1===m&&(m=n);let c=a.slice(k,m);44===l?(e(f,c,g),g=Object.create(null)):b=c,k=m=-1}else throw SyntaxError(`Unexpected character at index ${n}`);else if(void 0===c)if(-1===m&&1===d[l])-1===k&&(k=n);else if(32===l||9===l)-1===m&&-1!==k&&(m=n);else if(59===l||44===l){if(-1===k)throw SyntaxError(`Unexpected character at index ${n}`);-1===m&&(m=n),e(g,a.slice(k,m),!0),44===l&&(e(f,b,g),g=Object.create(null),b=void 0),k=m=-1}else if(61===l&&-1!==k&&-1===m)c=a.slice(k,n),k=m=-1;else throw SyntaxError(`Unexpected character at index ${n}`);else if(i){if(1!==d[l])throw SyntaxError(`Unexpected character at index ${n}`);-1===k?k=n:h||(h=!0),i=!1}else if(j)if(1===d[l])-1===k&&(k=n);else if(34===l&&-1!==k)j=!1,m=n;else if(92===l)i=!0;else throw SyntaxError(`Unexpected character at index ${n}`);else if(34===l&&61===a.charCodeAt(n-1))j=!0;else if(-1===m&&1===d[l])-1===k&&(k=n);else if(-1!==k&&(32===l||9===l))-1===m&&(m=n);else if(59===l||44===l){if(-1===k)throw SyntaxError(`Unexpected character at index ${n}`);-1===m&&(m=n);let d=a.slice(k,m);h&&(d=d.replace(/\\/g,""),h=!1),e(g,c,d),44===l&&(e(f,b,g),g=Object.create(null),b=void 0),c=void 0,k=m=-1}else throw SyntaxError(`Unexpected character at index ${n}`);if(-1===k||j||32===l||9===l)throw SyntaxError("Unexpected end of input");-1===m&&(m=n);let o=a.slice(k,m);return void 0===b?e(f,o,g):(void 0===c?e(g,o,!0):h?e(g,c,o.replace(/\\/g,"")):e(g,c,o),e(f,b,g)),f}}},61075:a=>{"use strict";let b=Symbol("kDone"),c=Symbol("kRun");class d{constructor(a){this[b]=()=>{this.pending--,this[c]()},this.concurrency=a||1/0,this.jobs=[],this.pending=0}add(a){this.jobs.push(a),this[c]()}[c](){if(this.pending!==this.concurrency&&this.jobs.length){let a=this.jobs.shift();this.pending++,a(this[b])}}}a.exports=d},61710:(a,b,c)=>{"use strict";let{constants:d}=c(79428),e=c(10331),f=c(22295);class g extends Error{constructor(){super("maxBuffer exceeded"),this.name="MaxBufferError"}}async function h(a,b){let c;if(!a)return Promise.reject(Error("Expected a stream"));let{maxBuffer:h}=b={maxBuffer:1/0,...b};return await new Promise((i,j)=>{let k=a=>{a&&c.getBufferedLength()<=d.MAX_LENGTH&&(a.bufferedData=c.getBufferedValue()),j(a)};(c=e(a,f(b),a=>{if(a)return void k(a);i()})).on("data",()=>{c.getBufferedLength()>h&&k(new g)})}),c.getBufferedValue()}a.exports=h,a.exports.default=h,a.exports.buffer=(a,b)=>h(a,{...b,encoding:"buffer"}),a.exports.array=(a,b)=>h(a,{...b,array:!0}),a.exports.MaxBufferError=g},62649:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.default=async a=>{let b=[],c=0;for await(let d of a)b.push(d),c+=Buffer.byteLength(d);return Buffer.isBuffer(b[0])?Buffer.concat(b,c):Buffer.from(b.join(""))}},62967:(a,b,c)=>{var d=c(82411),e=function(){},f=global.Bare?queueMicrotask:process.nextTick.bind(process),g=function(a,b,c){if("function"==typeof b)return g(a,null,b);b||(b={}),c=d(c||e);var h=a._writableState,i=a._readableState,j=b.readable||!1!==b.readable&&a.readable,k=b.writable||!1!==b.writable&&a.writable,l=!1,m=function(){a.writable||n()},n=function(){k=!1,j||c.call(a)},o=function(){j=!1,k||c.call(a)},p=function(b){c.call(a,b?Error("exited with error code: "+b):null)},q=function(b){c.call(a,b)},r=function(){f(s)},s=function(){if(!l&&(j&&!(i&&i.ended&&!i.destroyed)||k&&!(h&&h.ended&&!h.destroyed)))return c.call(a,Error("premature close"))},t=function(){a.req.on("finish",n)};return a.setHeader&&"function"==typeof a.abort?(a.on("complete",n),a.on("abort",r),a.req?t():a.on("request",t)):k&&!h&&(a.on("end",m),a.on("close",m)),a.stdio&&Array.isArray(a.stdio)&&3===a.stdio.length&&a.on("exit",p),a.on("end",o),a.on("finish",n),!1!==b.error&&a.on("error",q),a.on("close",r),function(){l=!0,a.removeListener("complete",n),a.removeListener("abort",r),a.removeListener("request",t),a.req&&a.req.removeListener("finish",n),a.removeListener("end",m),a.removeListener("close",m),a.removeListener("finish",n),a.removeListener("exit",p),a.removeListener("end",o),a.removeListener("error",q),a.removeListener("close",r)}};a.exports=g},63674:a=>{"use strict";let b=["nodebuffer","arraybuffer","fragments"],c="undefined"!=typeof Blob;c&&b.push("blob"),a.exports={BINARY_TYPES:b,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:c,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},68135:(a,b,c)=>{"use strict";let d=c(77740);d.createWebSocketStream=c(7363),d.Server=c(35366),d.Receiver=c(26802),d.Sender=c(92910),d.WebSocket=d,d.WebSocketServer=d.Server,a.exports=d},68150:a=>{"use strict";a.exports=a=>{switch(a){case":method":case":scheme":case":authority":case":path":return!0;default:return!1}}},70187:function(a,b,c){"use strict";var d=this&&this.__createBinding||(Object.create?function(a,b,c,d){void 0===d&&(d=c),Object.defineProperty(a,d,{enumerable:!0,get:function(){return b[c]}})}:function(a,b,c,d){void 0===d&&(d=c),a[d]=b[c]}),e=this&&this.__exportStar||function(a,b){for(var c in a)"default"===c||Object.prototype.hasOwnProperty.call(b,c)||d(b,a,c)};Object.defineProperty(b,"__esModule",{value:!0});let f=c(94735),g=c(35510),h=c(99620),i=c(90826),j=c(7857),k=c(52188),l=c(14050),m=c(62649),n=c(92045),o=["request","response","redirect","uploadProgress","downloadProgress"];b.default=function a(b){let c,d,e=new f.EventEmitter,p=new h((f,h,q)=>{let r=s=>{let t=new k.default(void 0,b);t.retryCount=s,t._noPipe=!0,q(()=>t.destroy()),q.shouldReject=!1,q(()=>h(new i.CancelError(t))),c=t,t.once("response",async b=>{var c;let e;if(b.retryCount=s,b.request.aborted)return;try{e=await m.default(t),b.rawBody=e}catch(a){return}if(t._isAboutToError)return;let g=["gzip","deflate","br"].includes((null!=(c=b.headers["content-encoding"])?c:"").toLowerCase()),{options:h}=t;if(g&&!h.decompress)b.body=e;else try{b.body=j.default(b,h.responseType,h.parseJson,h.encoding)}catch(a){if(b.body=e.toString(),n.isResponseOk(b))return void t._beforeError(a)}try{for(let[c,d]of h.hooks.afterResponse.entries())b=await d(b,async b=>{let d=k.default.normalizeArguments(void 0,{...b,retry:{calculateDelay:()=>0},throwHttpErrors:!1,resolveBodyOnly:!1},h);for(let a of(d.hooks.afterResponse=d.hooks.afterResponse.slice(0,c),d.hooks.beforeRetry))await a(d);let e=a(d);return q(()=>{e.catch(()=>{}),e.cancel()}),e})}catch(a){t._beforeError(new i.RequestError(a.message,a,t));return}if(d=b,!n.isResponseOk(b))return void t._beforeError(new i.HTTPError(b));t.destroy(),f(t.options.resolveBodyOnly?b.body:b)});let u=a=>{if(p.isCanceled)return;let{options:b}=t;if(a instanceof i.HTTPError&&!b.throwHttpErrors){let{response:b}=a;f(t.options.resolveBodyOnly?b.body:b);return}h(a)};t.once("error",u);let v=t.options.body;t.once("retry",(a,b)=>{var c,d;if(v===(null==(c=b.request)?void 0:c.options.body)&&g.default.nodeStream(null==(d=b.request)?void 0:d.options.body))return void u(b);r(a)}),l.default(t,e,o)};r(0)});p.on=(a,b)=>(e.on(a,b),p);let q=a=>{let b=(async()=>{await p;let{options:b}=d.request;return j.default(d,a,b.parseJson,b.encoding)})();return Object.defineProperties(b,Object.getOwnPropertyDescriptors(p)),b};return p.json=()=>{let{headers:a}=c.options;return c.writableFinished||void 0!==a.accept||(a.accept="application/json"),q("json")},p.buffer=()=>q("buffer"),p.text=()=>q("text"),p},e(c(90826),b)},72484:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(79551),e=["protocol","host","hostname","port","pathname","search"];b.default=(a,b)=>{var c,f;if(b.path){if(b.pathname)throw TypeError("Parameters `path` and `pathname` are mutually exclusive.");if(b.search)throw TypeError("Parameters `path` and `search` are mutually exclusive.");if(b.searchParams)throw TypeError("Parameters `path` and `searchParams` are mutually exclusive.")}if(b.search&&b.searchParams)throw TypeError("Parameters `search` and `searchParams` are mutually exclusive.");if(!a){if(!b.protocol)throw TypeError("No URL protocol specified");a=`${b.protocol}//${null!=(f=null!=(c=b.hostname)?c:b.host)?f:""}`}let g=new d.URL(a);if(b.path){let a=b.path.indexOf("?");-1===a?b.pathname=b.path:(b.pathname=b.path.slice(0,a),b.search=b.path.slice(a+1)),delete b.path}for(let a of e)b[a]&&(g[a]=b[a].toString());return g}},77104:(a,b,c)=>{"use strict";let d=c(94735),e=c(79551),f=c(11356),g=c(61710),h=c(32078),i=c(79164),j=c(92513),k=c(43975),l=c(77167);class m{constructor(a,b){if("function"!=typeof a)throw TypeError("Parameter `request` must be a function");return this.cache=new l({uri:"string"==typeof b&&b,store:"string"!=typeof b&&b,namespace:"cacheable-request"}),this.createCacheableRequest(a)}createCacheableRequest(a){return(b,c)=>{let l;if("string"==typeof b)l=n(e.parse(b)),b={};else if(b instanceof e.URL)l=n(e.parse(b.toString())),b={};else{let[a,...c]=(b.path||"").split("?"),d=c.length>0?`?${c.join("?")}`:"";l=n({...b,pathname:a,search:d})}(b={headers:{},method:"GET",cache:!0,strictTtl:!1,automaticFailover:!1,...b,...function(a){let b={...a};return b.path=`${a.pathname||"/"}${a.search||""}`,delete b.pathname,delete b.search,b}(l)}).headers=j(b.headers);let o=new d,p=f(e.format(l),{stripWWW:!1,removeTrailingSlash:!1,stripAuthentication:!1}),q=`${b.method}:${p}`,r=!1,s=!1,t=b=>{let d;s=!0;let e=!1,f=new Promise(a=>{d=()=>{e||(e=!0,a())}}),j=a=>{let d;if(r&&!b.forceRefresh){a.status=a.statusCode;let c=h.fromObject(r.cachePolicy).revalidatedPolicy(b,a);if(!c.modified){let b=c.policy.responseHeaders();(a=new i(r.statusCode,b,r.body,r.url)).cachePolicy=c.policy,a.fromCache=!0}}a.fromCache||(a.cachePolicy=new h(b,a,b),a.fromCache=!1),b.cache&&a.cachePolicy.storable()?(d=k(a),(async()=>{try{let c=g.buffer(a);if(await Promise.race([f,new Promise(b=>a.once("end",b))]),e)return;let d=await c,h={cachePolicy:a.cachePolicy.toObject(),url:a.url,statusCode:a.fromCache?r.statusCode:a.statusCode,body:d},i=b.strictTtl?a.cachePolicy.timeToLive():void 0;b.maxTtl&&(i=i?Math.min(i,b.maxTtl):b.maxTtl),await this.cache.set(q,h,i)}catch(a){o.emit("error",new m.CacheError(a))}})()):b.cache&&r&&(async()=>{try{await this.cache.delete(q)}catch(a){o.emit("error",new m.CacheError(a))}})(),o.emit("response",d||a),"function"==typeof c&&c(d||a)};try{let c=a(b,j);c.once("error",d),c.once("abort",d),o.emit("request",c)}catch(a){o.emit("error",new m.RequestError(a))}};return(async()=>{let a=async a=>{await Promise.resolve();let b=a.cache?await this.cache.get(q):void 0;if(void 0===b)return t(a);let d=h.fromObject(b.cachePolicy);if(d.satisfiesWithoutRevalidation(a)&&!a.forceRefresh){let a=d.responseHeaders(),e=new i(b.statusCode,a,b.body,b.url);e.cachePolicy=d,e.fromCache=!0,o.emit("response",e),"function"==typeof c&&c(e)}else r=b,a.headers=d.revalidationHeaders(a),t(a)},d=a=>o.emit("error",new m.CacheError(a));this.cache.once("error",d),o.on("response",()=>this.cache.removeListener("error",d));try{await a(b)}catch(a){b.automaticFailover&&!s&&t(b),o.emit("error",new m.CacheError(a))}})(),o}}}function n(a){return{protocol:a.protocol,auth:a.auth,hostname:a.hostname||a.host||"localhost",port:a.port,pathname:a.pathname,search:a.search}}m.RequestError=class extends Error{constructor(a){super(a.message),this.name="RequestError",Object.assign(this,a)}},m.CacheError=class extends Error{constructor(a){super(a.message),this.name="CacheError",Object.assign(this,a)}},a.exports=m},77740:(a,b,c)=>{"use strict";let d=c(94735),e=c(55591),f=c(81630),g=c(91645),h=c(34631),{randomBytes:i,createHash:j}=c(55511),{Duplex:k,Readable:l}=c(27910),{URL:m}=c(79551),n=c(20879),o=c(26802),p=c(92910),{isBlob:q}=c(86200),{BINARY_TYPES:r,EMPTY_BUFFER:s,GUID:t,kForOnEventAttribute:u,kListener:v,kStatusCode:w,kWebSocket:x,NOOP:y}=c(63674),{EventTarget:{addEventListener:z,removeEventListener:A}}=c(17605),{format:B,parse:C}=c(58986),{toBuffer:D}=c(78086),E=Symbol("kAborted"),F=[8,13],G=["CONNECTING","OPEN","CLOSING","CLOSED"],H=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class I extends d{constructor(a,b,c){super(),this._binaryType=r[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=s,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=I.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==a?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===b?b=[]:Array.isArray(b)||("object"==typeof b&&null!==b?(c=b,b=[]):b=[b]),function a(b,c,d,g){let h,k,l,o,p={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:F[1],maxPayload:0x6400000,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...g,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(b._autoPong=p.autoPong,!F.includes(p.protocolVersion))throw RangeError(`Unsupported protocol version: ${p.protocolVersion} (supported versions: ${F.join(", ")})`);if(c instanceof m)h=c;else try{h=new m(c)}catch(a){throw SyntaxError(`Invalid URL: ${c}`)}"http:"===h.protocol?h.protocol="ws:":"https:"===h.protocol&&(h.protocol="wss:"),b._url=h.href;let q="wss:"===h.protocol,r="ws+unix:"===h.protocol;if("ws:"===h.protocol||q||r?r&&!h.pathname?k="The URL's pathname is empty":h.hash&&(k="The URL contains a fragment identifier"):k='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"',k){let a=SyntaxError(k);if(0!==b._redirects)return void J(b,a);throw a}let s=q?443:80,u=i(16).toString("base64"),v=q?e.request:f.request,w=new Set;if(p.createConnection=p.createConnection||(q?L:K),p.defaultPort=p.defaultPort||s,p.port=h.port||s,p.host=h.hostname.startsWith("[")?h.hostname.slice(1,-1):h.hostname,p.headers={...p.headers,"Sec-WebSocket-Version":p.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket"},p.path=h.pathname+h.search,p.timeout=p.handshakeTimeout,p.perMessageDeflate&&(l=new n(!0!==p.perMessageDeflate?p.perMessageDeflate:{},!1,p.maxPayload),p.headers["Sec-WebSocket-Extensions"]=B({[n.extensionName]:l.offer()})),d.length){for(let a of d){if("string"!=typeof a||!H.test(a)||w.has(a))throw SyntaxError("An invalid or duplicated subprotocol was specified");w.add(a)}p.headers["Sec-WebSocket-Protocol"]=d.join(",")}if(p.origin&&(p.protocolVersion<13?p.headers["Sec-WebSocket-Origin"]=p.origin:p.headers.Origin=p.origin),(h.username||h.password)&&(p.auth=`${h.username}:${h.password}`),r){let a=p.path.split(":");p.socketPath=a[0],p.path=a[1]}if(p.followRedirects){if(0===b._redirects){b._originalIpc=r,b._originalSecure=q,b._originalHostOrSocketPath=r?p.socketPath:h.host;let a=g&&g.headers;if(g={...g,headers:{}},a)for(let[b,c]of Object.entries(a))g.headers[b.toLowerCase()]=c}else if(0===b.listenerCount("redirect")){let a=r?!!b._originalIpc&&p.socketPath===b._originalHostOrSocketPath:!b._originalIpc&&h.host===b._originalHostOrSocketPath;a&&(!b._originalSecure||q)||(delete p.headers.authorization,delete p.headers.cookie,a||delete p.headers.host,p.auth=void 0)}p.auth&&!g.headers.authorization&&(g.headers.authorization="Basic "+Buffer.from(p.auth).toString("base64")),o=b._req=v(p),b._redirects&&b.emit("redirect",b.url,o)}else o=b._req=v(p);p.timeout&&o.on("timeout",()=>{M(b,o,"Opening handshake has timed out")}),o.on("error",a=>{null===o||o[E]||(o=b._req=null,J(b,a))}),o.on("response",e=>{let f=e.headers.location,h=e.statusCode;if(f&&p.followRedirects&&h>=300&&h<400){let e;if(++b._redirects>p.maxRedirects)return void M(b,o,"Maximum redirects exceeded");o.abort();try{e=new m(f,c)}catch(a){J(b,SyntaxError(`Invalid URL: ${f}`));return}a(b,e,d,g)}else b.emit("unexpected-response",o,e)||M(b,o,`Unexpected server response: ${e.statusCode}`)}),o.on("upgrade",(a,c,d)=>{let e;if(b.emit("upgrade",a),b.readyState!==I.CONNECTING)return;o=b._req=null;let f=a.headers.upgrade;if(void 0===f||"websocket"!==f.toLowerCase())return void M(b,c,"Invalid Upgrade header");let g=j("sha1").update(u+t).digest("base64");if(a.headers["sec-websocket-accept"]!==g)return void M(b,c,"Invalid Sec-WebSocket-Accept header");let h=a.headers["sec-websocket-protocol"];if(void 0!==h?w.size?w.has(h)||(e="Server sent an invalid subprotocol"):e="Server sent a subprotocol but none was requested":w.size&&(e="Server sent no subprotocol"),e)return void M(b,c,e);h&&(b._protocol=h);let i=a.headers["sec-websocket-extensions"];if(void 0!==i){let a;if(!l)return void M(b,c,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");try{a=C(i)}catch(a){M(b,c,"Invalid Sec-WebSocket-Extensions header");return}let d=Object.keys(a);if(1!==d.length||d[0]!==n.extensionName)return void M(b,c,"Server indicated an extension that was not requested");try{l.accept(a[n.extensionName])}catch(a){M(b,c,"Invalid Sec-WebSocket-Extensions header");return}b._extensions[n.extensionName]=l}b.setSocket(c,d,{allowSynchronousEvents:p.allowSynchronousEvents,generateMask:p.generateMask,maxPayload:p.maxPayload,skipUTF8Validation:p.skipUTF8Validation})}),p.finishRequest?p.finishRequest(o,b):o.end()}(this,a,b,c)):(this._autoPong=c.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(a){r.includes(a)&&(this._binaryType=a,this._receiver&&(this._receiver._binaryType=a))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(a,b,c){let d=new o({allowSynchronousEvents:c.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:c.maxPayload,skipUTF8Validation:c.skipUTF8Validation}),e=new p(a,this._extensions,c.generateMask);this._receiver=d,this._sender=e,this._socket=a,d[x]=this,e[x]=this,a[x]=this,d.on("conclude",O),d.on("drain",P),d.on("error",Q),d.on("message",S),d.on("ping",T),d.on("pong",U),e.onerror=W,a.setTimeout&&a.setTimeout(0),a.setNoDelay&&a.setNoDelay(),b.length>0&&a.unshift(b),a.on("close",Y),a.on("data",Z),a.on("end",$),a.on("error",_),this._readyState=I.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=I.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[n.extensionName]&&this._extensions[n.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=I.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(a,b){if(this.readyState!==I.CLOSED){if(this.readyState===I.CONNECTING)return void M(this,this._req,"WebSocket was closed before the connection was established");if(this.readyState===I.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=I.CLOSING,this._sender.close(a,b,!this._isServer,a=>{!a&&(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),X(this)}}pause(){this.readyState!==I.CONNECTING&&this.readyState!==I.CLOSED&&(this._paused=!0,this._socket.pause())}ping(a,b,c){if(this.readyState===I.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof a?(c=a,a=b=void 0):"function"==typeof b&&(c=b,b=void 0),"number"==typeof a&&(a=a.toString()),this.readyState!==I.OPEN)return void N(this,a,c);void 0===b&&(b=!this._isServer),this._sender.ping(a||s,b,c)}pong(a,b,c){if(this.readyState===I.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof a?(c=a,a=b=void 0):"function"==typeof b&&(c=b,b=void 0),"number"==typeof a&&(a=a.toString()),this.readyState!==I.OPEN)return void N(this,a,c);void 0===b&&(b=!this._isServer),this._sender.pong(a||s,b,c)}resume(){this.readyState!==I.CONNECTING&&this.readyState!==I.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(a,b,c){if(this.readyState===I.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof b&&(c=b,b={}),"number"==typeof a&&(a=a.toString()),this.readyState!==I.OPEN)return void N(this,a,c);let d={binary:"string"!=typeof a,mask:!this._isServer,compress:!0,fin:!0,...b};this._extensions[n.extensionName]||(d.compress=!1),this._sender.send(a||s,d,c)}terminate(){if(this.readyState!==I.CLOSED){if(this.readyState===I.CONNECTING)return void M(this,this._req,"WebSocket was closed before the connection was established");this._socket&&(this._readyState=I.CLOSING,this._socket.destroy())}}}function J(a,b){a._readyState=I.CLOSING,a._errorEmitted=!0,a.emit("error",b),a.emitClose()}function K(a){return a.path=a.socketPath,g.connect(a)}function L(a){return a.path=void 0,a.servername||""===a.servername||(a.servername=g.isIP(a.host)?"":a.host),h.connect(a)}function M(a,b,c){a._readyState=I.CLOSING;let d=Error(c);Error.captureStackTrace(d,M),b.setHeader?(b[E]=!0,b.abort(),b.socket&&!b.socket.destroyed&&b.socket.destroy(),process.nextTick(J,a,d)):(b.destroy(d),b.once("error",a.emit.bind(a,"error")),b.once("close",a.emitClose.bind(a)))}function N(a,b,c){if(b){let c=q(b)?b.size:D(b).length;a._socket?a._sender._bufferedBytes+=c:a._bufferedAmount+=c}if(c){let b=Error(`WebSocket is not open: readyState ${a.readyState} (${G[a.readyState]})`);process.nextTick(c,b)}}function O(a,b){let c=this[x];c._closeFrameReceived=!0,c._closeMessage=b,c._closeCode=a,void 0!==c._socket[x]&&(c._socket.removeListener("data",Z),process.nextTick(V,c._socket),1005===a?c.close():c.close(a,b))}function P(){let a=this[x];a.isPaused||a._socket.resume()}function Q(a){let b=this[x];void 0!==b._socket[x]&&(b._socket.removeListener("data",Z),process.nextTick(V,b._socket),b.close(a[w])),b._errorEmitted||(b._errorEmitted=!0,b.emit("error",a))}function R(){this[x].emitClose()}function S(a,b){this[x].emit("message",a,b)}function T(a){let b=this[x];b._autoPong&&b.pong(a,!this._isServer,y),b.emit("ping",a)}function U(a){this[x].emit("pong",a)}function V(a){a.resume()}function W(a){let b=this[x];b.readyState!==I.CLOSED&&(b.readyState===I.OPEN&&(b._readyState=I.CLOSING,X(b)),this._socket.end(),b._errorEmitted||(b._errorEmitted=!0,b.emit("error",a)))}function X(a){a._closeTimer=setTimeout(a._socket.destroy.bind(a._socket),3e4)}function Y(){let a,b=this[x];this.removeListener("close",Y),this.removeListener("data",Z),this.removeListener("end",$),b._readyState=I.CLOSING,this._readableState.endEmitted||b._closeFrameReceived||b._receiver._writableState.errorEmitted||null===(a=b._socket.read())||b._receiver.write(a),b._receiver.end(),this[x]=void 0,clearTimeout(b._closeTimer),b._receiver._writableState.finished||b._receiver._writableState.errorEmitted?b.emitClose():(b._receiver.on("error",R),b._receiver.on("finish",R))}function Z(a){this[x]._receiver.write(a)||this.pause()}function $(){let a=this[x];a._readyState=I.CLOSING,a._receiver.end(),this.end()}function _(){let a=this[x];this.removeListener("error",_),this.on("error",y),a&&(a._readyState=I.CLOSING,this.destroy())}Object.defineProperty(I,"CONNECTING",{enumerable:!0,value:G.indexOf("CONNECTING")}),Object.defineProperty(I.prototype,"CONNECTING",{enumerable:!0,value:G.indexOf("CONNECTING")}),Object.defineProperty(I,"OPEN",{enumerable:!0,value:G.indexOf("OPEN")}),Object.defineProperty(I.prototype,"OPEN",{enumerable:!0,value:G.indexOf("OPEN")}),Object.defineProperty(I,"CLOSING",{enumerable:!0,value:G.indexOf("CLOSING")}),Object.defineProperty(I.prototype,"CLOSING",{enumerable:!0,value:G.indexOf("CLOSING")}),Object.defineProperty(I,"CLOSED",{enumerable:!0,value:G.indexOf("CLOSED")}),Object.defineProperty(I.prototype,"CLOSED",{enumerable:!0,value:G.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(a=>{Object.defineProperty(I.prototype,a,{enumerable:!0})}),["open","error","close","message"].forEach(a=>{Object.defineProperty(I.prototype,`on${a}`,{enumerable:!0,get(){for(let b of this.listeners(a))if(b[u])return b[v];return null},set(b){for(let b of this.listeners(a))if(b[u]){this.removeListener(a,b);break}"function"==typeof b&&this.addEventListener(a,b,{[u]:!0})}})}),I.prototype.addEventListener=z,I.prototype.removeEventListener=A,a.exports=I},78086:(a,b,c)=>{"use strict";let{EMPTY_BUFFER:d}=c(63674),e=Buffer[Symbol.species];function f(a,b,c,d,e){for(let f=0;f<e;f++)c[d+f]=a[f]^b[3&f]}function g(a,b){for(let c=0;c<a.length;c++)a[c]^=b[3&c]}function h(a){let b;return(h.readOnly=!0,Buffer.isBuffer(a))?a:(a instanceof ArrayBuffer?b=new e(a):ArrayBuffer.isView(a)?b=new e(a.buffer,a.byteOffset,a.byteLength):(b=Buffer.from(a),h.readOnly=!1),b)}if(a.exports={concat:function(a,b){if(0===a.length)return d;if(1===a.length)return a[0];let c=Buffer.allocUnsafe(b),f=0;for(let b=0;b<a.length;b++){let d=a[b];c.set(d,f),f+=d.length}return f<b?new e(c.buffer,c.byteOffset,f):c},mask:f,toArrayBuffer:function(a){return a.length===a.buffer.byteLength?a.buffer:a.buffer.slice(a.byteOffset,a.byteOffset+a.length)},toBuffer:h,unmask:g},!process.env.WS_NO_BUFFER_UTIL)try{let b=c(39727);a.exports.mask=function(a,c,d,e,g){g<48?f(a,c,d,e,g):b.mask(a,c,d,e,g)},a.exports.unmask=function(a,c){a.length<32?g(a,c):b.unmask(a,c)}}catch(a){}},79164:(a,b,c)=>{"use strict";let d=c(27910).Readable,e=c(92513);class f extends d{constructor(a,b,c,d){if("number"!=typeof a)throw TypeError("Argument `statusCode` should be a number");if("object"!=typeof b)throw TypeError("Argument `headers` should be an object");if(!(c instanceof Buffer))throw TypeError("Argument `body` should be a buffer");if("string"!=typeof d)throw TypeError("Argument `url` should be a string");super(),this.statusCode=a,this.headers=e(b),this.body=c,this.url=d}_read(){this.push(this.body),this.push(null)}}a.exports=f},82411:(a,b,c)=>{var d=c(53775);function e(a){var b=function(){return b.called?b.value:(b.called=!0,b.value=a.apply(this,arguments))};return b.called=!1,b}function f(a){var b=function(){if(b.called)throw Error(b.onceError);return b.called=!0,b.value=a.apply(this,arguments)};return b.onceError=(a.name||"Function wrapped with `once`")+" shouldn't be called more than once",b.called=!1,b}a.exports=d(e),a.exports.strict=d(f),e.proto=e(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return e(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return f(this)},configurable:!0})})},86200:(a,b,c)=>{"use strict";let{isUtf8:d}=c(79428),{hasBlob:e}=c(63674);function f(a){let b=a.length,c=0;for(;c<b;)if((128&a[c])==0)c++;else if((224&a[c])==192){if(c+1===b||(192&a[c+1])!=128||(254&a[c])==192)return!1;c+=2}else if((240&a[c])==224){if(c+2>=b||(192&a[c+1])!=128||(192&a[c+2])!=128||224===a[c]&&(224&a[c+1])==128||237===a[c]&&(224&a[c+1])==160)return!1;c+=3}else{if((248&a[c])!=240||c+3>=b||(192&a[c+1])!=128||(192&a[c+2])!=128||(192&a[c+3])!=128||240===a[c]&&(240&a[c+1])==128||244===a[c]&&a[c+1]>143||a[c]>244)return!1;c+=4}return!0}if(a.exports={isBlob:function(a){return e&&"object"==typeof a&&"function"==typeof a.arrayBuffer&&"string"==typeof a.type&&"function"==typeof a.stream&&("Blob"===a[Symbol.toStringTag]||"File"===a[Symbol.toStringTag])},isValidStatusCode:function(a){return a>=1e3&&a<=1014&&1004!==a&&1005!==a&&1006!==a||a>=3e3&&a<=4999},isValidUTF8:f,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},d)a.exports.isValidUTF8=function(a){return a.length<24?f(a):d(a)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let b=c(47990);a.exports.isValidUTF8=function(a){return a.length<32?f(a):b(a)}}catch(a){}},86713:a=>{"use strict";a.exports=a=>{let b={protocol:a.protocol,hostname:"string"==typeof a.hostname&&a.hostname.startsWith("[")?a.hostname.slice(1,-1):a.hostname,host:a.host,hash:a.hash,search:a.search,pathname:a.pathname,href:a.href,path:`${a.pathname||""}${a.search||""}`};return"string"==typeof a.port&&0!==a.port.length&&(b.port=Number(a.port)),(a.username||a.password)&&(b.auth=`${a.username||""}:${a.password||""}`),b}},87935:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let c=new Set;b.default=a=>{c.has(a)||(c.add(a),process.emitWarning(`Got: ${a}`,{type:"DeprecationWarning"}))}},89124:function(a,b,c){"use strict";var d=this&&this.__createBinding||(Object.create?function(a,b,c,d){void 0===d&&(d=c),Object.defineProperty(a,d,{enumerable:!0,get:function(){return b[c]}})}:function(a,b,c,d){void 0===d&&(d=c),a[d]=b[c]}),e=this&&this.__exportStar||function(a,b){for(var c in a)"default"===c||Object.prototype.hasOwnProperty.call(b,c)||d(b,a,c)};Object.defineProperty(b,"__esModule",{value:!0}),b.defaultHandler=void 0;let f=c(35510),g=c(70187),h=c(42061),i=c(52188),j=c(96026),k={RequestError:g.RequestError,CacheError:g.CacheError,ReadError:g.ReadError,HTTPError:g.HTTPError,MaxRedirectsError:g.MaxRedirectsError,TimeoutError:g.TimeoutError,ParseError:g.ParseError,CancelError:g.CancelError,UnsupportedProtocolError:g.UnsupportedProtocolError,UploadError:g.UploadError},l=async a=>new Promise(b=>{setTimeout(b,a)}),{normalizeArguments:m}=i.default,n=(...a)=>{let b;for(let c of a)b=m(void 0,c,b);return b},o=a=>a.isStream?new i.default(void 0,a):g.default(a),p=a=>"defaults"in a&&"options"in a.defaults,q=["get","post","put","patch","head","delete"];b.defaultHandler=(a,b)=>b(a);let r=(a,b)=>{if(a)for(let c of a)c(b)},s=a=>{a._rawHandlers=a.handlers,a.handlers=a.handlers.map(a=>(b,c)=>{let d,e=a(b,a=>d=c(a));if(e!==d&&!b.isStream&&d){let{then:a,catch:b,finally:c}=e;Object.setPrototypeOf(e,Object.getPrototypeOf(d)),Object.defineProperties(e,Object.getOwnPropertyDescriptors(d)),e.then=a,e.catch=b,e.finally=c}return e});let c=(b,c={},d)=>{var e,j;let k=0,l=b=>a.handlers[k++](b,k===a.handlers.length?o:l);if(f.default.plainObject(b)){let a={...b,...c};i.setNonEnumerableProperties([b,c],a),c=a,b=void 0}try{let f;try{r(a.options.hooks.init,c),r(null==(e=c.hooks)?void 0:e.init,c)}catch(a){f=a}let h=m(b,c,null!=d?d:a.options);if(h[i.kIsNormalizedAlready]=!0,f)throw new g.RequestError(f.message,f,h);return l(h)}catch(b){if(!c.isStream)return h.default(b,a.options.hooks.beforeError,null==(j=c.hooks)?void 0:j.beforeError);throw b}};c.extend=(...c)=>{let d,e=[a.options],f=[...a._rawHandlers];for(let a of c)p(a)?(e.push(a.defaults.options),f.push(...a.defaults._rawHandlers),d=a.defaults.mutableDefaults):(e.push(a),"handlers"in a&&f.push(...a.handlers),d=a.mutableDefaults);return 0===(f=f.filter(a=>a!==b.defaultHandler)).length&&f.push(b.defaultHandler),s({options:n(...e),handlers:f,mutableDefaults:!!d})};let d=async function*(b,d){let e=m(b,d,a.options);e.resolveBodyOnly=!1;let g=e.pagination;if(!f.default.object(g))throw TypeError("`options.pagination` must be implemented");let h=[],{countLimit:i}=g,j=0;for(;j<g.requestLimit;){0!==j&&await l(g.backoff);let a=await c(void 0,void 0,e),b=await g.transform(a),d=[];for(let a of b)if(g.filter(a,h,d)&&(!g.shouldContinue(a,h,d)||(yield a,g.stackAllItems&&h.push(a),d.push(a),--i<=0)))return;let f=g.paginate(a,h,d);if(!1===f)return;f===a.request.options?e=a.request.options:void 0!==f&&(e=m(void 0,f,e)),j++}};for(let a of(c.paginate=d,c.paginate.all=async(a,b)=>{let c=[];for await(let e of d(a,b))c.push(e);return c},c.paginate.each=d,c.stream=(a,b)=>c(a,{...b,isStream:!0}),q))c[a]=(b,d)=>c(b,{...d,method:a}),c.stream[a]=(b,d)=>c(b,{...d,method:a,isStream:!0});return Object.assign(c,k),Object.defineProperty(c,"defaults",{value:a.mutableDefaults?a:j.default(a),writable:a.mutableDefaults,configurable:a.mutableDefaults,enumerable:!0}),c.mergeOptions=n,c};b.default=s,e(c(4847),b)},90826:function(a,b,c){"use strict";var d=this&&this.__createBinding||(Object.create?function(a,b,c,d){void 0===d&&(d=c),Object.defineProperty(a,d,{enumerable:!0,get:function(){return b[c]}})}:function(a,b,c,d){void 0===d&&(d=c),a[d]=b[c]}),e=this&&this.__exportStar||function(a,b){for(var c in a)"default"===c||Object.prototype.hasOwnProperty.call(b,c)||d(b,a,c)};Object.defineProperty(b,"__esModule",{value:!0}),b.CancelError=b.ParseError=void 0;let f=c(52188);class g extends f.RequestError{constructor(a,b){let{options:c}=b.request;super(`${a.message} in "${c.url.toString()}"`,a,b.request),this.name="ParseError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_BODY_PARSE_FAILURE":this.code}}b.ParseError=g;class h extends f.RequestError{constructor(a){super("Promise was canceled",{},a),this.name="CancelError",this.code="ERR_CANCELED"}get isCanceled(){return!0}}b.CancelError=h,e(c(52188),b)},90968:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(35510);b.default=a=>d.default.nodeStream(a)&&d.default.function_(a.getBoundary)},92045:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.isResponseOk=void 0,b.isResponseOk=a=>{let{statusCode:b}=a,c=a.request.options.followRedirect?299:399;return b>=200&&b<=c||304===b}},92513:a=>{"use strict";a.exports=a=>{let b={};for(let[c,d]of Object.entries(a))b[c.toLowerCase()]=d;return b}},92577:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(29021),e=c(28354),f=c(35510),g=c(90968),h=e.promisify(d.stat);b.default=async(a,b)=>{if(b&&"content-length"in b)return Number(b["content-length"]);if(!a)return 0;if(f.default.string(a))return Buffer.byteLength(a);if(f.default.buffer(a))return a.length;if(g.default(a))return e.promisify(a.getLength.bind(a))();if(a instanceof d.ReadStream){let{size:b}=await h(a.path);if(0===b)return;return b}}},92582:(a,b,c)=>{"use strict";let{Transform:d,PassThrough:e}=c(27910),f=c(74075),g=c(14501);a.exports=a=>{let b=(a.headers["content-encoding"]||"").toLowerCase();if(!["gzip","deflate","br"].includes(b))return a;let c="br"===b;if(c&&"function"!=typeof f.createBrotliDecompress)return a.destroy(Error("Brotli is not supported on Node.js < 12")),a;let h=!0,i=new d({transform(a,b,c){h=!1,c(null,a)},flush(a){a()}}),j=new e({autoDestroy:!1,destroy(b,c){a.destroy(),c(b)}}),k=c?f.createBrotliDecompress():f.createUnzip();return k.once("error",b=>{if(h&&!a.readable)return void j.end();j.destroy(b)}),g(a,j),a.pipe(i).pipe(k).pipe(j),j}},92910:(a,b,c)=>{"use strict";let d,{Duplex:e}=c(27910),{randomFillSync:f}=c(55511),g=c(20879),{EMPTY_BUFFER:h,kWebSocket:i,NOOP:j}=c(63674),{isBlob:k,isValidStatusCode:l}=c(86200),{mask:m,toBuffer:n}=c(78086),o=Symbol("kByteLength"),p=Buffer.alloc(4),q=8192;class r{constructor(a,b,c){this._extensions=b||{},c&&(this._generateMask=c,this._maskBuffer=Buffer.alloc(4)),this._socket=a,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=j,this[i]=void 0}static frame(a,b){let c,e,g=!1,h=2,i=!1;b.mask&&(c=b.maskBuffer||p,b.generateMask?b.generateMask(c):(8192===q&&(void 0===d&&(d=Buffer.alloc(8192)),f(d,0,8192),q=0),c[0]=d[q++],c[1]=d[q++],c[2]=d[q++],c[3]=d[q++]),i=(c[0]|c[1]|c[2]|c[3])==0,h=6),"string"==typeof a?e=(!b.mask||i)&&void 0!==b[o]?b[o]:(a=Buffer.from(a)).length:(e=a.length,g=b.mask&&b.readOnly&&!i);let j=e;e>=65536?(h+=8,j=127):e>125&&(h+=2,j=126);let k=Buffer.allocUnsafe(g?e+h:h);return(k[0]=b.fin?128|b.opcode:b.opcode,b.rsv1&&(k[0]|=64),k[1]=j,126===j?k.writeUInt16BE(e,2):127===j&&(k[2]=k[3]=0,k.writeUIntBE(e,4,6)),b.mask)?(k[1]|=128,k[h-4]=c[0],k[h-3]=c[1],k[h-2]=c[2],k[h-1]=c[3],i)?[k,a]:g?(m(a,c,k,h,e),[k]):(m(a,c,a,0,e),[k,a]):[k,a]}close(a,b,c,d){let e;if(void 0===a)e=h;else if("number"==typeof a&&l(a))if(void 0!==b&&b.length){let c=Buffer.byteLength(b);if(c>123)throw RangeError("The message must not be greater than 123 bytes");(e=Buffer.allocUnsafe(2+c)).writeUInt16BE(a,0),"string"==typeof b?e.write(b,2):e.set(b,2)}else(e=Buffer.allocUnsafe(2)).writeUInt16BE(a,0);else throw TypeError("First argument must be a valid error code number");let f={[o]:e.length,fin:!0,generateMask:this._generateMask,mask:c,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,e,!1,f,d]):this.sendFrame(r.frame(e,f),d)}ping(a,b,c){let d,e;if("string"==typeof a?(d=Buffer.byteLength(a),e=!1):k(a)?(d=a.size,e=!1):(d=(a=n(a)).length,e=n.readOnly),d>125)throw RangeError("The data size must not be greater than 125 bytes");let f={[o]:d,fin:!0,generateMask:this._generateMask,mask:b,maskBuffer:this._maskBuffer,opcode:9,readOnly:e,rsv1:!1};k(a)?0!==this._state?this.enqueue([this.getBlobData,a,!1,f,c]):this.getBlobData(a,!1,f,c):0!==this._state?this.enqueue([this.dispatch,a,!1,f,c]):this.sendFrame(r.frame(a,f),c)}pong(a,b,c){let d,e;if("string"==typeof a?(d=Buffer.byteLength(a),e=!1):k(a)?(d=a.size,e=!1):(d=(a=n(a)).length,e=n.readOnly),d>125)throw RangeError("The data size must not be greater than 125 bytes");let f={[o]:d,fin:!0,generateMask:this._generateMask,mask:b,maskBuffer:this._maskBuffer,opcode:10,readOnly:e,rsv1:!1};k(a)?0!==this._state?this.enqueue([this.getBlobData,a,!1,f,c]):this.getBlobData(a,!1,f,c):0!==this._state?this.enqueue([this.dispatch,a,!1,f,c]):this.sendFrame(r.frame(a,f),c)}send(a,b,c){let d,e,f=this._extensions[g.extensionName],h=b.binary?2:1,i=b.compress;"string"==typeof a?(d=Buffer.byteLength(a),e=!1):k(a)?(d=a.size,e=!1):(d=(a=n(a)).length,e=n.readOnly),this._firstFragment?(this._firstFragment=!1,i&&f&&f.params[f._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(i=d>=f._threshold),this._compress=i):(i=!1,h=0),b.fin&&(this._firstFragment=!0);let j={[o]:d,fin:b.fin,generateMask:this._generateMask,mask:b.mask,maskBuffer:this._maskBuffer,opcode:h,readOnly:e,rsv1:i};k(a)?0!==this._state?this.enqueue([this.getBlobData,a,this._compress,j,c]):this.getBlobData(a,this._compress,j,c):0!==this._state?this.enqueue([this.dispatch,a,this._compress,j,c]):this.dispatch(a,this._compress,j,c)}getBlobData(a,b,c,d){this._bufferedBytes+=c[o],this._state=2,a.arrayBuffer().then(a=>{if(this._socket.destroyed){let a=Error("The socket was closed while the blob was being read");process.nextTick(s,this,a,d);return}this._bufferedBytes-=c[o];let e=n(a);b?this.dispatch(e,b,c,d):(this._state=0,this.sendFrame(r.frame(e,c),d),this.dequeue())}).catch(a=>{process.nextTick(t,this,a,d)})}dispatch(a,b,c,d){if(!b)return void this.sendFrame(r.frame(a,c),d);let e=this._extensions[g.extensionName];this._bufferedBytes+=c[o],this._state=1,e.compress(a,c.fin,(a,b)=>{if(this._socket.destroyed)return void s(this,Error("The socket was closed while data was being compressed"),d);this._bufferedBytes-=c[o],this._state=0,c.readOnly=!1,this.sendFrame(r.frame(b,c),d),this.dequeue()})}dequeue(){for(;0===this._state&&this._queue.length;){let a=this._queue.shift();this._bufferedBytes-=a[3][o],Reflect.apply(a[0],this,a.slice(1))}}enqueue(a){this._bufferedBytes+=a[3][o],this._queue.push(a)}sendFrame(a,b){2===a.length?(this._socket.cork(),this._socket.write(a[0]),this._socket.write(a[1],b),this._socket.uncork()):this._socket.write(a[0],b)}}function s(a,b,c){"function"==typeof c&&c(b);for(let c=0;c<a._queue.length;c++){let d=a._queue[c],e=d[d.length-1];"function"==typeof e&&e(b)}}function t(a,b,c){s(a,b,c),a.onerror(b)}a.exports=r},93196:a=>{"use strict";let b=(b,c,d)=>{a.exports[c]=class extends b{constructor(...a){super("string"==typeof d?d:d(a)),this.name=`${super.name} [${c}]`,this.code=c}}};b(TypeError,"ERR_INVALID_ARG_TYPE",a=>{let b=a[0].includes(".")?"property":"argument",c=a[1],d=Array.isArray(c);return d&&(c=`${c.slice(0,-1).join(", ")} or ${c.slice(-1)}`),`The "${a[0]}" ${b} must be ${d?"one of":"of"} type ${c}. Received ${typeof a[2]}`}),b(TypeError,"ERR_INVALID_PROTOCOL",a=>`Protocol "${a[0]}" not supported. Expected "${a[1]}"`),b(Error,"ERR_HTTP_HEADERS_SENT",a=>`Cannot ${a[0]} headers after they are sent to the client`),b(TypeError,"ERR_INVALID_HTTP_TOKEN",a=>`${a[0]} must be a valid HTTP token [${a[1]}]`),b(TypeError,"ERR_HTTP_INVALID_HEADER_VALUE",a=>`Invalid value "${a[0]} for header "${a[1]}"`),b(TypeError,"ERR_INVALID_CHAR",a=>`Invalid character in ${a[0]} [${a[1]}]`)},96026:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});let d=c(35510);b.default=function a(b){for(let c of Object.values(b))(d.default.plainObject(c)||d.default.array(c))&&a(c);return Object.freeze(b)}},98233:(a,b)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.default=()=>{let a=[];return{once(b,c,d){b.once(c,d),a.push({origin:b,event:c,fn:d})},unhandleAll(){for(let b of a){let{origin:a,event:c,fn:d}=b;a.removeListener(c,d)}a.length=0}}}},98546:(a,b,c)=>{"use strict";let d=c(81630),e=c(55591),f=c(52873),g=c(17632),h=c(1138),i=c(50511),j=c(86713),k=new g({maxSize:100}),l=new Map,m=(a,b,c)=>{b._httpMessage={shouldKeepAlive:!0};let d=()=>{a.emit("free",b,c)};b.on("free",d);let e=()=>{a.removeSocket(b,c)};b.on("close",e);let f=()=>{a.removeSocket(b,c),b.off("close",e),b.off("free",d),b.off("agentRemove",f)};b.on("agentRemove",f),a.emit("free",b,c)},n=async a=>{let b=`${a.host}:${a.port}:${a.ALPNProtocols.sort()}`;if(!k.has(b)){if(l.has(b))return(await l.get(b)).alpnProtocol;let{path:c,agent:d}=a;a.path=a.socketPath;let g=f(a);l.set(b,g);try{let{socket:f,alpnProtocol:h}=await g;if(k.set(b,h),a.path=c,"h2"===h)f.destroy();else{let{globalAgent:b}=e,c=e.Agent.prototype.createConnection;d?d.createConnection===c?m(d,f,a):f.destroy():b.createConnection===c?m(b,f,a):f.destroy()}return l.delete(b),h}catch(a){throw l.delete(b),a}}return k.get(b)};a.exports=async(a,b,c)=>{if(("string"==typeof a||a instanceof URL)&&(a=j(new URL(a))),"function"==typeof b&&(c=b,b=void 0),!Array.isArray((b={ALPNProtocols:["h2","http/1.1"],...a,...b,resolveSocket:!0}).ALPNProtocols)||0===b.ALPNProtocols.length)throw Error("The `ALPNProtocols` option must be an Array with at least one entry");b.protocol=b.protocol||"https:";let f="https:"===b.protocol;b.host=b.hostname||b.host||"localhost",b.session=b.tlsSession,b.servername=b.servername||i(b),b.port=b.port||(f?443:80),b._defaultAgent=f?e.globalAgent:d.globalAgent;let g=b.agent;if(g){if(g.addRequest)throw Error("The `options.agent` object can contain only `http`, `https` or `http2` properties");b.agent=g[f?"https":"http"]}return f&&"h2"===await n(b)?(g&&(b.agent=g.http2),new h(b,c)):d.request(b,c)},a.exports.protocolCache=k},99620:a=>{"use strict";class b extends Error{constructor(a){super(a||"Promise was canceled"),this.name="CancelError"}get isCanceled(){return!0}}class c{static fn(a){return(...b)=>new c((c,d,e)=>{b.push(e),a(...b).then(c,d)})}constructor(a){this._cancelHandlers=[],this._isPending=!0,this._isCanceled=!1,this._rejectOnCancel=!0,this._promise=new Promise((b,c)=>{this._reject=c;let d=a=>{this._isCanceled&&f.shouldReject||(this._isPending=!1,b(a))},e=a=>{this._isPending=!1,c(a)},f=a=>{if(!this._isPending)throw Error("The `onCancel` handler was attached after the promise settled.");this._cancelHandlers.push(a)};return Object.defineProperties(f,{shouldReject:{get:()=>this._rejectOnCancel,set:a=>{this._rejectOnCancel=a}}}),a(d,e,f)})}then(a,b){return this._promise.then(a,b)}catch(a){return this._promise.catch(a)}finally(a){return this._promise.finally(a)}cancel(a){if(this._isPending&&!this._isCanceled){if(this._isCanceled=!0,this._cancelHandlers.length>0)try{for(let a of this._cancelHandlers)a()}catch(a){this._reject(a);return}this._rejectOnCancel&&this._reject(new b(a))}}get isCanceled(){return this._isCanceled}}Object.setPrototypeOf(c.prototype,Promise.prototype),a.exports=c,a.exports.CancelError=b}};