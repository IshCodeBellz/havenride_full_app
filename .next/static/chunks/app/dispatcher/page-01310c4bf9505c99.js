(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6822],{1423:(e,s,r)=>{"use strict";r.d(s,{c:()=>n});var t=r(576);let l=null,i=!1;function n(e){let s=function(){if(i)return null;if(l)return l;let e="xxx:yyy";if(!e)return console.warn("Ably key not configured - real-time features will be disabled"),i=!0,null;try{return(l=new t.Realtime(e)).connection.on("failed",e=>{console.error("Ably connection failed:",e.reason),i=!0}),l}catch(e){return console.error("Failed to initialize Ably:",e),i=!0,null}}();return s?s.channels.get(e):{subscribe:()=>{},unsubscribe:()=>{},isMock:!0}}},3371:(e,s,r)=>{"use strict";r.d(s,{A:()=>a});var t=r(5155),l=r(2115),i=r(63),n=r(5419);function a(e){let{children:s,requiredRole:r}=e,{user:a,isLoaded:d}=(0,n.Jd)(),c=(0,i.useRouter)(),[o,u]=(0,l.useState)(!0),[h,x]=(0,l.useState)(!1);return((0,l.useEffect)(()=>{!async function(){if(d){if(!(null==a?void 0:a.id))return c.push("/");try{try{let e=await fetch("/api/users/ensure-role");if(!e.ok){let s=await e.text();console.error("Failed to ensure role:",s)}}catch(e){console.error("Error calling ensure-role:",e)}let e=await fetch("/api/users/me");if(!e.ok){console.error("Failed to fetch user data"),c.push("/");return}let s=(await e.json()).role;if(console.log("RoleGate: User role is",s,"Required:",r),!s){console.log("RoleGate: No role found, redirecting home"),c.push("/");return}if(r&&!r.includes(s)){console.log("RoleGate: User doesn't have required role, redirecting to their dashboard"),"RIDER"===s?c.push("/rider"):"DRIVER"===s?c.push("/driver"):"DISPATCHER"===s?c.push("/dispatcher"):"ADMIN"===s?c.push("/admin"):c.push("/");return}console.log("RoleGate: Access granted"),x(!0)}catch(e){console.error("Error checking role:",e)}finally{u(!1)}}}()},[a,d,c,r]),o)?(0,t.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,t.jsx)("div",{className:"text-center",children:"Loading..."})}):h?(0,t.jsx)(t.Fragment,{children:s}):null}},3694:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>c});var t=r(5155),l=r(2115),i=r(5419),n=r(1423),a=r(3371);function d(){let{user:e}=(0,i.Jd)(),[s,r]=(0,l.useState)([]),[a,d]=(0,l.useState)(!0);async function c(){try{let e=await fetch("/api/bookings"),s=await e.json();r(Array.isArray(s)?s:[])}catch(e){console.error(e)}finally{d(!1)}}async function o(e,s){(await fetch("/api/bookings/".concat(e,"/status"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"ASSIGNED",driverId:s})})).ok&&c()}(0,l.useEffect)(()=>{var e;c();let s=(0,n.c)("dispatch"),r=()=>{c()};null==s||null==(e=s.subscribe)||e.call(s,r);let t=setInterval(c,1e4);return()=>{var e;null==s||null==(e=s.unsubscribe)||e.call(s,r),clearInterval(t)}},[]);let u=s.filter(e=>"REQUESTED"===e.status),h=s.filter(e=>"COMPLETED"!==e.status&&"CANCELED"!==e.status&&e.driverId);return(0,t.jsxs)("div",{className:"max-w-6xl mx-auto p-6 space-y-6",children:[(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"Dispatcher Console"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Assign rides and monitor operations"})]}),a?(0,t.jsx)("div",{children:"Loading..."}):(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,t.jsxs)("div",{className:"border rounded-lg p-6",children:[(0,t.jsxs)("h2",{className:"text-xl font-semibold mb-4",children:["New Requests (",u.length,")"]}),(0,t.jsx)("div",{className:"space-y-3",children:0===u.length?(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"No new requests"}):u.map(s=>(0,t.jsxs)("div",{className:"border rounded p-3",children:[(0,t.jsxs)("div",{className:"text-sm font-semibold mb-1",children:[s.pickupAddress," → ",s.dropoffAddress]}),(0,t.jsxs)("div",{className:"text-xs text-gray-600 mb-2",children:["Status: ",s.status,s.requiresWheelchair&&" • ♿"]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500",children:["Rider: ",s.riderId.slice(0,8),"..."]}),(0,t.jsx)("div",{className:"mt-2 flex gap-2",children:(0,t.jsx)("button",{onClick:()=>o(s.id,(null==e?void 0:e.id)||""),className:"px-3 py-1 btn-primary text-xs rounded",children:"Assign to Me"})})]},s.id))})]}),(0,t.jsxs)("div",{className:"border rounded-lg p-6",children:[(0,t.jsxs)("h2",{className:"text-xl font-semibold mb-4",children:["Active Rides (",h.length,")"]}),(0,t.jsx)("div",{className:"space-y-3",children:0===h.length?(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"No active rides"}):h.map(e=>{var s;return(0,t.jsxs)("div",{className:"border rounded p-3",children:[(0,t.jsxs)("div",{className:"text-sm font-semibold mb-1",children:[e.pickupAddress," → ",e.dropoffAddress]}),(0,t.jsxs)("div",{className:"text-xs text-gray-600 mb-1",children:["Status: ",e.status," • Driver:"," ",(null==(s=e.driverId)?void 0:s.slice(0,8))||"Unassigned"]}),e.requiresWheelchair&&(0,t.jsx)("div",{className:"text-xs text-green-600",children:"♿ Wheelchair"})]},e.id)})})]})]}),(0,t.jsxs)("div",{className:"border rounded-lg p-6",children:[(0,t.jsxs)("h2",{className:"text-xl font-semibold mb-4",children:["All Bookings (",s.length,")"]}),(0,t.jsx)("div",{className:"text-sm text-gray-500 space-y-1",children:0===s.length?(0,t.jsx)("div",{children:"No bookings yet"}):(0,t.jsxs)("div",{children:["Requested: ",u.length," • Active: ",h.length," • Completed:"," ",s.filter(e=>"COMPLETED"===e.status).length]})})]})]})}function c(){return(0,t.jsx)(a.A,{requiredRole:["DISPATCHER"],children:(0,t.jsx)(d,{})})}},5682:(e,s,r)=>{Promise.resolve().then(r.bind(r,3694))}},e=>{e.O(0,[2996,1162,8441,1255,7358],()=>e(e.s=5682)),_N_E=e.O()}]);