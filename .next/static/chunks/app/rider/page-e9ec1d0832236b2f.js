(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[957],{371:(e,t,s)=>{Promise.resolve().then(s.bind(s,5760))},3383:()=>{},5760:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var r=s(5155),n=s(2115),l=s(5419),a=s(4424);function i(e){let{value:t,onChange:s,placeholder:l="Enter address",label:a,required:i=!1}=e,o=(0,n.useRef)(null),[c,d]=(0,n.useState)([]),[u,m]=(0,n.useState)(!1),[x,p]=(0,n.useState)(!1),h=(0,n.useRef)(),f=async e=>{if(!e||e.length<3)return void d([]);p(!0);try{let t=await fetch("https://api.mapbox.com/geocoding/v5/mapbox.places/".concat(encodeURIComponent(e),".json?access_token=").concat("pk.eyJ1IjoieWVtaWJlbGxvIiwiYSI6ImNtZ3ZlbTkyODA3c2syanNpYXB3cGN0enkifQ.VL-Xsf4TkrZ1cX7dnzsc4g","&country=GB&limit=5")),s=await t.json();d(s.features||[]),m(!0)}catch(e){console.error("Geocoding error:",e),d([])}finally{p(!1)}};return(0,n.useEffect)(()=>{let e=e=>{o.current&&!o.current.contains(e.target)&&m(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,r.jsxs)("div",{className:"relative",ref:o,children:[a&&(0,r.jsxs)("label",{className:"block text-sm font-medium mb-2",children:[a,i&&(0,r.jsx)("span",{className:"text-red-500 ml-1",children:"*"})]}),(0,r.jsx)("input",{type:"text",value:t,onChange:e=>{let t=e.target.value;s(t,{lat:0,lng:0}),h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{f(t)},300)},onFocus:()=>c.length>0&&m(!0),placeholder:l,required:i,className:"w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#00796B] focus:border-transparent"}),x&&(0,r.jsx)("div",{className:"absolute right-3 top-[50%] translate-y-[-50%]",children:(0,r.jsx)("div",{className:"w-5 h-5 border-2 border-[#00796B] border-t-transparent rounded-full animate-spin"})}),u&&c.length>0&&(0,r.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-xl shadow-lg max-h-60 overflow-y-auto",children:c.map((e,t)=>(0,r.jsxs)("button",{type:"button",onClick:()=>(e=>{let[t,r]=e.center;s(e.place_name,{lat:r,lng:t}),d([]),m(!1)})(e),className:"w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b last:border-b-0",children:[(0,r.jsx)("div",{className:"font-medium text-sm text-[#263238]",children:e.text}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:e.place_name})]},t))})]})}var o=s(7856),c=s.n(o);function d(e){let{pickup:t,dropoff:s,driverLocation:l,className:a="w-full h-96"}=e,i=(0,n.useRef)(null),o=(0,n.useRef)(null),d=(0,n.useRef)(null),u=(0,n.useRef)(null),m=(0,n.useRef)(null);(0,n.useEffect)(()=>{if(i.current&&!o.current)return c().accessToken="pk.eyJ1IjoieWVtaWJlbGxvIiwiYSI6ImNtZ3ZlbTkyODA3c2syanNpYXB3cGN0enkifQ.VL-Xsf4TkrZ1cX7dnzsc4g",o.current=new(c()).Map({container:i.current,style:"mapbox://styles/mapbox/streets-v12",center:[-.1278,51.5074],zoom:12}),o.current.addControl(new(c()).NavigationControl,"top-right"),()=>{var e;null==(e=o.current)||e.remove(),o.current=null}},[]),(0,n.useEffect)(()=>{if(o.current&&t&&0!==t.lat){if(d.current)d.current.setLngLat([t.lng,t.lat]);else{let e=document.createElement("div");e.className="w-10 h-10",e.innerHTML='\n        <div class="relative">\n          <div class="absolute inset-0 bg-[#00796B] rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">\n            A\n          </div>\n        </div>\n      ',d.current=new(c()).Marker({element:e}).setLngLat([t.lng,t.lat]).setPopup(new(c()).Popup().setHTML("<strong>Pickup Location</strong>")).addTo(o.current)}x()}},[t]),(0,n.useEffect)(()=>{if(o.current&&s&&0!==s.lat){if(u.current)u.current.setLngLat([s.lng,s.lat]);else{let e=document.createElement("div");e.className="w-10 h-10",e.innerHTML='\n        <div class="relative">\n          <div class="absolute inset-0 bg-[#26A69A] rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">\n            B\n          </div>\n        </div>\n      ',u.current=new(c()).Marker({element:e}).setLngLat([s.lng,s.lat]).setPopup(new(c()).Popup().setHTML("<strong>Drop-off Location</strong>")).addTo(o.current)}x()}},[s]),(0,n.useEffect)(()=>{if(o.current&&l&&0!==l.lat){if(m.current)m.current.setLngLat([l.lng,l.lat]);else{let e=document.createElement("div");e.className="w-10 h-10",e.innerHTML='\n        <div class="relative">\n          <div class="absolute inset-0 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl shadow-lg">\n            \uD83D\uDE90\n          </div>\n        </div>\n      ',m.current=new(c()).Marker({element:e}).setLngLat([l.lng,l.lat]).setPopup(new(c()).Popup().setHTML("<strong>Driver Location</strong>")).addTo(o.current)}x()}},[l]),(0,n.useEffect)(()=>{o.current&&t&&s&&0!==t.lat&&0!==s.lat&&(async()=>{try{let l=await fetch("https://api.mapbox.com/directions/v5/mapbox/driving/".concat(t.lng,",").concat(t.lat,";").concat(s.lng,",").concat(s.lat,"?geometries=geojson&access_token=").concat("pk.eyJ1IjoieWVtaWJlbGxvIiwiYSI6ImNtZ3ZlbTkyODA3c2syanNpYXB3cGN0enkifQ.VL-Xsf4TkrZ1cX7dnzsc4g")),a=await l.json();if(a.routes&&a.routes[0]){var e,r,n;let t=a.routes[0].geometry;(null==(e=o.current)?void 0:e.getSource("route"))&&(o.current.removeLayer("route"),o.current.removeSource("route")),null==(r=o.current)||r.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:t}}),null==(n=o.current)||n.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#00796B","line-width":4,"line-opacity":.75}})}}catch(e){console.error("Error drawing route:",e)}})()},[t,s]);let x=()=>{if(!o.current)return;let e=new(c()).LngLatBounds,r=!1;t&&0!==t.lat&&(e.extend([t.lng,t.lat]),r=!0),s&&0!==s.lat&&(e.extend([s.lng,s.lat]),r=!0),l&&0!==l.lat&&(e.extend([l.lng,l.lat]),r=!0),r&&o.current.fitBounds(e,{padding:80,maxZoom:15,duration:1e3})};return(0,r.jsx)("div",{className:"".concat(a," rounded-xl overflow-hidden border border-gray-300"),children:(0,r.jsx)("div",{ref:i,className:"w-full h-full"})})}s(3383);var u=s(4524),m=s(1423),x=s(3371);function p(){let{user:e}=(0,l.Jd)(),t=(0,n.useRef)(!1),[s,o]=(0,n.useState)(""),[c,u]=(0,n.useState)(null),[x,p]=(0,n.useState)(""),[h,f]=(0,n.useState)(null),[g,b]=(0,n.useState)(!1),[v,j]=(0,n.useState)(null),[y,N]=(0,n.useState)(!1),[w,k]=(0,n.useState)(null),[E,L]=(0,n.useState)([]),[C,T]=(0,n.useState)(null),D=(0,n.useCallback)(async()=>{if(!t.current){t.current=!0;try{let t=await fetch("/api/bookings"),s=(await t.json()).filter(t=>t.riderId===(null==e?void 0:e.id));L(s);let r=s.find(e=>"COMPLETED"!==e.status&&"CANCELED"!==e.status);r&&!C&&T(r.id)}catch(e){console.error(e)}finally{t.current=!1}}},[null==e?void 0:e.id,C]);async function I(){if(!s||!x||!c||!h||0===c.lat||0===h.lat)return void alert("Please select valid pickup and dropoff locations");N(!0);try{let e=await fetch("/api/estimate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pickup:c,dropoff:h,requiresWheelchair:g})}),t=await e.json();j(t)}catch(e){console.error(e)}finally{N(!1)}}async function S(){if(!e)return void alert("Please sign in to book a ride");N(!0);try{let t=await fetch("/api/payments/create-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:Math.round(100*v.amount),currency:"gbp"})}),{clientSecret:r}=await t.json(),n=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({riderId:e.id,pickupAddress:s,dropoffAddress:x,pickupTime:new Date,pickupLat:null==c?void 0:c.lat,pickupLng:null==c?void 0:c.lng,dropoffLat:null==h?void 0:h.lat,dropoffLng:null==h?void 0:h.lng,requiresWheelchair:g,priceEstimate:v,paymentIntentId:r})});if(n.ok){let e=await n.json();k(e),o(""),u(null),p(""),f(null),j(null)}}catch(e){console.error(e),alert("Failed to book ride")}finally{N(!1)}}return(0,n.useEffect)(()=>{if(!(null==e?void 0:e.id))return;D();let t=null,s=!1,r=null;try{t=(0,m.c)("rider:".concat(e.id)),r=()=>D(),t&&!t.isMock&&"function"==typeof t.subscribe&&(t.subscribe(r),s=!0)}catch(e){console.warn("Ably subscription failed")}let n=setInterval(D,1e4);return()=>{clearInterval(n);try{s&&t&&r&&"function"==typeof t.unsubscribe&&t.unsubscribe(r)}catch(e){console.warn("Cleanup error:",e)}}},[null==e?void 0:e.id,D]),(0,r.jsxs)("div",{className:"px-8 py-6 max-w-7xl mx-auto",children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsxs)("h1",{className:"text-3xl font-bold text-[#0F3D3E] mb-2",children:["Welcome, ",(null==e?void 0:e.firstName)||"Rider"]}),(0,r.jsx)("p",{className:"text-gray-600",children:"Where would you like to go today?"})]}),!w&&(0,r.jsxs)("div",{className:"bg-white rounded-2xl p-8 shadow-sm mb-8",children:[(0,r.jsx)("h2",{className:"text-2xl font-semibold text-[#0F3D3E] mb-6",children:"Where to?"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(i,{value:s,onChange:(e,t)=>{o(e),u(t)},placeholder:"Pickup location",label:"Pickup Address",required:!0}),(0,r.jsx)(i,{value:x,onChange:(e,t)=>{p(e),f(t)},placeholder:"Enter destination",label:"Drop-off Address",required:!0}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"checkbox",id:"wheelchair",checked:g,onChange:e=>b(e.target.checked),className:"w-4 h-4"}),(0,r.jsx)("label",{htmlFor:"wheelchair",className:"text-sm",children:"Wheelchair accessible vehicle"})]}),(0,r.jsx)("button",{onClick:I,disabled:!s||!x||!c||!h||(null==c?void 0:c.lat)===0||(null==h?void 0:h.lat)===0||y,className:"w-full bg-[#00796B] text-white py-3 rounded-xl font-semibold hover:bg-[#00796B]/90 transition-colors disabled:opacity-50",children:y?"Estimating...":"Get Estimate"}),v&&(0,r.jsxs)("div",{className:"border-t pt-4 space-y-2",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"Estimated Fare:"}),(0,r.jsxs)("span",{className:"font-bold text-lg",children:["\xa3",v.amount.toFixed(2)]})]}),(0,r.jsxs)("div",{className:"text-sm text-gray-600",children:["Distance: ~",v.distanceKm.toFixed(1)," km"]}),(0,r.jsx)("button",{onClick:S,disabled:y,className:"w-full bg-[#00796B] text-white py-3 rounded-xl font-semibold hover:bg-[#00796B]/90 transition-colors mt-4",children:y?"Booking...":"Book Ride"})]})]}),(0,r.jsx)("div",{className:"lg:sticky lg:top-6 self-start",children:(c||h)&&(0,r.jsx)(d,{pickup:c,dropoff:h,className:"w-[650px] h-[800px]"})})]})]}),E.length>0&&(0,r.jsxs)("div",{className:"bg-white rounded-2xl p-8 shadow-sm",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"My Bookings"}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)("div",{className:"space-y-3",children:E.map(e=>(0,r.jsxs)("div",{className:"border rounded p-4 cursor-pointer hover:shadow transition-shadow ".concat(C===e.id?"ring-2 ring-blue-400":""),onClick:()=>T(e.id),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-semibold text-sm",children:e.pickupAddress}),(0,r.jsxs)("div",{className:"text-xs text-gray-600",children:["â†’ ",e.dropoffAddress]})]}),(0,r.jsx)("span",{className:"px-2 py-1 rounded text-xs ".concat("COMPLETED"===e.status?"bg-green-100 text-green-700":"REQUESTED"===e.status?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"),children:e.status})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:e.createdAt&&new Date(e.createdAt).toLocaleString()}),e.pinCode&&"COMPLETED"!==e.status&&"CANCELED"!==e.status&&(0,r.jsxs)("div",{className:"mt-2 p-2 bg-blue-50 border border-blue-200 rounded",children:[(0,r.jsxs)("div",{className:"text-xs text-blue-600 font-semibold",children:["Your PIN: ",(0,r.jsx)("span",{className:"text-lg",children:e.pinCode})]}),(0,r.jsx)("div",{className:"text-xs text-blue-500 mt-1",children:"Give this to your driver"})]}),"COMPLETED"===e.status&&e.rideQuality&&(0,r.jsxs)("div",{className:"mt-2 p-3 bg-green-50 border border-green-200 rounded",children:[(0,r.jsx)("div",{className:"text-xs font-semibold text-green-800 mb-2",children:"Driver's Ride Report"}),(0,r.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Quality:"}),(0,r.jsx)("span",{className:"font-medium capitalize",children:e.rideQuality}),"excellent"===e.rideQuality&&"\uD83C\uDF1F","good"===e.rideQuality&&"\uD83D\uDC4D","fair"===e.rideQuality&&"\uD83D\uDC4C"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Comfort:"}),(0,r.jsx)("span",{className:"font-medium capitalize",children:e.clientComfort.replace("_"," ")}),"very_comfortable"===e.clientComfort&&"\uD83D\uDE0A","comfortable"===e.clientComfort&&"\uD83D\uDE42"]}),e.accessibilityNotes&&(0,r.jsxs)("div",{className:"mt-2 pt-2 border-t border-green-300",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Notes:"}),(0,r.jsx)("p",{className:"text-gray-700 mt-1",children:e.accessibilityNotes})]}),e.issuesReported&&(0,r.jsxs)("div",{className:"mt-2 pt-2 border-t border-green-300",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Issues:"}),(0,r.jsx)("p",{className:"text-gray-700 mt-1",children:e.issuesReported})]})]})]}),e.finalFareAmount&&(0,r.jsxs)("div",{className:"text-sm font-semibold mt-2",children:["\xa3",e.finalFareAmount.toFixed(2)]})]},e.id))}),(0,r.jsx)("div",{children:C?(()=>{let e=E.find(e=>e.id===C);return(null==e?void 0:e.status)==="COMPLETED"||(null==e?void 0:e.status)==="CANCELED"?(0,r.jsx)("div",{className:"text-sm text-gray-500 border rounded p-4 h-80 flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"font-semibold",children:"Chat Closed"}),(0,r.jsx)("p",{className:"mt-2",children:"This ride has been completed"})]})}):(0,r.jsx)(a.A,{bookingId:C,sender:"RIDER"},C)})():(0,r.jsx)("div",{className:"text-sm text-gray-500 border rounded p-4 h-80 flex items-center justify-center",children:"Select a booking to view chat"})})]})]}),w&&(0,r.jsxs)("div",{className:"border rounded-lg p-6 space-y-4",children:[(0,r.jsxs)("div",{className:"bg-green-50 border border-green-200 rounded p-4",children:[(0,r.jsx)("h3",{className:"font-semibold text-green-900",children:"Booking Confirmed! \uD83C\uDF89"}),(0,r.jsxs)("p",{className:"text-sm text-green-700 mt-1",children:["Your PIN: ",(0,r.jsx)("strong",{children:w.pinCode})]}),(0,r.jsx)("p",{className:"text-xs text-green-600 mt-2",children:"Give this PIN to your driver for pickup verification."})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:"From:"})," ",w.pickupAddress]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:"To:"})," ",w.dropoffAddress]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-sm font-medium",children:"Status:"})," ",(0,r.jsx)("span",{className:"capitalize",children:w.status})]})]}),(0,r.jsx)(a.A,{bookingId:w.id,sender:"RIDER"},w.id),(0,r.jsx)("button",{onClick:()=>{k(null),L([])},className:"w-full border py-2 rounded hover:bg-gray-50",children:"Book Another Ride"})]})]})}function h(){return(0,r.jsx)(x.A,{requiredRole:["RIDER"],children:(0,r.jsx)(u.A,{userRole:"RIDER",children:(0,r.jsx)(p,{})})})}}},e=>{e.O(0,[4896,2996,240,1162,5481,2757,8441,1255,7358],()=>e(e.s=371)),_N_E=e.O()}]);