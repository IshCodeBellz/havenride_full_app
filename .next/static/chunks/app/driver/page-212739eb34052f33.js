(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8229],{6236:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>m});var a=t(5155),i=t(2115),l=t(5419),n=t(1423),r=t(4424),o=t(3371),c=t(4524);function d(e){let{bookingId:s,onSubmit:t,onCancel:l}=e,[n,r]=(0,i.useState)({rideQuality:"good",clientComfort:"comfortable",accessibilityNotes:"",issuesReported:""}),[o,c]=(0,i.useState)(!1),d=async e=>{e.preventDefault(),c(!0);try{await t(n)}catch(e){console.error("Failed to submit documentation:",e),alert("Failed to submit documentation. Please try again.")}finally{c(!1)}};return(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"Document Ride Completion"}),(0,a.jsx)("p",{className:"text-gray-600 mb-6",children:"Please provide feedback about this ride to ensure quality service."}),(0,a.jsxs)("form",{onSubmit:d,className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-semibold mb-2",children:["Overall Ride Quality ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-3",children:[{value:"excellent",label:"Excellent",emoji:"\uD83C\uDF1F"},{value:"good",label:"Good",emoji:"\uD83D\uDC4D"},{value:"fair",label:"Fair",emoji:"\uD83D\uDC4C"},{value:"poor",label:"Poor",emoji:"\uD83D\uDC4E"}].map(e=>(0,a.jsxs)("label",{className:"flex items-center gap-2 p-3 border rounded-lg cursor-pointer transition-colors ".concat(n.rideQuality===e.value?"bg-blue-50 border-blue-500":"hover:bg-gray-50"),children:[(0,a.jsx)("input",{type:"radio",name:"rideQuality",value:e.value,checked:n.rideQuality===e.value,onChange:e=>r({...n,rideQuality:e.target.value}),className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-xl",children:e.emoji}),(0,a.jsx)("span",{className:"font-medium",children:e.label})]},e.value))})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-semibold mb-2",children:["Client Comfort Level ",(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-3",children:[{value:"very_comfortable",label:"Very Comfortable",emoji:"\uD83D\uDE0A"},{value:"comfortable",label:"Comfortable",emoji:"\uD83D\uDE42"},{value:"neutral",label:"Neutral",emoji:"\uD83D\uDE10"},{value:"uncomfortable",label:"Uncomfortable",emoji:"\uD83D\uDE1F"}].map(e=>(0,a.jsxs)("label",{className:"flex items-center gap-2 p-3 border rounded-lg cursor-pointer transition-colors ".concat(n.clientComfort===e.value?"bg-green-50 border-green-500":"hover:bg-gray-50"),children:[(0,a.jsx)("input",{type:"radio",name:"clientComfort",value:e.value,checked:n.clientComfort===e.value,onChange:e=>r({...n,clientComfort:e.target.value}),className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-xl",children:e.emoji}),(0,a.jsx)("span",{className:"font-medium",children:e.label})]},e.value))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-semibold mb-2",children:"Accessibility Notes"}),(0,a.jsx)("textarea",{value:n.accessibilityNotes,onChange:e=>r({...n,accessibilityNotes:e.target.value}),placeholder:"Any notes about wheelchair access, mobility assistance, or other accessibility considerations...",className:"w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500",rows:3})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-semibold mb-2",children:"Issues or Concerns"}),(0,a.jsx)("textarea",{value:n.issuesReported,onChange:e=>r({...n,issuesReported:e.target.value}),placeholder:"Report any issues, concerns, or incidents during the ride (leave empty if none)...",className:"w-full border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500",rows:3}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"This helps us maintain high quality service and address any problems."})]}),(0,a.jsxs)("div",{className:"flex gap-3 pt-4 border-t",children:[(0,a.jsx)("button",{type:"button",onClick:l,disabled:o,className:"flex-1 px-4 py-3 border rounded-lg font-semibold hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Cancel"}),(0,a.jsx)("button",{type:"submit",disabled:o,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50",children:o?"Submitting...":"Complete Ride"})]})]})]})})}function u(){let{user:e}=(0,l.Jd)(),[s,t]=(0,i.useState)(!1),[o,c]=(0,i.useState)([]),[u,m]=(0,i.useState)(null),[b,h]=(0,i.useState)(null),x=(0,i.useRef)(!1),p=(0,i.useRef)(!0),f=(0,i.useMemo)(()=>o.find(s=>s.driverId===(null==e?void 0:e.id)&&"COMPLETED"!==s.status),[o,null==e?void 0:e.id]);async function y(s){let a=await fetch("/api/drivers/set-online",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({driverId:null==e?void 0:e.id,online:s})});if(!a.ok)return void alert((await a.json()).error||"Unable to change status");t(s)}(0,i.useEffect)(()=>{(null==f?void 0:f.id)&&m(f.id)},[null==f?void 0:f.id]),(0,i.useEffect)(()=>{let t;return s&&(t=setInterval(async()=>{await fetch("/api/drivers/update-location",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({driverId:null==e?void 0:e.id,lat:51.5+Math.random()/100,lng:-.1+Math.random()/100})})},8e3)),()=>t&&clearInterval(t)},[s,null==e?void 0:e.id]);let v=(0,i.useCallback)(async()=>{if(!x.current){x.current=!0;try{let e=await fetch("/api/bookings"),s=await e.json();c(Array.isArray(s)?s:[])}catch(e){console.error("Failed to fetch bookings:",e)}finally{x.current=!1,p.current=!1}}},[]);async function g(s){await fetch("/api/bookings/".concat(s,"/status"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"ASSIGNED",driverId:null==e?void 0:e.id})}),v()}async function j(e){await fetch("/api/bookings/".concat(e,"/status"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"ARRIVED"})}),v()}async function N(e){let s=prompt("Enter pickup PIN provided by rider");if(s){if(!(await fetch("/api/bookings/".concat(e,"/verify-pin"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:s})})).ok)return void alert("Invalid PIN");v()}}async function C(e){let s=prompt("Final fare (\xa3)? Leave empty to keep estimate.");s&&!isNaN(Number(s))&&await fetch("/api/bookings/".concat(e,"/fare"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:Number(s),currency:"GBP"})}),h(e)}async function k(e){if(b)try{if(!(await fetch("/api/bookings/".concat(b,"/document"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw Error("Failed to document ride");h(null),await v()}catch(e){throw console.error("Failed to document ride:",e),e}}return(0,i.useEffect)(()=>{if(!(null==e?void 0:e.id))return;v();let s=null,t=!1,a=null;try{s=(0,n.c)("driver:".concat(e.id)),a=()=>v(),s&&!s.isMock&&"function"==typeof s.subscribe&&(s.subscribe(a),t=!0)}catch(e){console.warn("Ably subscription failed, using polling fallback")}let i=setInterval(v,15e3);return()=>{clearInterval(i);try{t&&s&&a&&"function"==typeof s.unsubscribe&&s.unsubscribe(a)}catch(e){console.warn("Cleanup error:",e)}}},[null==e?void 0:e.id,v]),(0,a.jsxs)("div",{className:"max-w-5xl mx-auto p-6 space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"Driver Console"}),(0,a.jsxs)("label",{className:"flex items-center gap-2",children:[(0,a.jsx)("input",{type:"checkbox",checked:s,onChange:e=>y(e.target.checked)}),(0,a.jsx)("span",{children:s?"Online":"Offline"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,a.jsx)("div",{className:"space-y-3",children:p.current?(0,a.jsx)("div",{className:"text-center text-gray-500 py-4",children:"Loading bookings..."}):0===o.length?(0,a.jsx)("div",{className:"text-center text-gray-500 py-4",children:"No bookings yet"}):o.map(e=>(0,a.jsxs)("div",{className:"border rounded p-3 ".concat(u===e.id?"ring-2 ring-blue-400":""),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"font-semibold",children:[e.pickupAddress," → ",e.dropoffAddress]}),(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:["Status: ",e.status," ",e.requiresWheelchair?"• ♿":""]}),"number"==typeof e.finalFareAmount&&(0,a.jsxs)("div",{className:"text-xs text-gray-700",children:["Final fare: \xa3",e.finalFareAmount.toFixed(2)]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[!e.driverId&&(0,a.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>g(e.id),children:"Take"}),"ARRIVED"!==e.status&&(0,a.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>j(e.id),children:"Arrived"}),"ARRIVED"===e.status&&(0,a.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>N(e.id),children:"Start (PIN)"}),"IN_PROGRESS"===e.status&&(0,a.jsx)("button",{className:"px-3 py-1 border rounded",onClick:()=>C(e.id),children:"Complete"})]})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Booking ID: ",(0,a.jsxs)("code",{children:[e.id.slice(0,8),"…"]})]}),(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("button",{className:"text-xs underline",onClick:()=>m(e.id),children:"Open Chat"})})]},e.id))}),(0,a.jsx)("div",{children:u?(()=>{let e=o.find(e=>e.id===u);return(null==e?void 0:e.status)==="COMPLETED"||(null==e?void 0:e.status)==="CANCELED"?(0,a.jsx)("div",{className:"text-sm text-gray-500 border rounded p-4 h-80 flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"font-semibold",children:"Chat Closed"}),(0,a.jsx)("p",{className:"mt-2",children:"This ride has been completed"})]})}):(0,a.jsx)(r.A,{bookingId:u,sender:"DRIVER"},u)})():(0,a.jsx)("div",{className:"text-sm text-gray-500 border rounded p-4",children:"Select a booking to open chat."})})]}),b&&(0,a.jsx)(d,{bookingId:b,onSubmit:k,onCancel:()=>h(null)})]})}function m(){return(0,a.jsx)(o.A,{requiredRole:["DRIVER"],children:(0,a.jsx)(c.A,{userRole:"DRIVER",children:(0,a.jsx)(u,{})})})}},9211:(e,s,t)=>{Promise.resolve().then(t.bind(t,6236))}},e=>{e.O(0,[2996,1162,5481,2757,8441,1255,7358],()=>e(e.s=9211)),_N_E=e.O()}]);