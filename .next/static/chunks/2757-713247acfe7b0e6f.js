"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2757],{1423:(e,r,t)=>{t.d(r,{c:()=>l});var s=t(576);let n=null,a=!1;function l(e){let r=function(){if(a)return null;if(n)return n;let e="xxx:yyy";if(!e)return console.warn("Ably key not configured - real-time features will be disabled"),a=!0,null;try{return(n=new s.Realtime(e)).connection.on("failed",e=>{console.error("Ably connection failed:",e.reason),a=!0}),n}catch(e){return console.error("Failed to initialize Ably:",e),a=!0,null}}();return r?r.channels.get(e):{subscribe:()=>{},unsubscribe:()=>{},isMock:!0}}},3371:(e,r,t)=>{t.d(r,{A:()=>o});var s=t(5155),n=t(2115),a=t(63),l=t(5419);function o(e){let{children:r,requiredRole:t}=e,{user:o,isLoaded:i}=(0,l.Jd)(),c=(0,a.useRouter)(),[d,u]=(0,n.useState)(!0),[h,x]=(0,n.useState)(!1);return((0,n.useEffect)(()=>{!async function(){if(i){if(!(null==o?void 0:o.id))return c.push("/");try{try{let e=await fetch("/api/users/ensure-role");if(!e.ok){let r=await e.text();console.error("Failed to ensure role:",r)}}catch(e){console.error("Error calling ensure-role:",e)}let e=await fetch("/api/users/me");if(!e.ok){console.error("Failed to fetch user data"),c.push("/");return}let r=(await e.json()).role;if(console.log("RoleGate: User role is",r,"Required:",t),!r){console.log("RoleGate: No role found, redirecting home"),c.push("/");return}if(t&&!t.includes(r)){console.log("RoleGate: User doesn't have required role, redirecting to their dashboard"),"RIDER"===r?c.push("/rider"):"DRIVER"===r?c.push("/driver"):"DISPATCHER"===r?c.push("/dispatcher"):"ADMIN"===r?c.push("/admin"):c.push("/");return}console.log("RoleGate: Access granted"),x(!0)}catch(e){console.error("Error checking role:",e)}finally{u(!1)}}}()},[o,i,c,t]),d)?(0,s.jsx)("div",{className:"max-w-4xl mx-auto p-6",children:(0,s.jsx)("div",{className:"text-center",children:"Loading..."})}):h?(0,s.jsx)(s.Fragment,{children:r}):null}},4424:(e,r,t)=>{t.d(r,{A:()=>l});var s=t(5155),n=t(2115),a=t(1423);function l(e){let{bookingId:r,sender:t}=e,[l,o]=(0,n.useState)([]),[i,c]=(0,n.useState)(""),[d,u]=(0,n.useState)(!0),[h,x]=(0,n.useState)(!1),f=(0,n.useRef)(null),g=(0,n.useRef)(null);(0,n.useEffect)(()=>{let e=!0;return(async()=>{try{let t=await fetch("/api/bookings/".concat(r,"/messages"));if(t.ok&&e){let e=await t.json();o(e)}}catch(e){console.error("Failed to load messages:",e)}finally{e&&u(!1)}})(),()=>{e=!1}},[r]),(0,n.useEffect)(()=>{let e=null,t=!1,s=e=>{"message"===e.name&&o(r=>{if(r.some(r=>r.id===e.data.id))return r;let t=r.findIndex(r=>r.id.startsWith("temp-")&&r.text===e.data.text&&r.sender===e.data.sender);if(-1!==t){let s=[...r];return s[t]=e.data,s}return[...r,e.data]})};try{(e=(0,a.c)("booking:".concat(r)))&&!e.isMock&&"function"==typeof e.subscribe&&(e.subscribe(s),t=!0,x(!0))}catch(e){console.warn("Ably subscription failed, falling back to polling"),x(!1)}return t||(g.current=setInterval(async()=>{try{let e=await fetch("/api/bookings/".concat(r,"/messages"));if(e.ok){let r=await e.json();o(r)}}catch(e){console.error("Polling error:",e)}},3e3)),()=>{try{g.current&&(clearInterval(g.current),g.current=null),t&&e&&"function"==typeof e.unsubscribe&&e.unsubscribe(s)}catch(e){console.warn("Cleanup error (ignoring):",e)}}},[r]),(0,n.useEffect)(()=>{var e;null==(e=f.current)||e.scrollIntoView({behavior:"smooth"})},[l.length]);let m=(0,n.useCallback)(async()=>{if(!i.trim())return;let e=i.trim();c("");let s={id:"temp-".concat(Date.now()),bookingId:r,sender:t,text:e,createdAt:new Date().toISOString()};o(e=>[...e,s]);try{let n=await fetch("/api/bookings/".concat(r,"/messages"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender:t,text:e})});if(n.ok){let e=await n.json();o(r=>r.map(r=>r.id===s.id?e:r))}else o(e=>e.filter(e=>e.id!==s.id)),c(e),console.error("Failed to send message")}catch(r){o(e=>e.filter(e=>e.id!==s.id)),c(e),console.error("Error sending message:",r)}},[i,r,t]),p=(0,n.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),m())},[m]);return(0,s.jsxs)("div",{className:"border rounded-lg flex flex-col h-80",children:[(0,s.jsxs)("div",{className:"p-2 border-b font-semibold bg-gray-50 flex items-center justify-between",children:[(0,s.jsx)("span",{children:"Chat"}),!h&&(0,s.jsx)("span",{className:"text-xs text-gray-500",children:"(polling mode)"})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-auto p-2 space-y-1 text-sm",children:[d?(0,s.jsx)("div",{className:"text-center text-gray-500 py-4",children:"Loading messages..."}):0===l.length?(0,s.jsx)("div",{className:"text-center text-gray-500 py-4",children:"No messages yet. Start the conversation!"}):l.map(e=>(0,s.jsxs)("div",{className:"RIDER"===e.sender?"text-blue-700":"DRIVER"===e.sender?"text-green-700":"text-gray-800",children:[(0,s.jsxs)("span",{className:"font-semibold mr-1",children:[e.sender,":"]}),e.text]},e.id)),(0,s.jsx)("div",{ref:f})]}),(0,s.jsxs)("div",{className:"p-2 flex gap-2 border-t bg-gray-50",children:[(0,s.jsx)("input",{value:i,onChange:e=>c(e.target.value),onKeyPress:p,className:"border rounded px-2 py-1 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Type a messageâ€¦",autoComplete:"off"}),(0,s.jsx)("button",{onClick:m,disabled:!i.trim(),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Send"})]})]})}},4524:(e,r,t)=>{t.d(r,{A:()=>h});var s=t(5155),n=t(2619),a=t.n(n),l=t(5239),o=t(63),i=t(5419);function c(e){let{userRole:r}=e,t=(0,o.usePathname)(),n="DRIVER"===r?"/driver":"DISPATCHER"===r?"/dispatcher":"ADMIN"===r?"/admin":"/rider";return(0,s.jsxs)("div",{className:"w-64 min-h-screen bg-[#0F3D3E] text-white flex flex-col",children:[(0,s.jsx)("div",{className:"p-6 flex justify-center",children:(0,s.jsx)("div",{className:"w-32 h-32 bg-white rounded-full flex items-center justify-center",children:(0,s.jsx)(l.default,{src:"/images/HavenRideIcon.png",alt:"HavenRide Logo",width:120,height:120,className:"object-contain"})})}),(0,s.jsxs)("nav",{className:"flex-1 px-4 space-y-2",children:[(0,s.jsxs)(a(),{href:n,className:"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ".concat(t===n?"bg-[#1a5557]":"hover:bg-[#1a5557] hover:bg-opacity-50"),children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})}),(0,s.jsx)("span",{children:"Home"})]}),(0,s.jsxs)(a(),{href:"".concat(n,"/past-rides"),className:"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ".concat(t==="".concat(n,"/past-rides")?"bg-[#1a5557]":"hover:bg-[#1a5557] hover:bg-opacity-50"),children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsx)("span",{children:"Past Rides"})]}),(0,s.jsxs)(a(),{href:"".concat(n,"/support"),className:"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ".concat(t==="".concat(n,"/support")?"bg-[#1a5557]":"hover:bg-[#1a5557] hover:bg-opacity-50"),children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsx)("span",{children:"Support"})]}),(0,s.jsxs)(a(),{href:"".concat(n,"/profile"),className:"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ".concat(t==="".concat(n,"/profile")?"bg-[#1a5557]":"hover:bg-[#1a5557] hover:bg-opacity-50"),children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),(0,s.jsx)("span",{children:"Profile"})]}),"DRIVER"===r&&(0,s.jsxs)(a(),{href:"/driver/earnings",className:"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ".concat("/driver/earnings"===t?"bg-[#1a5557]":"hover:bg-[#1a5557] hover:bg-opacity-50"),children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,s.jsx)("span",{children:"Earnings"})]})]}),(0,s.jsx)("div",{className:"p-4 border-t border-[#1a5557]",children:(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(i.uF,{afterSignOutUrl:"/"}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:"Account"}),(0,s.jsx)("p",{className:"text-xs text-gray-300",children:r||"User"})]})]})})]})}var d=t(2115);function u(e){let{onTrigger:r}=e,[t,n]=(0,d.useState)(!1);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{onClick:()=>{n(!0),r&&r()},className:"fixed bottom-6 right-6 w-16 h-16 bg-red-600 rounded-full shadow-lg hover:bg-red-700 transition-all hover:scale-110 z-50 flex items-center justify-center",title:"Emergency SOS",children:(0,s.jsx)("span",{className:"text-white font-bold text-lg",children:"SOS"})}),t&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-2xl p-8 max-w-md w-full",children:[(0,s.jsx)("div",{className:"flex justify-center mb-6",children:(0,s.jsx)("div",{className:"w-24 h-24 bg-red-600 rounded-full flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-white font-bold text-3xl",children:"SOS"})})}),(0,s.jsx)("h2",{className:"text-2xl font-bold text-center text-gray-900 mb-4",children:"Emergency in Progress"}),(0,s.jsx)("p",{className:"text-center text-gray-600 mb-6",children:"Your location and driver details will be shared with HavenRide Safety Desk"}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("button",{onClick:()=>{window.location.href="tel:999"},className:"w-full bg-red-600 text-white py-4 rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center gap-2",children:[(0,s.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"})}),"Call 999"]}),(0,s.jsx)("button",{onClick:()=>{alert("Contacting HavenRide Safety Desk...")},className:"w-full border-2 border-gray-300 text-gray-700 py-4 rounded-lg font-semibold hover:bg-gray-50 transition-colors",children:"Contact HavenRide Safety Desk"}),(0,s.jsx)("button",{onClick:()=>{n(!1)},className:"w-full border-2 border-gray-300 text-gray-700 py-4 rounded-lg font-semibold hover:bg-gray-50 transition-colors",children:"Cancel Alert"})]}),(0,s.jsx)("p",{className:"text-xs text-center text-gray-500 mt-6",children:"In case of immediate danger, contact local emergency services."})]})})]})}function h(e){let{children:r,userRole:t}=e;return(0,s.jsxs)("div",{className:"flex min-h-screen bg-gray-50",children:[(0,s.jsx)(c,{userRole:t}),(0,s.jsx)("main",{className:"flex-1 overflow-auto",children:r}),("RIDER"===t||"DRIVER"===t)&&(0,s.jsx)(u,{})]})}}}]);